!function(t){"use strict";var e=require("http"),n=require("https"),i={https:n,"https:":n},s=t.location||{},r=t.XP||require("expandjs"),o=t.XPEmitter||require("xp-emitter");module.exports=t.XPRequest=new r.Class("XPRequest",{extends:o,initialize:{promise:!0,value:function(t,n){var a=this,u=null;o.call(a),r.isObject(t)||(t={url:t}),r.isFalsy(t.url)||r.assign(t,r.pick(r.parseURL(t.url),["hostname","path","port","protocol"])),a.chunks=[],a.state="idle",a.options=t,a.contentType=a.options.contentType||null,a.encoding=a.options.encoding||null,a.headers=a.options.headers||{},a.hostname=a.options.hostname||s.hostname||null,a.keepAlive=a.options.keepAlive||0,a.method=a.options.method||"GET",a.path=a.options.path||null,a.port=a.options.port||!a.options.hostname&&r.toNumber(s.port)||null,a.protocol=a.options.protocol||!a.options.hostname&&s.protocol||"http:",a.responseType=a.options.responseType||null,a.url=r.toURL({protocol:a.protocol,hostname:a.hostname,port:a.port,pathname:a.pathname,search:a.search}),u=(i[a.protocol]||e).request({headers:a.headers,hostname:a.hostname,keepAlive:a.keepAlive>0,keepAliveMsecs:a.keepAlive,method:a.method,path:a.path,port:a.port,protocol:a.protocol,withCredentials:!1}),u.on("error",a._handleError.bind(a,n)),u.on("response",a._handleResponse.bind(a,n)),a.abort=a.abort.bind(a,u),a.header=a.header.bind(a,u),a.submit=a.submit.bind(a,u)}},abort:function(t){var e=this;return e.tsAbort?e:(t.abort(),e.state="aborted",e.tsAbort=Date.now(),e)},header:function(t,e,n){r.assertArgument(r.isString(e,!0),1,"string"),r.assertArgument(r.isVoid(n)||r.isFalse(n)||r.isInput(n,!0),2,"string");var i=this;return r.isDefined(n)&&"idle"===i.state?n?(t.setHeader(e,i.headers[e]=n),n):(t.removeHeader(e),void delete i.headers[e]):i.headers[e]},submit:{promise:!0,value:function(t,e,n){r.assertArgument(r.isVoid(n)||r.isFunction(n),2,"Function");var i=this;return i.tsSubmit?i:("GET"===i.method&&(e=void 0),"GET"!==i.method&&(e=r.isInput(e,!0)||r.isBuffer(e)?e:r.isCollection(e)?r.toJSON(e):void 0),i.catch(function(t){n(t,null)}),i.then(function(t){n(null,t)}),t.end(e),i.state="pending",i.tsSubmit=Date.now(),void i.emit("submit",e,i))}},chunks:{set:function(t){return this.chunks||t},validate:function(t){return!r.isArray(t)&&"Array"}},contentType:{set:function(t){return r.isDefined(this.contentType)?this.contentType:t},validate:function(t){return!r.isVoid(t)&&!r.isString(t,!0)&&"string"}},data:{set:function(t){return r.isDefined(this.data)?this.data:t}},encoding:{set:function(t){return r.isDefined(this.encoding)?this.encoding:t},validate:function(t){return!r.isVoid(t)&&!r.isString(t,!0)&&"string"}},error:{set:function(t){return r.isDefined(this.error)?this.error:t},validate:function(t){return!r.isVoid(t)&&!r.isString(t)&&"string"}},headers:{set:function(t){return this.headers||r.isObject(t)&&r.cloneDeep(t)},then:function(){this.contentType&&(this.headers["content-type"]=this.contentType)},validate:function(t){return!r.isObject(t)&&"Object"}},hostname:{set:function(t){return this.hostname||t},validate:function(t){return!r.isString(t,!0)&&"string"}},keepAlive:{set:function(t){return r.isDefined(this.keepAlive)?this.keepAlive:t},validate:function(t){return!r.isInt(t,!0)&&"number"}},method:{set:function(t){return this.method||r.upperCase(t)},validate:function(t){return!r.isString(t,!0)&&"string"}},path:{set:function(t){return r.isDefined(this.path)?this.path:t},then:function(t){var e=r.split(t,"?",!0);this.pathname=e[0]||null,this.search=e[1]?"?"+e[1]:null},validate:function(t){return!r.isVoid(t)&&!r.isString(t,!0)&&"string"}},pathname:{set:function(t){return r.isDefined(this.path)?this.path:t},validate:function(t){return!r.isVoid(t)&&!r.isString(t,!0)&&"string"}},port:{set:function(t){return r.isDefined(this.port)?this.port:t},validate:function(t){return!r.isVoid(t)&&!r.isInt(t,!0)&&"number"}},protocol:{set:function(t){return this.protocol||t},validate:function(t){return!r.isString(t,!0)&&"string"}},responseType:{set:function(t){return r.isDefined(this.responseType)?this.responseType:t},validate:function(t){return!r.isVoid(t)&&this.responseTypes.indexOf(t)<0&&"string"}},responseTypes:{frozen:!0,writable:!1,value:["json"]},search:{set:function(t){return r.isDefined(this.search)?this.search:t},validate:function(t){return!r.isVoid(t)&&!r.isString(t,!0)&&"string"}},state:{set:function(t){return t},then:function(t){this.emit("state",t,this)},validate:function(t){return this.states.indexOf(t)<0&&"string"}},states:{frozen:!0,writable:!1,value:["aborted","failed","idle","pending","received","receiving"]},statusCode:{set:function(t){return this.statusCode||t},validate:function(t){return!r.isInt(t,!0)&&"number"}},statusMessage:{set:function(t){return this.statusMessage||t},validate:function(t){return!r.isString(t)&&"string"}},tsAbort:{set:function(t){return this.tsAbort||t},validate:function(t){return!r.isInt(t,!0)&&"number"}},tsData:{set:function(t){return this.tsData||t},validate:function(t){return!r.isInt(t,!0)&&"number"}},tsResponse:{set:function(t){return this.tsResponse||t},validate:function(t){return!r.isInt(t,!0)&&"number"}},tsSubmit:{set:function(t){return this.tsSubmit||t},validate:function(t){return!r.isInt(t,!0)&&"number"}},url:{set:function(t){return this.url||t},validate:function(t){return!r.isString(t,!0)&&"string"}},_handleData:function(t){var e=this;e.chunks.push(t),e.emit("chunk",t,e)},_handleEnd:function(t){var e=this,n=e.statusCode>=400,i=n?null:r.join(e.chunks),s=n?r.join(e.chunks).toString()||e.statusMessage:null,o=n?"failed":"received",a=n?"error":e.responseType;"json"===a&&(i=r.parseJSON(i.toString())),e.data=i,e.error=s,e.state=o,e.tsData=Date.now(),t(e.error,e.data),e.emit(n?"error":"data",n?e.error:e.data,e)},_handleError:function(t,e){var n=this;n.error=e.message||"Unknown",n.state="failed",t(n.error,null),n.emit("error",n.error,n)},_handleResponse:function(t,n){var i=this;i.encoding&&n.setEncoding(i.encoding),i.state="receiving",i.statusCode=n.statusCode,i.statusMessage=n.statusMessage||e.STATUS_CODES[i.statusCode]||"Unknown",i.tsResponse=Date.now(),n.on("data",i._handleData.bind(i)),n.on("end",i._handleEnd.bind(i,t)),i.emit("response",i.url,i)}})}("undefined"!=typeof window?window:global);