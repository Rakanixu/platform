<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="kazoup-checksum-icon">
  <link rel="import" type="css" href="kazoup-checksum-icon.css">

  <template>

    <div class="container" class="layout vertical">

      <template is="dom-if" if="{{!_computeDuplicates(numberOfDuplicates)}}">
        <svg width="36px"
             height="36px"
             viewBox="0 0 37 46"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             xmlns:xlink="http://www.w3.org/1999/xlink">
          <title>file-icon</title>
          <description>Created for Kazoup</description>
          <defs></defs>
          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="file-icon">
              <path d="M3.00458071e-14,0 L0,46 L37,46 L37,11.5 L26.4285714,0 L3.00458071e-14,0 Z M3.00458071e-14,0"
                    id="Path-3"
                    stroke="#020000"
                    stroke-opacity="0.1"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    fill$="{{model.color}}"></path>
              <path d="M26.4285714,0 L26.4285714,11.4049587 L37,11.4049588"
                    stroke="#F9F9F9"
                    stroke-opacity="0.2"
                    fill-opacity="0.5"
                    fill="#D8D8D8"></path>
            </g>
          </g>
        </svg>
      </template>

      <template is="dom-if" if="{{_computeDuplicates(numberOfDuplicates)}}">
        <svg width="40px"
             height="40px"
             viewBox="0 0 37 46"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             xmlns:xlink="http://www.w3.org/1999/xlink"
             xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
          <title>file-icon</title>
          <desc>Created for Kazoup.</desc>
          <defs></defs>
          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
            <g id="file" sketch:type="MSLayerGroup">
              <g id="Group-2" transform="translate(3.083333, 0.000000)" sketch:type="MSShapeGroup">
                <g id="file-icon">
                  <path d="M2.75419898e-14,0 L0,41 L33.9166667,41 L33.9166667,10.25 L24.2261904,0 L2.75419898e-14,0 L2.75419898e-14,0 Z"
                        id="Path-3"
                        stroke-opacity="0.1"
                        fill-opacity="0.5"
                        stroke="#020000"
                        fill$="{{model.color}}"></path>
                  <path d="M24.2261904,0 L24.2261904,10.1652893 L33.9166667,10.1652894"
                        id="Shape"
                        stroke-opacity="0.8"
                        stroke="#F9F9F9"
                        fill-opacity="1"
                        fill="#D8D8D8"></path>
                </g>
              </g>
              <g id="Group" transform="translate(0.000000, 3.000000)" sketch:type="MSShapeGroup">
                <g id="file-icon">
                  <path d="M2.75419898e-14,0 L0,41 L33.9166667,41 L33.9166667,10.25 L24.2261904,0 L2.75419898e-14,0 L2.75419898e-14,0 Z"
                        id="Path-3"
                        stroke-opacity="0.1"
                        fill-opacity="1"
                        stroke="#020000"
                        fill$="{{model.color}}"></path>
                  <path d="M24.2261904,0 L24.2261904,10.1652893 L33.9166667,10.1652894"
                        id="Shape"
                        stroke-opacity="0.2"
                        stroke="#F9F9F9"
                        fill="#D8D8D8"></path>
                </g>
              </g>
            </g>
          </g>
        </svg>
      </template>

      <template is="dom-if" if="{{model._source.metadata.extension}}">
        <div class="details">
          <p>{{_showNumberOfDuplicates(numberOfDuplicates)}}</p>
          <p>{{_showExtension(model)}}</p>
        </div>
      </template>

    </div>

  </template>
  <script>
    (function () {
      Polymer({
        is: 'kazoup-checksum-icon',
        behaviors: [
          KazoupBehaviors.APIUrls
        ],
        properties: {
          model: {
            type: Object,
            notify: true,
            observer: 'modelChanged'
          },
          numberOfDuplicates: {
            type: Number,
            notify: true,
            value: 1
          }
        },
        modelChanged: function (newValue, oldValue) {
          var query = {};

          if (newValue && newValue._source && newValue._source.content && newValue._source.content.checksum) {
            query = {
              'query': {
                'constant_score': {
                  'filter': {
                    'bool': {
                      'must': [
                        {
                          'bool': {
                            'should': [
                              {
                                'term': {
                                  'exists_on_disk': true
                                }
                              },
                              {
                                'exists': {
                                  'field': 'archive_complete'
                                }
                              }
                            ]
                          }
                        },
                        {
                          'term': {
                            'checksum': newValue._source.content.checksum
                          }
                        }
                      ]
                    }
                  }
                }
              },
              'size': 0
            };

            qwest.post(
              this.endpointList.ESFiles,
              query,
              {
                dataType: 'json',
                cache: true,
                headers: {
                  Accept: 'application/json',
                  Authorization: 'JWT ' + localStorage.getItem('authToken')
                }
              }).then(function(xhr, response) {
                this.set('numberOfDuplicates', response.hits.total);
              }.bind(this)
            );
          }
        },
        crop: function(text, length) {
          if (text && text.length > length) {
            return '';
          } else {
            return text;
          }
        },
        _computeDuplicates: function(numberOfDuplicates) {
          return (numberOfDuplicates > 1) ? true : false;
        },
        _showNumberOfDuplicates: function(numberOfDuplicates) {
          return (numberOfDuplicates > 1) ? numberOfDuplicates : '';
        },
        _showExtension: function(model) {
          if (model._source && model._source.metadata) {
            return this.crop(model._source.metadata.extension, 6);
          }
        }
      });
    }());
  </script>
</dom-module>


