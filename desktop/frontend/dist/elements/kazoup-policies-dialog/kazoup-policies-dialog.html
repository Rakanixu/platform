<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../kazoup-text-to-html/kazoup-text-to-html.html">

<dom-module id="kazoup-policies-dialog">
  <link rel="import" type="css" href="kazoup-policies-dialog.css">

  <template>

    <paper-dialog id="policyDialog"
                  entry-animation="scale-up-animation"
                  exit-animation="scale-down-animation"
                  with-backdrop>
      <h2>Add archive policy</h2>

      <section>
        <p>
          <paper-input-container invalid="[[invalidPolicyName]]">
            <label>Policy name</label>
            <input is="iron-input"
                   bind-value="{{policyName}}"
                   autofocus>
            <paper-input-error>This field is required.</paper-input-error>
          </paper-input-container>
        </p>

        <kazoup-text-to-html class="policy-text"
                             text="[[humanTextPolicy]]"
                             replace-with=" "
                             unscape="false"></kazoup-text-to-html>

        <paper-checkbox id="isDeletionPolicy" role="checkbox">
          Delete files locally after archiving?
        </paper-checkbox>

        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="addPolicy">Add policy</paper-button>
      </section>
    </paper-dialog>

    <kazoup-ajax id="policyEndpoint"
                 url="[[endpointList.createPolicy]]"
                 is-authorize="true"
                 method="POST"
                 handleas="json"></kazoup-ajax>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'kazoup-policies-dialog',
        behaviors: [KazoupBehaviors.APIUrls],
        properties: {
          /**
           * Target to kazoup-filter-converter
           *
           * @attribute target
           * @type String
           * @default undefined
           */
          target: {
            type: String,
            notify: false
          },
          /**
           * Archive policy transformed to human readable text
           *
           * @attribute humanTextPolicy
           * @type String
           * @default empty string
           */
          humanTextPolicy: {
            type: String,
            notify: true,
            value: ''
          },
          /**
           * Checks if policyName is a empty string
           *
           * @attribute invalidPolicyName
           * @type Boolean
           * @default false
           */
          invalidPolicyName: {
            type: Boolean,
            notify: true,
            value: false
          },
          /**
           * Archive policy name
           *
           * @attribute policyName
           * @type String
           * @default empty string
           */
          policyName: {
            type: String,
            notify: true,
            value: '',
            observer: 'policyNameChanged'
          }
        },
        /**
         * @observer policyName
         */
        policyNameChanged: function() {
          if (this.policyName.length) {
            this.invalidPolicyName = false;
          } else {
            this.invalidPolicyName = true;
          }
        },
        /**
         * Generates human redeable text within the applied filters
         *
         * @method generateHumanText
         */
        generateHumanText: function(newVal, oldVal) {
          var humanText = this._filterConverter.asHumanText();

          if (humanText.length) {
            this.humanTextPolicy = 'Do you want to add an archive policy which match files ';
            for (var i = 0; i < humanText.length; i++) {
              this.humanTextPolicy += humanText[i];
              if (i < humanText.length - 1) {
                this.humanTextPolicy += ' and ';
              } else {
                this.humanTextPolicy += '?';
              }
            }
          } else {
            this.humanTextPolicy = 'No filters selected. Policy match all data. ' +
              'Do you want to create a policy which match all files?';
          }
        },
        /**
         * Opens dialog.
         *
         * @method open
         */
        open: function() {
          this.generateHumanText();
          this.$.policyDialog.open();
        },
        /**
         * Confirms and submit policy to backend
         *
         * @method addPolicy
         */
        addPolicy: function() {
          var params = {};

          if (this.policyName.length) {
            params = {
              name: this.policyName,
              is_archive_policy: true,
              is_deletion_policy: this.$.isDeletionPolicy.checked,
              filter: JSON.stringify(this._filterConverter.asElasticsearchFilters()),
              filter_raw: this._filterConverter.asQuerystring()
            };

            this.$.policyEndpoint.setParamsAsObj(params);
            this.$.policyEndpoint.generateRequest().then(this.handleResponse);
            this.$.policyDialog.close();
          } else {
            this.invalidPolicyName = true;
          }
        },
        /**
         * Success user feedback
         *
         * @method handleResponse
         */
        handleResponse: function() {
          Polymer.dom(document).querySelector('paper-toast').text = 'Archive policy created succesfully';
          Polymer.dom(document).querySelector('paper-toast').show();
        },
        attached: function() {
          Polymer.dom.flush();

          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
        }
      });
    }());
  </script>
</dom-module>
