<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">

<dom-module id="kazoup-search-sorting">
  <link rel="import" type="css" href="kazoup-search-sorting.css">

  <template>
    <div class="container">

      <paper-icon-button id="sortIcon"
                 icon="icons:sort"
                 class="cursor-pointer"
                 on-tap="openDropdown"></paper-icon-button>
      <paper-tooltip for="sortIcon"
                     animation-delay="100"
                     position="bottom">Show sorting options</paper-tooltip>

      <iron-dropdown id="dropdown"
                     open-animation-config="[[openDropdownAnimation]]"
                     close-animation-config="[[closeDropdownAnimation]]"
                     horizontal-align="right"
                     vertical-align="top">
        <div class="dropdown-content">
          <paper-item id="_score" data-value="_score" on-tap="setSorting">Relevance
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>
          <paper-item id="size" data-value="size" on-tap="setSorting">Size
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>
          <paper-item id="accessed" data-value="accessed" on-tap="setSorting">Accessed
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>
          <paper-item id="modified" data-value="modified" on-tap="setSorting">Modified
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>
        </div>
      </iron-dropdown>

    </div>
  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-search-sorting',
        behaviors: [KazoupBehaviors.CustomAnimations],
        properties: {
          selected: {
            type: String,
            notify: false,
            value: '_score'
          },
          target: {
            type: String,
            notify: false
          }
        },
        setSorting: function(e) {
          this.selected = e.target.dataset.value;
          this._filterConverter.setValue('sort', this.selected);
          this.$.dropdown.close();
        },
        openDropdown: function() {
          this.updateUI();
          this.$.dropdown.open();
        },
        updateUI: function() {
          _.forEach(Polymer.dom(this.root).querySelectorAll('paper-item'), function(el) {
            if (this.selected === el.id) {
              el.classList.add('active');
            } else {
              el.classList.remove('active');
            }
          }, this);
        },
        attached: function() {
          Polymer.dom.flush();

          // Selects its filter converter, if not,
          // the one from kazoup-analytics can be selected erroneously
          // trigerring observer in the wrong place,
          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
          this.selected = this._filterConverter.getValue('sort');
          this.updateUI();
        }
      });
    }());
  </script>
</dom-module>
