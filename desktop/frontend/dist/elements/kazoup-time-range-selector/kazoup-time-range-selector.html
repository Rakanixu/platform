<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../kazoup-moment-duration-import/kazoup-moment-duration-import.html">

<dom-module id="kazoup-time-range-selector">
  <link rel="import" type="css" href="kazoup-time-range-selector.css">

  <template>
    <paper-dialog id="dialog"
                  class$="[[mobileDevice]]"
                  entry-animation="scale-up-animation"
                  exit-animation="scale-down-animation"
                  with-backdrop>

      <paper-tabs class="middle horizontal layout" selected="{{selectedTab}}">
        <paper-tab class="flex">RELATIVE</paper-tab>
        <paper-tab class="flex">ABSOLUTE</paper-tab>
      </paper-tabs>

      <neon-animated-pages id="neonPages"
                           entry-animation="fade-in-animation"
                           exit-animation="fade-out-animation"
                           selected="[[selectedTab]]">
        <neon-animatable>
          <div class="relative">
            <p>
              <span>From:</span>

              <paper-input-container invalid="[[invalidfromRelative]]">
                <input is="iron-input"
                       bind-value="{{fromRelative}}"
                       on-input="validate"
                       data-type="Relative"
                       data-scope="from"
                       type="number"
                       min="0"
                       autofocus>
                <paper-input-error>Integer required.</paper-input-error>
              </paper-input-container>

              <paper-dropdown-menu>
                <paper-menu id="menu"
                            class="dropdown-content"
                            selected="{{rangeGranularitySelected}}">
                  <template is="dom-repeat" items="[[rangeGranularity]]" as="choice">
                    <paper-item>[[choice.label]]</paper-item>
                  </template>
                </paper-menu>
              </paper-dropdown-menu>
            </p>
            <p>
              <span>To:</span>

              <paper-input-container invalid="[[invalidtoRelative]]">
                <input is="iron-input"
                       bind-value="{{toRelative}}"
                       on-input="validate"
                       data-type="Relative"
                       data-scope="to"
                       type="number"
                       min="0">
                <paper-input-error>Integer required.</paper-input-error>
              </paper-input-container>

              <paper-dropdown-menu>
                <paper-menu id="menu"
                            class="dropdown-content"
                            selected="{{rangeGranularitySelected}}">
                  <template is="dom-repeat" items="[[rangeGranularity]]" as="choice">
                    <paper-item>[[choice.label]]</paper-item>
                  </template>
                </paper-menu>
              </paper-dropdown-menu>
            </p>
          </div>
        </neon-animatable>

        <neon-animatable>
          <div class="absolute">
            <p>
              <span>From:</span>

              <paper-input-container class="day" invalid="[[invalidfromAbsolute]]">
                <input is="iron-input"
                       bind-value="{{fromAbsolute.day}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="from"
                       type="number"
                       min="1">
              </paper-input-container>

              <paper-input-container class="month" invalid="[[invalidfromAbsolute]]">
                <input is="iron-input"
                       bind-value="{{fromAbsolute.month}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="from"
                       type="number"
                       min="1">
              </paper-input-container>

              <paper-input-container class="year" invalid="[[invalidfromAbsolute]]">
                <input is="iron-input"
                       bind-value="{{fromAbsolute.year}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="from"
                       type="number"
                       min="1">
              </paper-input-container>
            </p>
            <p>
              <span>To:</span>

              <paper-input-container class="day" invalid="[[invalidtoAbsolute]]">
                <input is="iron-input"
                       bind-value="{{toAbsolute.day}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="to"
                       type="number"
                       min="1">
              </paper-input-container>

              <paper-input-container class="month" invalid="[[invalidtoAbsolute]]">
                <input is="iron-input"
                       bind-value="{{toAbsolute.month}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="to"
                       type="number"
                       min="1">
              </paper-input-container>

              <paper-input-container class="year" invalid="[[invalidtoAbsolute]]">
                <input is="iron-input"
                       bind-value="{{toAbsolute.year}}"
                       on-input="validate"
                       data-type="Absolute"
                       data-scope="to"
                       type="number"
                       min="1">
              </paper-input-container>
            </p>
          </div>
        </neon-animatable>
      </neon-animated-pages>

      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-tap="submitDateRange">Submit</paper-button>
    </paper-dialog>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-time-range-selector',
        behaviors: [
          KazoupBehaviors.Util,
          KazoupBehaviors.Devices
        ],
        properties: {
          target: {
            type: String,
            notify: false
          },
          dateRangeData: {
            type: Array,
            notify: true,
            observer: 'dateRangeDataChanged'
          },
          period: {
            type: String,
            notify: true
          },
          fromRelative: {
            type: Number,
            notify: false
          },
          toRelative: {
            type: Number,
            notify: false
          },
          invalidfromRelative: {
            type: Boolean,
            notify: false,
            value: false
          },
          invalidtoRelative: {
            type: Boolean,
            notify: false,
            value: false
          },
          fromAbsolute: {
            type: Object,
            notify: false,
            value: function() {
              return {};
            }
          },
          toAbsolute: {
            type: Object,
            notify: false,
            value: function() {
              return {};
            }
          },
          invalidfromAbsolute: {
            type: Boolean,
            notify: false,
            value: false
          },
          invalidtoAbsolute: {
            type: Boolean,
            notify: false,
            value: false
          },
          selectedTab: {
            type: Number,
            notify: false,
            value: 0
          },
          mobileDevice: {
            type: String,
            notify: false
          },
          rangeGranularity: {
            type: Array,
            notify: false,
            value: function() {
              return [
                {val: 'year', label: 'years ago'},
                {val: 'month', label: 'months ago'},
                {val: 'day', label: 'days ago'}
              ];
            }
          },
          rangeGranularitySelected: {
            type: String,
            notify: false,
            value: 0
          }
        },
        dateRangeDataChanged: function(newVal, oldVal) {
          var from = this._filterConverter.getValue('from');
          var to = this._filterConverter.getValue('to');
          var today = new Date(new Date().setHours(0, 0, 0, 0));
          var customYear = today.getFullYear();
          var firstYear = new Date(this.dateRangeData[0]).getFullYear();

          // Absolute
          if (typeof from === 'number' && typeof to === 'number') {
            this.set('selectedTab', 1);
            setRelative.call(this); // We must set default values to the option is not currently selected

            this.set('fromAbsolute.day', new Date(from).getDate());
            this.set('fromAbsolute.month', new Date(from).getMonth() + 1);
            this.set('fromAbsolute.year', new Date(from).getUTCFullYear());
            this.set('toAbsolute.day', new Date(to).getDate());
            this.set('toAbsolute.month', new Date(to).getMonth() + 1);
            this.set('toAbsolute.year', new Date(to).getUTCFullYear());
          // Relative
          } else if (typeof from === 'string' && typeof to === 'string') {
            this.set('selectedTab', 0);
            setAbsolute.call(this); // We must set default values to the option is not currently selected

            if (from.indexOf('d/d') !== -1) {
              this.set('rangeGranularitySelected', 2);
            } else if (from.indexOf('M/d') !== -1) {
              this.set('rangeGranularitySelected', 1);
            } else if (from.indexOf('y/d') !== -1) {
              this.set('rangeGranularitySelected', 0);
            }

            this.set('fromRelative', parseInt(from.replace('now-', '')));
            this.set('toRelative', parseInt(to.replace('now-', '')));
          } else if (!from && !to && newVal) {
            setAbsolute.call(this);
            setRelative.call(this);
          }

          function setRelative() {
            this.set('fromRelative', customYear - firstYear);
            this.set('toRelative', 0);
          }

          function setAbsolute() {
            this.set('fromAbsolute.day', 1);
            this.set('fromAbsolute.month', 1);
            this.set('fromAbsolute.year', firstYear);
            this.set('toAbsolute.day', today.getDate());
            this.set('toAbsolute.month', today.getMonth() + 1);
            this.set('toAbsolute.year', customYear);
          }
        },
        open: function() {
          this.$.dialog.open();
        },
        validate: function(e, detail) {
          var validateDecimalDigits = new RegExp(/^[0-9]+$/g);
          var isInvalid, date;

          if (e.currentTarget.dataset.type === 'Relative') {
            // Relative validation
            isInvalid = !this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type]
              .match(validateDecimalDigits);
          } else if (e.currentTarget.dataset.type === 'Absolute') {
            // Absolute validation; Negative number are parse as |Abs|, so moment.js validate
            // We do not want to allow this behaviour
            date = moment(
              this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].year + ' ' +
              this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].month + ' ' +
              this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].day,
              'YYYYY MM DD'
            );
            isInvalid = !date.isValid();

            if (parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].year) < 0 ||
                parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].month) < 0 ||
                parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].day) < 0 ||
                isNaN(parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].year)) ||
                isNaN(parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].month)) ||
                isNaN(parseInt(this[e.currentTarget.dataset.scope + e.currentTarget.dataset.type].day))) {
              isInvalid = true;
            }

            if (!isInvalid) {
              this.set(
                e.currentTarget.dataset.scope + e.currentTarget.dataset.type + '.unixTimestamp',
                date.valueOf() // unix timestamp in ms, exactly as new Date().getTime()
              );
            }
          }

          this.set(
            'invalid' + e.currentTarget.dataset.scope + e.currentTarget.dataset.type,
            isInvalid
          );
        },
        submitDateRange: function() {
          var fromValue =  null,
            toValue = null,
            e = null;

          if (this.selectedTab === 0) {
            if (!this.invalidfromRelative && !this.invalidtoRelative) {
              switch (this.rangeGranularitySelected) {
                case 0: // year
                  fromValue = 'now-' + this.fromRelative + 'y/d';
                  toValue = 'now-' + this.toRelative + 'y/d';
                  break;
                case 1: // month
                  fromValue = 'now-' + this.fromRelative + 'M/d';
                  toValue = 'now-' + this.toRelative + 'M/d';
                  break;
                case 2: // day
                  fromValue = 'now-' + this.fromRelative + 'd/d';
                  toValue = 'now-' + this.toRelative + 'd/d';
                  break;
              }

              this.setPeriod('Relative', this.rangeGranularitySelected);
            }
          } else if (this.selectedTab === 1) {
            if (!this.invalidfromAbsolute && !this.invalidtoAbsolute) {
              // Validation sets unixTimestamp for Absolute dates,
              // when user selects absolute tab and submit default values,
              // unixTimestamps are undefined. We force a post validation to ensure value is set
              e = {
                currentTarget: {
                  dataset: {
                    scope: '',
                    type: 'Absolute'
                  }
                }
              };

              e.currentTarget.dataset.scope = 'from';
              this.validate(e);
              e.currentTarget.dataset.scope = 'to';
              this.validate(e);

              fromValue = this.fromAbsolute.unixTimestamp;
              toValue = this.toAbsolute.unixTimestamp;

              this.setPeriod('Absolute');
            }
          }

          if (fromValue && toValue) {
            this._filterConverter.setValues([
              {field: 'from', val: fromValue},
              {field: 'to', val: toValue}
            ]);

            this.$.dialog.close();
          }
        },
        setPeriod: function(type, granularity) {
          var range = 0,
            value,
            fromRelative = this.fromRelative,
            toRelative = this.toRelative;

          if (type === 'Relative') {
            // range in days
            if (granularity === 0) {
              range = (fromRelative - toRelative) * 365;
            }

            if (granularity === 1) {
              range = (fromRelative - toRelative) * 30;
            }

            if (granularity === 2) {
              range = (fromRelative - toRelative);
            }

            if (range > 365) {
              value = 'year';
            } else if (range > 30) {
              value = 'month';
            } else {
              value = 'day';
            }
          } else if (type === 'Absolute') {
            if (this.toAbsolute.unixTimestamp - this.fromAbsolute.unixTimestamp > (1000 * 60 * 60 * 24 * 365)) {
              value = 'year';
            } else if (this.toAbsolute.unixTimestamp - this.fromAbsolute.unixTimestamp > (1000 * 60 * 60 * 24 * 31)) {
              value = 'month';
            } else {
              value = 'day';
            }
          }

          this.set('period', value);
        },
        attached: function() {
          Polymer.dom.flush();

          this.set('mobileDevice', this.isMobileDevice().any() ? 'mobile-device' : '');

          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
        }
      });
    }());
  </script>

</dom-module>
