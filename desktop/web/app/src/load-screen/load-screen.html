<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../src/behaviors/async-behavior.html">

<dom-module id="load-screen">
  <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment"></style>
  <template>
    <style>
      :host {
        display: block;
      }

      iron-image {

      }

      .container {
        @apply(--layout-fullbleed);
      }

      .inner-container {
        margin: auto;
        width: 120px;
      }

      .inner-container paper-progress,
      .inner-container iron-image {
        width: 120px;
      }

      .inner-container p.info {
        position: absolute;
        left: 0;
        right: 0;
        padding: 0 10%;
        text-align: center;
      }
    </style>

    <section>
      <div class="container vertical layout">
        <div class="flex vertical layout">
          <div class="inner-container">
            <iron-image src="http://localhost:8082/desktop/src/static/kazoup-logo.png"></iron-image>
            <paper-progress indeterminate></paper-progress>
            <p class="info">[[info]]</p>
          </div>
        </div>
      </div>
    </section>

    <iron-ajax id="rpcElasticStatus"
               method="POST"
               content-type="application/json"
               url="http://localhost:8082/rpc"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleElasticStatus"
               params="{{rpcElasticStatusParams}}"></iron-ajax>

    <iron-ajax id="rpcElasticSettings"
               method="POST"
               content-type="application/json"
               url="http://localhost:8082/rpc"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleElasticSettings"
               params="{{rpcElasticSettingsParams}}"></iron-ajax>

    <iron-ajax id="rpcElasticMapping"
               method="POST"
               content-type="application/json"
               url="http://localhost:8082/rpc"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleElasticMapping"
               params="{{rpcElasticMappingParams}}"></iron-ajax>

  </template>

  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'load-screen',
        behaviors: [
          Polymer.AsyncBehaviorImp
        ],
        properties: {
          wait: {
            type: Number,
            notify: false,
            value: 1200
          },
          info: {
            type: String,
            notify: false,
            value: "Starting search engine .."
          },
          rpcElasticStatusParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: "go.micro.srv.desktop",
                method: "Elastic.Status",
              };
            }
          },
          rpcElasticSettingsParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: "go.micro.srv.desktop",
                method: "Config.SetElasticSettings",
              };
            }
          },
          rpcElasticMappingParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: "go.micro.srv.desktop",
                method: "Config.SetElasticMapping",
              };
            }
          }
        },
        ready: function() {
          this.$.rpcElasticStatus.body = this.rpcElasticStatusParams;
          this.$.rpcElasticSettings.body = this.rpcElasticSettingsParams;
          this.$.rpcElasticMapping.body = this.rpcElasticMappingParams;

          this.$.rpcElasticStatus.generateRequest();
        },
        _handleElasticStatus: function(e) {
          var status;

          if (e.detail.response && e.detail.response.status) {
            status = JSON.parse(e.detail.response.status);

            // Check if ES is running
            if (status.master_node.length) {
              // ES not configured, set settings and mapping
              if (_.isEmpty(status.metadata.indices)) {
                this.set('info', "Initializing search engine config ..");
                this.$.rpcElasticSettings.generateRequest();
              } else {
                this._loadPage(1, 'web-app-activated');
              }
            } else {
              this.async(function() {
                this.$.rpcElasticStatus.generateRequest();
              }, this.wait);
            }
          }
        },
        _handleElasticSettings: function(e) {
          if (e.detail.response) {
            this.async(function() {
              this.set('info', "Applying search engine mapping ..");
              this.$.rpcElasticMapping.generateRequest();
            }, this.wait);
          }
        },
        _handleElasticMapping: function(e) {
          if (e.detail.response) {
            this.async(function() {
              this._loadPage(1, 'web-app-activated');
            }, this.wait);
          }
        },
        _handleError: function(e) {

        },
        _loadPage: function(selected, eventName, obj) {
          document.querySelector('#ironPages').selected = selected;
          this.fireEvent(eventName);
        }
      });
    }());
  </script>
</dom-module>
