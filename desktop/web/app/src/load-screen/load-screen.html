<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../src/behaviors/async-behavior.html">
<link rel="import" href="../../src/behaviors/endpoints-behavior.html">

<dom-module id="load-screen">
  <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment"></style>
  <template>
    <style>
      :host {
        display: block;
      }

      .container {
        @apply(--layout-fullbleed);
      }

      .inner-container {
        margin: auto;
        width: 120px;
      }

      .inner-container paper-progress,
      .inner-container iron-image {
        width: 120px;
      }

      .inner-container p.info {
        position: absolute;
        left: 0;
        right: 0;
        padding: 0 10%;
        text-align: center;
      }
    </style>

    <section>
      <div class="container vertical layout">
        <div class="flex vertical layout">
          <div class="inner-container">
            <iron-image src="../../src/static/kazoup-logo.png"></iron-image>
            <paper-progress indeterminate></paper-progress>
            <p class="info">[[info]]</p>
          </div>
        </div>
      </div>
    </section>

    <iron-ajax id="rpcDbStatus"
               method="POST"
               content-type="application/json"
               url="[[endpoints.endpoint]]"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleDbStatus"
               params="{{rpcDbStatusParams}}"
               headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcDbDatasourcesIndex"
               method="POST"
               content-type="application/json"
               url="[[endpoints.endpoint]]"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleDbDatasourcesIndex"
               params="{{rpcDbDatasorucesIndexParams}}"
               headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSanitizeDatasources"
               method="POST"
               content-type="application/json"
               url="[[endpoints.endpoint]]"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleSanitizeDatasources"
               params="{{rpcSanitizeDatasourcesParams}}"
               headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSetFlags"
               method="POST"
               content-type="application/json"
               url="[[endpoints.endpoint]]"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleSetFlags"
               params="{{rpcSetFlagsParams}}"
               headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSearch"
               method="POST"
               content-type="application/json"
               url="[[endpoints.endpoint]]"
               handle-as="json"
               on-error="_handleError"
               on-response="_handleSearch"
               params="{{rpcSearchParams}}"
               headers="[[headers]]"></iron-ajax>

  </template>

  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'load-screen',
        behaviors: [
          Polymer.AsyncBehaviorImp,
          Polymer.EndpointsBehaviorImp
        ],
        properties: {
          wait: {
            type: Number,
            notify: false,
            value: 1200
          },
          info: {
            type: String,
            notify: false,
            value: 'Starting search engine ..'
          },
          rpcDbStatusParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: 'com.kazoup.srv.db',
                method: 'DB.Status',
              };
            }
          },
          rpcDbDatasourcesIndexParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: 'com.kazoup.srv.db',
                method: 'DB.CreateIndexWithSettings',
                request: {
                  index: 'datasources',
                  type: 'datasource'
                }
              };
            }
          },
          rpcSanitizeDatasourcesParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: 'com.kazoup.srv.db',
                method: 'DB.Update',
                request: {
                  index: 'datasources',
                  type: 'datasource',
                  id: '',
                  data:''
                }
              };
            }
          },
          rpcSetFlagsParams : {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: 'com.kazoup.srv.config',
                method: 'Config.SetFlags',
                request: {
                  type: 'desktop'
                }
              };
            }
          },
          rpcSearchParams: {
            type: Object,
            notify: false,
            value: function() {
              return {
                service: 'com.kazoup.srv.datasource',
                method: 'DataSource.Search',
                request: {
                  from: 0,
                  size: 999
                }
              };
            }
          }
        },
        ready: function() {
          this.$.rpcDbStatus.body = this.rpcDbStatusParams;
          this.$.rpcDbDatasourcesIndex.body = this.rpcDbDatasourcesIndexParams;
          this.$.rpcSetFlags.body = this.rpcSetFlagsParams;
          this.$.rpcSearch.body = this.rpcSearchParams;

          this.$.rpcDbStatus.generateRequest();
        },
        _handleDbStatus: function(e) {
          var status;

          if (e.detail.response && e.detail.response.status) {
            status = JSON.parse(e.detail.response.status);

            // Check if ES is running
            if (status.master_node.length) {
              this.set('info', 'Initializing search engine config ..');

              // Create all needed indexes
              if (_.isEmpty(status.metadata.indices.datasources)) {
                this.$.rpcDbDatasourcesIndex.generateRequest();
              }

              if (_.isEmpty(status.metadata.indices.flags)) {
                this.$.rpcSetFlags.generateRequest();
              }

              this.async(function() {
                this.$.rpcSearch.generateRequest();
              }, this.wait);
            } else {
              this.async(function() {
                this.$.rpcDbStatus.generateRequest();
              }, this.wait);
            }
          }
        },
        _handleDbDatasourcesIndex: function(e) {

        },
        _handleSetFlags: function(e) {

        },
        _handleSanitizeDatasources: function(e) {

        },
        _handleSearch: function(e) {
          var datasources, info, firstScan;

          if (e.detail.response) {
            info = JSON.parse(e.detail.response.info);
            datasources = JSON.parse(e.detail.response.result);

            if (info.total) {
              firstScan = false;

              _.forEach(datasources, function(ds) {
                if (ds.crawler_running) {
                  ds.crawler_running = false;
                  this.rpcSanitizeDatasourcesParams.request.id = ds.id;
                  this.rpcSanitizeDatasourcesParams.request.data = JSON.stringify(ds);
                  this.$.rpcSanitizeDatasources.body = this.rpcSanitizeDatasourcesParams;

                  this.$.rpcSanitizeDatasources.generateRequest();
                }
              }.bind(this));
            } else {
              firstScan = true;
            }

            this._loadPage(1, 'web-app-activated', {
              first_scan: firstScan
            });
          }
        },
        _handleError: function(e) {

        },
        _loadPage: function(selected, eventName, obj) {
          document.querySelector('#ironPages').selected = selected;
          this.fireEvent(eventName, obj);
        }
      });
    }());
  </script>
</dom-module>
