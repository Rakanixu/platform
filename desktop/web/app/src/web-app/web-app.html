<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/mat-list/mat-list.html">
<link rel="import" href="../../bower_components/mat-text-field/mat-text-field.html">
<link rel="import" href="../../bower_components/mat-icon/mat-icon.html">
<link rel="import" href="../../bower_components/mat-icons/mat-icons.html">
<link rel="import" href="../../bower_components/mat-avatar/mat-avatar.html">
<link rel="import" href="../../bower_components/mat-button/mat-button.html">
<link rel="import" href="../../bower_components/mat-icon-button/mat-icon-button.html">
<link rel="import" href="../../bower_components/mat-item/mat-item.html">
<link rel="import" href="../../bower_components/mat-breadcrumb/mat-breadcrumb.html">
<link rel="import" href="../../bower_components/web-socket/web-socket.html">
<link rel="import" href="../../bower_components/mat-toast/mat-toast.html">
<link rel="import" href="../../bower_components/mat-typography/mat-typography.html">
<link rel="import" href="../../bower_components/mat-snackbar/mat-snackbar.html">

<dom-module id="web-app">
    <template>
        <style>
            :host {
                display: block;
            }
mat-list {
    max-width: 240px;
    height: 240px;
}
            paper-toolbar {
                --paper-toolbar-background: var(--primary-color);
            }

            paper-progress {
                height: 5px;
                --paper-progress-active-color: #fff;
                --paper-progress-secondary-color: var(--primary-color-dark);
                --paper-progress-container-color: var(--primary-color);
            }

            .nav {
                border-right: 1px solid #ccc;
            }

            .listContainer {
                height: 100%;
                overflow: auto;
            }

            .list-panel {
                background-color: #fafafa;
            }

            .list-panel {
                --paper-header-panel-standard-container: {
                    border-right: 1px solid #ccc;
                };
            }

            paper-toolbar {
                background-color: #42A5F5;
                background-color: var(--primary-color-dark);
            }

            .list {
                padding: 0;
            }

            .list paper-item {
                height: 80px;
                border-bottom: 1px solid #dedede;
                background-color: #fafafa;
            }

            .main-drawer-panel:not([narrow]) [list-toggle] {
                display: none;
            }

            .content {
                height: 3000px;
            }
        </style>

        <paper-drawer-panel id="navDrawerPanel" responsive-width="1280px">
            <!-- Nav Content -->
            <div class="nav" drawer>

            </div>

            <paper-drawer-panel id="mainDrawerPanel"
                                class="main-drawer-panel"
                                responsive-width="600px"
                                drawer-width="[[_computeListWidth(_isMobile)]]"
                                drawer-toggle-attribute="list-toggle"
                                narrow="{{_isMobile}}"
                                main>
                <paper-header-panel id="mainPaperHeaderPanel" class="list-panel" drawer>

                    <!-- List Toolbar -->
                    <paper-toolbar class="medium-tall">
                        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>

                        <div class="flex" hidden$="[[searching]]">Kazoup Search</div>
                        <mat-icon-button icon="mat:search" color="white" on-tap="toggleSearch" hidden$="[[searching]]"></mat-icon-button>

                        <mat-icon-button id="back" icon="mat:arrow-back" color="white" hidden$="[[!searching]]" on-tap="toggleSearch"></mat-icon-button>
                        <mat-text-field id="search" label="Search files"  on-keyup="searchAsYouType" hidden$="[[!searching]]"></mat-text-field>
                        <mat-icon-button id="reset" icon="mat:clear" on-xp-activate="resetSearch" color="white" hidden$="[[!searching]]"></mat-icon-button>

                        <mat-breadcrumb class="extended bottom title" shift>
                            <mat-breadcrumb-step label="My files"></mat-breadcrumb-step>
                            <mat-breadcrumb-step label="Photos"></mat-breadcrumb-step>
                            <mat-breadcrumb-step label="Beach"></mat-breadcrumb-step>
                        </mat-breadcrumb>
                        <paper-progress id="progressBar"
                                        class="middle fit"
                                        hidden$="[[!loading]]"
                                        indeterminate></paper-progress>
                    </paper-toolbar>

                    <!-- Search results -->
                    <div id="listContainer" class="listContainer" on-scroll="_handleScroll">
                        <iron-list id="searchList" items="[[searchResults]]" scroll-target="listContainer" grid="true">
                            <template>
                                <mat-list>
                                    <mat-item label="[[item._source.name]]"
                                              description="[[item._source.url]]">
                                        <mat-avatar class="primary" icon="[[isDir(item._source.is_dir)]]"></mat-avatar>
                                        <span>[[timestampToHumanTime(item._source.modified)]], [[bytesToSize(item._source.size)]]</span>
                                    </mat-item>
                                </mat-list>
                            </template>
                        </iron-list>
                    </div>

                </paper-header-panel>

                <paper-header-panel class="content-panel" main>
                    <!-- Main Toolbar -->
                    <paper-toolbar>
                        <paper-icon-button icon="arrow-back" list-toggle></paper-icon-button>
                    </paper-toolbar>

                    <!-- Main Content -->
                    <div class="content"></div>
                </paper-header-panel>

            </paper-drawer-panel>
        </paper-drawer-panel>

        <mat-snackbar id="snackbar"
                      button="Scan"
                      timeout="100000"
                      action-color="yellow"
                      label=""
                      on-xp-activate="startScan"></mat-snackbar>

        <web-socket url="ws://localhost:8082/desktop/status"
                    auto
                    json
                    on-open="_onOpen"
                    on-close="_onClose"
                    on-message="_onMessage"
                    on-error="_onError"></web-socket>

        <iron-ajax id="rpcStartScan"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleStartScan"
                   params="{{rpcStartScanParams}}"></iron-ajax>

        <iron-ajax id="rpcElastic"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleElastic"
                   params="{{rpcElasticParams}}"></iron-ajax>

    </template>

    <script>
        'use strict';

        (function() {
            var monthNames = [
                'Jan',
                'Feb',
                'Mar',
                'Apr',
                'May',
                'Jun',
                'July',
                'Aug',
                'Sep',
                'Oct',
                'Nov',
                'Dec'
            ];

            Polymer({
                is: 'web-app',
                properties: {
                    disks: {
                        type: Array,
                        value: [],
                    },
                    rpcStartScanParams: {
                        type: Object,
                        notify: true
                    },
                    rpcElasticParams: {
                        type: Object,
                        notify: true
                    },
                    rpcResponse: {
                        type: Object,
                        notify: true,
                        value: undefined
                    },
                    homeDirPath: {
                        type: String,
                        notify: false
                    },
                    searchResults: {
                        type: Array,
                        notify: true,
                        value: function() {
                            return [];
                        }
                    },
                    searching: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    loading: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    q: {
                        type: String,
                        notify: true,
                        value: ""
                    }
                },
                ready: function() {
                    var that = this;
                    //POC to dectect we are on Desktop App
                    if (typeof window !== 'undefined' && window.process && window.process.type === "renderer") {
                        console.log("We are in Electron ! Let's Go ! ");
                        ipcRenderer.on('disks-message', function(event, disks) {
                            that.disks = disks;
                            that.$.toast.label = "Got disk " + disks[0]['description'];
                            that.$.toast.show();
                        });
                    }

                    /*                this.$.rpc.body = this.rpcParams;
                     this.$.rpc.generateRequest();*/

                    /*ipcRenderer.send("disks-message");
                     ipcRenderer.on('disks-message', function(event, disks) {
                     console.log("Got disks", disks);
                     });*/

                    this.search({
                        "index": "files",
                        "type": "file",
                        "query": this.q,
                        "limit": 20,
                        "offset": 0
                    });

                    ipcRenderer.send("home-dir-message");
                    ipcRenderer.on("home-dir-message", this._handleHomeDir.bind(this));
                },
                _handleScroll: function(e) {
                    if (!this.$.rpcElastic.loading) {
                        if (this.$.listContainer.clientHeight + this.$.listContainer.scrollTop >
                          (this.$.searchList._virtualCount * this.$.searchList._physicalAverage) - 300) {

                            this.rpcElasticParams.request.offset += 20;
                            this.search(this.rpcElasticParams.request);
                        }
                    }
                },
                _handleStartScan: function(e) {
                    if (e.detail.response) {
                        this.search({
                            "index": "files",
                            "type": "file",
                            "query": "*",
                            "limit": 20,
                            "offset": 0
                        });
                    }
                },
                _handleElastic: function(e) {
                    var result;

                    if (e.detail.response && e.detail.response.result) {
                        result = JSON.parse(e.detail.response.result);
                        console.log(result.hits.total)

                        _.forEach(result.hits.hits, function(result) {
                            this.push('searchResults', result);
                        }, this);
                        this.$.searchList.fire('iron-resize');
                    }
                    this.set('loading', false);
                },
                _handleHomeDir: function(e, detail) {
                    this.set('homeDirPath', detail);
                    this.$.snackbar.label = this.homeDirPath;
                    this.$.snackbar.show();
                },
                _computeListWidth: function(isMobile) {
                    // when in mobile screen size, make the list be 100% width to cover the whole screen
                    return isMobile ? '100%' : '66%';
                },
                _listTap: function() {
                    this.$.mainDrawerPanel.closeDrawer();
                },
                _onOpen: function() {
                    console.log("Opening WS")
                },
                _onClose: function() {
                    console.log("Closing WS")
                },
                _onMessage: function(e) {
                    //console.log("Message from WS ", e.detail)
                },
                _onError: function(e) {
                    console.log(e)
                },
                search: function(request) {
                    this.set('loading', true);
                    this.set('rpcElasticParams', {
                        service: "go.micro.srv.desktop",
                        method: "Elastic.Search",
                        request: request
                    });
                    this.$.rpcElastic.body = this.rpcElasticParams;
                    this.$.rpcElastic.generateRequest();
                },
                searchAsYouType: function(e, detail) {
                    this.set('q', this.$.search.input.value);

                    if (this.q.length > 2 || this.q.length === 0) {
                        clearTimeout(this.searchAsYouTypeTimeout);
                        this.searchAsYouTypeTimeout = setTimeout(function() {
                            this.set('searchResults', []);
                            this.$.searchList.fire('iron-resize');
                            this.rpcElasticParams.request = {
                                "index": "files",
                                "type": "file",
                                "query": this.q,
                                "limit": 20,
                                "offset": 0
                            };
                            this.search(this.rpcElasticParams.request);
                        }.bind(this), 450);
                    }
                },
                resetSearch: function(e, detail) {
                    this.set('q', "");
                    this.rpcElasticParams.request = {
                        "index": "files",
                        "type": "file",
                        "query": this.q,
                        "limit": 20,
                        "offset": 0
                    };
                    this.set('searchResults', []);
                    this.$.searchList.fire('iron-resize');
                    this.search(this.rpcElasticParams.request);
                    this.toggleSearch();
                },
                toggleSearch: function(e, detail) {
                    this.$.search.input.value = this.q;
                    this.$.search._inputHandler();
                    this.set('searching', !this.searching);
                },
                startScan: function(e, detail) {
                    this.set('rpcParams', {
                        service: "go.micro.srv.desktop",
                        method: "Crawl.Start",
                        request: {
                            url: 'local://' + this.homeDirPath
                        }
                    });
                    this.$.rpcStartScan.body = this.rpcParams;
                    this.$.rpcStartScan.generateRequest();
                },
                bytesToSize: function(bytes) {
                    if (typeof bytes === 'number') {
                        return bytes;
                        //return filesize(bytes);
                    }
                },
                timestampToHumanTime: function(timestamp) {
                    var date = new Date(timestamp);

                    return (date.getUTCHours() > 9 ? date.getUTCHours() : '0' + date.getUTCHours()) +
                      ':' +
                      (date.getUTCMinutes() > 9 ? date.getUTCMinutes() : '0' + date.getUTCMinutes()) +
                      ':' +
                      (date.getUTCSeconds() > 9 ? date.getUTCSeconds() : '0' + date.getUTCSeconds()) +
                      ' ' +
                      monthNames[date.getMonth()] + ' ' + date.getUTCDate() + ', ' + date.getUTCFullYear();
                },
                isDir: function(isDir) {
                    var icon;

                    if (isDir) {
                        icon = "mat:folder";
                    } else {
                        icon = "mat:file";
                    }

                    return icon;
                }
            });
        }());
    </script>
</dom-module>
