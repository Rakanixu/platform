<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/mat-list/mat-list.html">
<link rel="import" href="../../bower_components/mat-text-field/mat-text-field.html">
<link rel="import" href="../../bower_components/mat-icon/mat-icon.html">
<link rel="import" href="../../bower_components/mat-icons/mat-icons.html">
<link rel="import" href="../../bower_components/mat-avatar/mat-avatar.html">
<link rel="import" href="../../bower_components/mat-button/mat-button.html">
<link rel="import" href="../../bower_components/mat-icon-button/mat-icon-button.html">
<link rel="import" href="../../bower_components/mat-ripple/mat-ripple.html">
<link rel="import" href="../../bower_components/mat-item/mat-item.html">
<link rel="import" href="../../bower_components/mat-divider/mat-divider.html">
<link rel="import" href="../../bower_components/mat-breadcrumb/mat-breadcrumb.html">
<link rel="import" href="../../bower_components/web-socket/web-socket.html">
<link rel="import" href="../../bower_components/mat-toast/mat-toast.html">
<link rel="import" href="../../bower_components/mat-typography/mat-typography.html">
<link rel="import" href="../../bower_components/mat-snackbar/mat-snackbar.html">
<link rel="import" href="../../bower_components/mat-ink/mat-ink.html">

<link rel="import" href="../../src/behaviors/util-behavior.html">
<link rel="import" href="../../src/filter-converter/filter-converter.html">


<dom-module id="web-app">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
            }

            paper-header-panel {
                --paper-header-panel-shadow: {
                    height: 0;
                }
            }

            paper-header-panel[drawer] paper-toolbar {
                --paper-toolbar-background: var(--dark-primary);
            }

            paper-toolbar mat-text-field {
                margin-top: 16px;
            }

            .listContainer {
                height: 100%;
                overflow: auto;
            }

            .photoContent {
                @apply(--layout);
                position: relative;
                width: 178px;
                height: 178px;
                margin: 4px;
                background: white;
                cursor: pointer;
            }

            .photoContainer:hover .detail {
                background:rgba(0,0,0,0.6);
            }

            .photoContent > iron-image {
                @apply(--layout-flex);
            }

            .photoContent > .detail {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background:rgba(0,0,0,0.4);
                color: white;
                font-size: 14px;
                font-weight: 100;
            }
        </style>

        <paper-drawer-panel id="navDrawerPanel" responsive-width="1280px">
            <!-- Nav Content -->
            <div class="nav" drawer>
                <paper-toolbar class="medium-tall left-menu">
                    <label is="mat-label" class="bottom">Email</label>
                </paper-toolbar>

                <div class="content">
                    <paper-menu selected="{{selectedCategory.index}}">
                        <paper-icon-item on-tap="setCategory" data-value="">
                            <iron-icon icon="icons:home" item-icon></iron-icon>All
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value="Document Files">
                            <iron-icon icon="editor:insert-drive-file" item-icon></iron-icon>Documents
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value="Video Files">
                            <iron-icon icon="av:movie" item-icon></iron-icon>Movies
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value="Image Files">
                            <iron-icon icon="image:camera-alt" item-icon></iron-icon>Pictures
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value="Audio Files">
                            <iron-icon icon="image:audiotrack" item-icon></iron-icon>Audio
                        </paper-icon-item>
                    </paper-menu>

                    <mat-divider></mat-divider>

                    <paper-menu>
                        <paper-icon-item>
                            <iron-icon icon="icons:settings" item-icon></iron-icon>Settings
                        </paper-icon-item>
                        <paper-icon-item id="intercom_launch">
                            <iron-icon icon="icons:feedback" item-icon></iron-icon>Feedback
                        </paper-icon-item>
                    </paper-menu>

                </div>
            </div>

            <paper-drawer-panel id="mainDrawerPanel"
                                responsive-width="960px"
                                drawer-width="[[_computeListWidth(_isMobile)]]"
                                narrow="{{_isMobile}}"
                                force-narrow="[[!itemSelected]]"
                                disable-swipe="true"
                                right-drawer
                                main>
                <paper-header-panel id="mainPaperHeaderPanel" class="list-panel main" main>

                    <!-- List Toolbar -->
                    <paper-toolbar class="medium-tall">
                        <paper-icon-button icon="menu" on-tap="openMenu" hidden$="[[mediaQueryLarge]]"></paper-icon-button>

                        <div class="flex horizontal layout" on-tap="toggleSearch" hidden$="[[searching]]">
                            <div class="title flex">Kazoup Search</div>
                            <mat-icon-button icon="mat:search" color="white"></mat-icon-button>
                        </div>

                        <mat-text-field  id="search" class="flex" label="Search files" on-keyup="searchAsYouType" hidden$="[[!searching]]"></mat-text-field>
                        <mat-icon-button id="reset" icon="mat:clear" on-xp-activate="resetSearch" color="white" hidden$="[[!searching]]"></mat-icon-button>

                        <paper-icon-button id="searchViewIcon" icon="[[view.icon]]" on-tap="toggleView"></paper-icon-button>


                        <mat-breadcrumb class="extended bottom title"
                                        hidden$="[[handleSearchHeader(selectedCategory.index)]]"
                                        shift>
                            <mat-breadcrumb-step label="My files"></mat-breadcrumb-step>
                        </mat-breadcrumb>

                        <mat-breadcrumb class="extended bottom title"
                                        hidden$="[[!handleSearchHeader(selectedCategory.index)]]"
                                        shift>
                            <mat-breadcrumb-step label="[[selectedCategory.label]]"></mat-breadcrumb-step>
                        </mat-breadcrumb>

                        <paper-progress id="progressBar"
                                        class="middle fit"
                                        hidden$="[[!loading]]"
                                        indeterminate></paper-progress>
                    </paper-toolbar>

                    <!-- Search results -->
                    <div id="listContainer" class="listContainer" on-scroll="_handleScroll">
                        <iron-list id="searchList" items="[[searchResults]]">
                            <template>
                                <div>
                                    <template is="dom-if" if="{{!view.isGrid}}" restamp="true">
                                        <mat-item on-tap="mainAction"
                                                  label="[[item._source.name]]"
                                                  description="[[item._source.url]]">
                                            <mat-avatar class="primary" icon="[[isDir(item._source.is_dir)]]"></mat-avatar>
                                            <span>[[timestampToHumanTime(item._source.modified)]], [[bytesToSize(item._source.size)]]</span>
                                        </mat-item>
                                    </template>

                                    <template is="dom-if" if="{{view.isGrid}}" restamp="true">
                                        <div class="photoContainer grid" on-tap="mainAction">
                                            <div class="photoContent" tabindex$="[[tabIndex]]">
                                                <template is="dom-if" if="[[isImage(item._source.category)]]">
                                                    <iron-image sizing="contain"
                                                                src="http://localhost:8082/desktop/image?source=[[item._source.url]]&width=356&height=356&mode=fit&quality=100"></iron-image>
                                                </template>

                                                <template is="dom-if" if="[[!isImage(item._source.category)]]">
                                                    <mat-avatar icon="[[isDir(item._source.is_dir)]]"></mat-avatar>
                                                </template>

                                                <div class="detail">
                                                    <mat-item class="light"
                                                              label="[[item._source.name]]"></mat-item>
                                                </div>
                                                <mat-ripple></mat-ripple>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </iron-list>
                    </div>

                </paper-header-panel>

                <paper-header-panel class="content-panel drawer" drawer>
                    <!-- Right Toolbar -->
                    <paper-toolbar  class="medium-tall">
                        <paper-icon-button icon="icons:close" on-tap="closeDetails" tabindex="-1"></paper-icon-button>

                        <div class="bottom">
                            <span>[[item._source.name]]</span>
                        </div>
                    </paper-toolbar>

                    <!-- Right Content -->
                    <div class="content">
                        <iron-image src="http://www.freedigitalphotos.net/images/img/homepage/87357.jpg"></iron-image>

                        <mat-item label="[[item._source.name]]"
                                  description="[[item._source.url]]"
                                  tabindex="-1"></mat-item>
                    </div>
                </paper-header-panel>

            </paper-drawer-panel>
        </paper-drawer-panel>

        <filter-converter id="filterConverter"></filter-converter>

        <mat-snackbar id="snackbar"
                      button="Scan"
                      timeout="100000"
                      action-color="yellow"
                      label=""
                      on-xp-activate="startScan"></mat-snackbar>

        <web-socket url="ws://localhost:8082/desktop/status"
                    auto
                    json
                    on-open="_onOpen"
                    on-close="_onClose"
                    on-message="_onMessage"
                    on-error="_onError"></web-socket>

        <iron-ajax id="rpcStartScan"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleStartScan"
                   params="{{rpcStartScanParams}}"></iron-ajax>

        <iron-ajax id="rpcElastic"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleElastic"
                   params="{{rpcElasticParams}}"></iron-ajax>

        <iron-media-query query="(min-width: 601px)"
                          query-matches="{{mediaQuerySmall}}"></iron-media-query>

        <iron-media-query query="(min-width: 961px)"
                          query-matches="{{mediaQueryMedium}}"></iron-media-query>

        <iron-media-query query="(min-width: 1281px)"
                          query-matches="{{mediaQueryLarge}}"></iron-media-query>

    </template>

    <script>
        'use strict';

        (function() {
            Polymer({
                is: 'web-app',
                behaviors: [
                    Polymer.UtilBehaviorImp
                ],
                properties: {
                    disks: {
                        type: Array,
                        value: [],
                    },
                    rpcStartScanParams: {
                        type: Object,
                        notify: true
                    },
                    rpcElasticParams: {
                        type: Object,
                        notify: true
                    },
                    rpcResponse: {
                        type: Object,
                        notify: true,
                        value: undefined
                    },
                    homeDirPath: {
                        type: String,
                        notify: false
                    },
                    selectedCategory: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {
                                index: 0,
                                label: 'My Files'
                            }
                        }
                    },
                    item: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {};
                        }
                    },
                    itemSelected: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    view: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {
                                icon: 'icons:view-module',
                                isGrid: false
                            };
                        }
                    },
                    searchResults: {
                        type: Array,
                        notify: true,
                        value: function() {
                            return [];
                        }
                    },
                    searching: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    loading: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    q: {
                        type: String,
                        notify: true,
                        value: ""
                    }
                },
                ready: function() {
                    this.$.filterConverter.addEventListener('filter-changed', this._handleFilterChanged.bind(this));

                    window.addEventListener('web-app-activated', this.init.bind(this));

/*                    var that = this;
                    //POC to dectect we are on Desktop App
                    if (typeof window !== 'undefined' && window.process && window.process.type === "renderer") {
                        console.log("We are in Electron ! Let's Go ! ");
                        ipcRenderer.on('disks-message', function(event, disks) {
                            that.disks = disks;
                            that.$.toast.label = "Got disk " + disks[0]['description'];
                            that.$.toast.show();
                        });
                    }*/

                    /*                this.$.rpc.body = this.rpcParams;
                     this.$.rpc.generateRequest();*/

                    /*ipcRenderer.send("disks-message");
                     ipcRenderer.on('disks-message', function(event, disks) {
                     console.log("Got disks", disks);
                     });*/
                },
                init: function(e) {
                    this.$.filterConverter.setValues({
                      term: "",
                      from: 0,
                      size: 20,
                      url: "/",
                      depth: 1
                    });

                    ipcRenderer.send("home-dir-message");
                    ipcRenderer.on("home-dir-message", this._handleHomeDir.bind(this));
                },
                _handleFilterChanged: function(e) {
                    this.search();
                },
                _handleScroll: function(e) {
                    if (!this.$.rpcElastic.loading) {
                        if (this.$.listContainer.clientHeight + this.$.listContainer.scrollTop >
                          ((this.$.searchList._virtualCount / this.$.searchList._itemsPerRow) * this.$.searchList._physicalAverage) - 300) {
                            this.$.filterConverter.setValue('from', this.$.filterConverter.getFilterAsObj().from + 20);
                        }
                    }
                },
                _handleStartScan: function(e) {
                    if (e.detail.response) {
                        this.search();
                    }
                },
                _handleElastic: function(e) {
                    var result;

                    if (e.detail.response && e.detail.response.result) {
                        result = JSON.parse(e.detail.response.result);
                        console.log(result.hits.total)

                        _.forEach(result.hits.hits, function(result) {
                            this.push('searchResults', result);
                        }, this);
                        this.$.searchList.fire('iron-resize');
                    }
                    this.set('loading', false);
                },
                _handleHomeDir: function(e, detail) {
                    this.set('homeDirPath', detail);
                    this.$.snackbar.label = this.homeDirPath;
                    this.$.snackbar.show();
                },
                _computeListWidth: function(isMobile) {
                    // when in mobile screen size, make the list be 100% width to cover the whole screen
                    return isMobile ? '100%' : '35%';
                },
                _listTap: function() {
                    this.$.mainDrawerPanel.closeDrawer();
                },
                _onOpen: function() {
                    console.log("Opening WS")
                },
                _onClose: function() {
                    console.log("Closing WS")
                },
                _onMessage: function(e) {
                    //console.log("Message from WS ", e.detail)
                },
                _onError: function(e) {
                    console.log(e)
                },
                clearIronList: function() {
                    this.set('searchResults', []);
                    this.$.searchList.fire('iron-resize');
                },
                setCategory: function(e, detail) {
                    this.clearIronList();
                    if (e.target.dataset.value === 'Image Files') {
                        this.setGridView();
                    } else {
                        this.setListView();
                    }
                    this.refreshView();
                    this.set('selectedCategory.label', e.target.dataset.value);

                    // depth must be 0 for search
                    // When there is no search term and user didn't selected a category, then browse
                    this.$.filterConverter.setValues({
                        from: 0,
                        size: 20,
                        category: e.target.dataset.value,
                        url: '/',
                        depth: (e.target.dataset.value || this.$.filterConverter.getFilterAsObj().term) ? 0 : 1
                    });
                },
                search: function(request) {
                    this.set('loading', true);
                    this.set('rpcElasticParams', {
                        service: "go.micro.srv.desktop",
                        method: "Search.Search",
                        request: this.$.filterConverter.getFilterAsObj()
                    });

                    this.$.rpcElastic.body = this.rpcElasticParams;
                    this.$.rpcElastic.generateRequest();
                },
                searchAsYouType: function(e, detail) {
                    var term = this.$.search.input.value;

                    if (term.length > 2 || term.length === 0) {
                        clearTimeout(this.searchAsYouTypeTimeout);
                        this.searchAsYouTypeTimeout = setTimeout(function() {
                            this.set('itemSelected', false);
                            this.clearIronList();

                            this.$.filterConverter.setValues({
                                from: 0,
                                size: 20,
                                term: term,
                                url: '',
                                depth: 0
                            });
                        }.bind(this), 450);
                    }
                },
                resetSearch: function(e, detail) {
                    this.set('itemSelected', false);
                    this.clearIronList();

                    this.$.filterConverter.setValues({
                        term: '',
                        from: 0,
                        size: 20,
                        url: '/',
                        depth: this.selectedCategory.index ? 0 : 1
                    });
                    this.toggleSearch();
                },
                toggleSearch: function(e, detail) {
                    this.$.search.input.value = this.$.filterConverter.getFilterAsObj().term;
                    this.$.search._inputHandler();

                    this.async(function() {
                        this.$.search.focus();
                    }, 1);
                    this.set('searching', !this.searching);
                },
                startScan: function(e, detail) {
                    this.set('rpcParams', {
                        service: "go.micro.srv.desktop",
                        method: "Crawl.Start",
                        request: {
                            url: 'local://' + this.homeDirPath
                        }
                    });
                    this.$.rpcStartScan.body = this.rpcParams;
                    this.$.rpcStartScan.generateRequest();
                },
                mainAction: function(e, detail) {
                    if (e.model.__data__.item._source.is_dir) {
                        this.clearIronList();
                        this.$.filterConverter.setValues({
                            from: 0,
                            size: 20,
                            url:e.model.__data__.item._source.url,
                            depth: e.model.__data__.item._source.depth + 1
                        });
                    } else {
                        this.set('item', e.model.__data__.item);
                        this.set('itemSelected', true);
                        this.$.mainDrawerPanel.openDrawer();
                    }
                },
                closeDetails: function(e, detail) {
                    this.set('itemSelected', false);
                    this.$.mainDrawerPanel.closeDrawer();
                },
                refreshView: function() {
                    this.$.searchList.fire('iron-resize');
                    this.$.searchList.notifyResize();
                    this.$.searchList.scrollToIndex(0);
                },
                setGridView: function() {
                    this.set('view.icon', 'icons:view-list');
                    this.$.searchList.setAttribute('grid', '');
                    this.set('view.isGrid', true);
                },
                setListView: function() {
                    this.set('view.icon', 'icons:view-module');
                    this.$.searchList.removeAttribute('grid');
                    this.set('view.isGrid', false);
                },
                toggleView: function(e, detail) {
                    if (this.view.isGrid) {
                        this.setListView();
                    } else {
                        this.setGridView();
                    }
                    this.refreshView();
                },
                handleSearchHeader: function(selected) {
                    return (selected !== 0);
                }
            });
        }());
    </script>
</dom-module>
