<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/web-socket/web-socket.html">

<link rel="import" href="../../bower_components/mat-list/mat-list.html">
<link rel="import" href="../../bower_components/mat-text-field/mat-text-field.html">
<link rel="import" href="../../bower_components/mat-icon/mat-icon.html">
<link rel="import" href="../../bower_components/mat-icons/mat-icons.html">
<link rel="import" href="../../bower_components/mat-dialog/mat-dialog.html">
<link rel="import" href="../../bower_components/mat-icons/image-icons.html">
<link rel="import" href="../../bower_components/mat-avatar/mat-avatar.html">
<link rel="import" href="../../bower_components/mat-button/mat-button.html">
<link rel="import" href="../../bower_components/mat-raised-button/mat-raised-button.html">
<link rel="import" href="../../bower_components/mat-icon-button/mat-icon-button.html">
<link rel="import" href="../../bower_components/mat-ripple/mat-ripple.html">
<link rel="import" href="../../bower_components/mat-item/mat-item.html">
<link rel="import" href="../../bower_components/mat-divider/mat-divider.html">
<link rel="import" href="../../bower_components/mat-breadcrumb/mat-breadcrumb.html">
<link rel="import" href="../../bower_components/mat-breadcrumb/mat-breadcrumb-step.html">
<link rel="import" href="../../bower_components/mat-toast/mat-toast.html">
<link rel="import" href="../../bower_components/mat-typography/mat-typography.html">
<link rel="import" href="../../bower_components/mat-snackbar/mat-snackbar.html">
<link rel="import" href="../../bower_components/mat-ink/mat-ink.html">
<link rel="import" href="../../bower_components/mat-menu/mat-menu.html">

<link rel="import" href="../../bower_components/wave-player/wave-player.html">

<link rel="import" href="../../src/behaviors/util-behavior.html">
<link rel="import" href="../../src/behaviors/nav-behavior.html">
<link rel="import" href="../../src/behaviors/categories-map-behavior.html">
<link rel="import" href="../../src/behaviors/common-behavior.html">

<link rel="import" href="../../src/filter-converter/filter-converter.html">
<link rel="import" href="../../src/kazoup-icons/kazoup-icons.html">

<dom-module id="web-app">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
            }

            paper-header-panel {
                --paper-header-panel-shadow: {
                    height: 0;
                }
            }

            paper-header-panel[drawer] paper-toolbar {
                --paper-toolbar-background: var(--dark-primary);
            }

            paper-toolbar mat-text-field {
                margin-top: 16px;
            }

            .scan-container {
                position: absolute;
                bottom: 15px;
            }

            .scan-container mat-raised-button {
                background-color: var(--dark-primary);
                color: #fff;
                margin-left: 70px;
            }

            .prepopulated mat-item div.body{
                background: gray;
                border-radius: 12px;
            }

            .breadcrumbs {
                margin-left: 60px;
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 20px;
                font-weight: 400;
                line-height: 1.2;
                pointer-events: none;
                -ms-flex: 1 1 0.000000001px;
                -webkit-flex: 1;
                flex: 1;
                -webkit-flex-basis: 0.000000001px;
                flex-basis: 0.000000001px;
            }

            #noFitBreadcrumbs {
                margin-left: 40px;
            }

            #noFitBreadcrumbs mat-item mat-avatar {
                background-color: #21a9f5;
                pointer-events: none;
                margin: 0 0 0 -12px;
            }

            .photoContent {
                @apply(--layout);
                position: relative;
                width: 178px;
                height: 178px;
                margin: 1px;
                background: white;
                cursor: pointer;
            }

            .photoContainer:hover .detail {
                background:rgba(0,0,0,0.6);
            }


            .photoContent > iron-image {
                @apply(--layout-flex);
            }

            .photoContent > .detail {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background:rgba(0,0,0,0.4);
                color: white;
                font-size: 14px;
                font-weight: 100;
            }

            .big-video mat-item mat-avatar {
                width: 113px;
                height: 72px;
            }
        </style>

        <paper-drawer-panel id="navDrawerPanel" responsive-width="1280px">
            <!-- Nav Content -->
            <div class="nav" drawer>
                <paper-toolbar class="medium-tall left-menu">
                    <label is="mat-label" class="bottom">[[user.user.username]]@[[user.hostname]]</label>
                </paper-toolbar>

                <div class="content">
                    <paper-menu selected="{{selectedCategory.index}}">
                        <paper-icon-item on-tap="listDatasources">
                            <iron-icon icon="icons:home" item-icon></iron-icon>All
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value$="[[categoriesMap.documents]]">
                            <iron-icon icon="editor:insert-drive-file" item-icon></iron-icon>Documents
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value$="[[categoriesMap.videos]]">
                            <iron-icon icon="av:movie" item-icon></iron-icon>Movies
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value$="[[categoriesMap.images]]">
                            <iron-icon icon="image:camera-alt" item-icon></iron-icon>Pictures
                        </paper-icon-item>
                        <paper-icon-item on-tap="setCategory" data-value$="[[categoriesMap.audios]]">
                            <iron-icon icon="image:audiotrack" item-icon></iron-icon>Audio
                        </paper-icon-item>
                    </paper-menu>

                    <mat-divider></mat-divider>

                    <paper-menu>
                        <paper-icon-item id="settings" on-tap="showSettingsPage">
                            <iron-icon icon="icons:settings" item-icon></iron-icon>Settings
                        </paper-icon-item>
                        <paper-icon-item id="intercom_launch">
                            <iron-icon icon="icons:feedback" item-icon></iron-icon>Feedback
                        </paper-icon-item>
                    </paper-menu>

                    <div class="scan-container">
                        <mat-raised-button id="scan"
                                           on-tap="scanAll"
                                           label="Start scan"></mat-raised-button>
                    </div>
                </div>
            </div>

            <paper-drawer-panel id="mainDrawerPanel"
                                responsive-width="960px"
                                drawer-width="[[_computeListWidth(_isMobile)]]"
                                narrow="{{_isMobile}}"
                                force-narrow="[[!itemSelected]]"
                                disable-swipe="true"
                                right-drawer main>
                <paper-header-panel id="mainPaperHeaderPanel" class="list-panel main" main>

                    <!-- List Toolbar -->
                    <paper-toolbar class="medium-tall">
                        <paper-icon-button icon="menu"
                                           on-tap="openMenu"
                                           hidden$="[[mediaQueryLarge]]"></paper-icon-button>

                        <div class="flex horizontal layout"
                             on-tap="toggleSearch"
                             hidden$="[[searching]]">
                            <div class="title flex">[[title]]</div>
                            <mat-icon-button icon="mat:search" color="white"></mat-icon-button>
                        </div>

                        <mat-text-field id="search"
                                        class="flex"
                                        label="Search files"
                                        on-keyup="searchAsYouType"
                                        hidden$="[[!searching]]"></mat-text-field>
                        <mat-icon-button id="reset"
                                         icon="mat:clear"
                                         on-xp-activate="resetSearch"
                                         color="white"
                                         hidden$="[[!searching]]"></mat-icon-button>
                        <!--
                        <paper-icon-button id="searchViewIcon"
                                           icon="[[view.icon]]"
                                           on-tap="toggleView"></paper-icon-button>
                        -->
                        <div class="middle breadcrumbs">
                            <!-- Breadcrumbs while browsing. Breadcrumbs fits into screen -->
                            <mat-breadcrumb id="fitBreadcrumbs"
                                            class="browse"
                                            hidden$="[[handleSearchHeader(selectedCategory.index)]]"
                                            shift="true">
                                <mat-breadcrumb-step label="My Files" on-tap="listDatasources"></mat-breadcrumb-step>
                                <template id="breadcrumbsSteps" is="dom-repeat" items="[[breadcrumbs]]">
                                    <mat-breadcrumb-step label="[[item.label]]" on-tap="browse"></mat-breadcrumb-step>
                                </template>
                            </mat-breadcrumb>
                        </div>

                        <!-- Mobile breadcrumbs style like. -->
                        <div id="noFitBreadcrumbs" class="bottom">
                            <mat-item label="[[lastBreadcrumb.label]]"
                                      behavior="toggle"
                                      class="light"
                                      target="breadcrumbsMenu"
                                      style="font-size:20px;font-weight:400;">
                                <mat-avatar class="secondary" icon="mat:arrow-drop-down"></mat-avatar>
                            </mat-item>

                            <mat-menu id="breadcrumbsMenu" position="baseline">
                                <mat-option label="My Files" on-tap="listDatasources"></mat-option>
                                <template id="breadcrumbsStepsMenu" is="dom-repeat" items="[[breadcrumbs]]">
                                    <mat-option label="[[item.label]]" on-tap="browse"></mat-option>
                                </template>
                            </mat-menu>
                        </div>

                        <paper-progress id="progressBar"
                                        class="middle fit"
                                        hidden$="[[!loading]]"
                                        indeterminate></paper-progress>
                    </paper-toolbar>

                    <!-- Datasource listing -->
                    <iron-list id="datasourcesList" items="[[datasourceResults]]" hidden$="[[!datasourceListView]]">
                        <template>
                            <div>
                                <mat-item on-tap="browseDatasource"
                                          label="[[getDatasourceUrl(item.url)]]"
                                          description="">
                                    <mat-avatar class="primary"
                                                icon$="[[getDatasourceIcon(item.url)]]">
                                    </mat-avatar>

                                </mat-item>
                            </div>
                        </template>
                    </iron-list>

                    <!-- Search results -->
                    <iron-list id="searchList" items="[[searchResults]]" on-scroll="_handleScroll" hidden$="[[datasourceListView]]">
                        <template>
                            <div class$="[[bigVideoClass]] [[getPrepopulatedClass(item.unknown)]]">
                                <template is="dom-if" if="{{!view.isGrid}}" restamp="true">
                                    <template is="dom-if" if="{{isVideo(item.category)}}">
                                        <mat-item on-tap="mainAction"
                                                  label="[[item.name]]"
                                                  description="[[item.url]]">
                                            <mat-avatar background="[[documentType(item.name)]]"
                                                        class="primary image"
                                                        icon-src="[[getVideoFrame(item.url)]]"></mat-avatar>
                                            <span>[[timestampToHumanTime(item.modified)]], [[bytesToSize(item.size)]]</span>
                                        </mat-item>
                                    </template>

                                    <template is="dom-if" if="{{isImage(item.category)}}">
                                        <mat-item on-tap="mainAction"
                                                  label="[[item.name]]"
                                                  description="[[item.url]]">
                                            <mat-avatar background="[[documentType(item.name)]]"
                                                        class="primary image"
                                                        icon-src="http://localhost:8082/media/image?source=[[getLocalAsset(item.url)]]&width=128&height=128&mode=fit&quality=100"></mat-avatar>
                                            <span>[[timestampToHumanTime(item.modified)]], [[bytesToSize(item.size)]]</span>
                                        </mat-item>
                                    </template>

                                    <template is="dom-if" if="{{isNoVisualMedia(item.category)}}">
                                        <mat-item on-tap="mainAction"
                                                  label="[[item.name]]"
                                                  description="[[item.url]]">
                                            <mat-avatar background="[[documentType(item.name)]]"
                                                        class="primary"
                                                        icon="[[getIcon(item.is_dir, item.category)]]"></mat-avatar>
                                            <span>[[timestampToHumanTime(item.modified)]], [[bytesToSize(item.size)]]</span>
                                        </mat-item>
                                    </template>
                                </template>

                                <template is="dom-if" if="{{view.isGrid}}" restamp="true">
                                    <div class="photoContainer grid" on-tap="mainAction">
                                        <div class="photoContent" tabindex$="[[tabIndex]]">
                                            <template is="dom-if" if="[[isImage(item.category)]]">
                                                <iron-image sizing="contain"
                                                            src="http://localhost:8082/media/image?source=[[getLocalAsset(item.url)]]&width=356&height=356&mode=fit&quality=100"></iron-image>
                                            </template>

                                            <template is="dom-if" if="[[isVideo(item.category)]]">
                                                <iron-image sizing="contain"
                                                            src="[[getVideoFrame(item.url)]]"></iron-image>
                                            </template>

                                            <template is="dom-if" if="[[isNoVisualMedia(item.category)]]">
                                                <mat-avatar background="[[documentType(item.name)]]"
                                                            class="primary"
                                                            icon="[[getIcon(item.is_dir, item.category)]]"></mat-avatar>
                                            </template>

                                            <div class="detail">
                                                <mat-item class="light" label="[[item.name]]"></mat-item>
                                            </div>
                                            <mat-ripple></mat-ripple>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </iron-list>

                </paper-header-panel>

                <paper-header-panel class="content-panel drawer" drawer>
                    <!-- Right Toolbar -->
                    <paper-toolbar class="medium-tall">
                        <paper-icon-button icon="icons:close"
                                           on-tap="closeDetails"
                                           tabindex="-1"></paper-icon-button>

                        <div class="flex"></div>

                        <paper-icon-button icon="icons:create"
                                           on-tap="openFile"
                                           tabindex="-1"></paper-icon-button>

                        <div class="bottom">
                            <mat-item label="[[item.name]]" class="light" focused="false"></mat-item>
                        </div>
                    </paper-toolbar>

                    <!-- Right Content -->
                    <div class="content">
                        <template is="dom-if" if="[[isImage(item.category)]]">
                            <iron-image style="width:100%"
                                        src="http://localhost:8082/media/image?source=[[getLocalAsset(item.url)]]&width=600&mode=fit&quality=100"
                                        preload
                                        fade></iron-image>
                        </template>

                        <template is="dom-if" if="[[isVideo(item.category)]]" restamp="true">
                            <video id="video" controls preload="auto" width="100%">
                                <source src="[[getAsset(item.url)]]">
                            </video>
                        </template>

                        <template is="dom-if" if="[[isAudio(item.category)]]" restamp="true">
                            <wave-player id="wavePlayer"
                                         wavecolor="#21a9f5"
                                         progresscolor="#b1b1b1"
                                         src="[[getAsset(item.url)]]"/>
                        </template>

                        <mat-item label="Location"
                                  description="[[item.url]]"
                                  tabindex="-1"></mat-item>
                    </div>
                </paper-header-panel>

            </paper-drawer-panel>
        </paper-drawer-panel>

        <filter-converter id="filterConverter"></filter-converter>

        <paper-toast id="toast" text=""></paper-toast>

        <mat-snackbar id="snackbar"
                      button="OK"
                      timeout="10000000"
                      action-color="yellow"
                      label=""
                      on-xp-activate="addDatasourceAndScan"></mat-snackbar>

        <web-socket url="ws://localhost:8082/media/crawler/status"
                    on-open="_onOpen"
                    on-close="_onClose"
                    on-message="_onMessage"
                    on-error="_onError"
                    auto
                    json></web-socket>

        <iron-ajax id="rpcStartScan"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleStartScan"
                   params="[[rpcStartScanParams]]"></iron-ajax>

        <iron-ajax id="rpcAddDatasource"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleAddDatasource"
                   params="[[rpcAddDatasourceParams]]"></iron-ajax>

        <iron-ajax id="rpcGetDatasources"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                   handle-as="json"
                   on-error="_handleError"
                   on-response="_handleGetDatasource"
                   params="[[rpcGetDatasourcesParams]]"></iron-ajax>

        <iron-ajax id="rpcElastic"
                   method="POST"
                   content-type="application/json"
                   url="http://localhost:8082/rpc"
                    handle-as="json"
                   on-error="_handleError"
                   on-response="_handleElastic"
                   params="[[rpcElasticParams]]"></iron-ajax>

        <iron-media-query query="(min-width: 601px)"
                          query-matches="{{mediaQuerySmall}}"></iron-media-query>

        <iron-media-query query="(min-width: 961px)"
                          query-matches="{{mediaQueryMedium}}"></iron-media-query>

        <iron-media-query query="(min-width: 1281px)"
                          query-matches="{{mediaQueryLarge}}"></iron-media-query>

    </template>

    <script>
    'use strict';

    (function() {
        Polymer({
            is: 'web-app',
            behaviors: [
                Polymer.UtilBehaviorImp,
                Polymer.NavBehaviorImp,
                Polymer.CategoriesMapBehaviorImp,
                Polymer.AsyncBehaviorImp,
                Polymer.CommonBehaviorImp,
                Polymer.EndpointsBehaviorImp
            ],
            properties: {
                disks: {
                    type: Array,
                    value: [],
                },
                rpcAddDatasourceParams: {
                    type: Object,
                    notify: true
                },
                rpcGetDatasourcesParams: {
                    type: Object,
                    notify: false,
                    value: function() {
                        return {
                            service: 'go.micro.srv.datasource',
                            method: 'DataSource.Search',
                            request: {
                                index: 'datasources',
                                type: 'datasource',
                                from: 0,
                                size: 9999
                            }
                        };
                    }
                },
                rpcStartScanParams: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {
                            service: 'go.micro.srv.datasource',
                            method: 'DataSource.Scan',
                            request: {
                                id: ''
                            }
                        };
                    }
                },
                rpcElasticParams: {
                    type: Object,
                    notify: true
                },
                rpcResponse: {
                    type: Object,
                    notify: true,
                    value: undefined
                },
                homeDirPath: {
                    type: String,
                    notify: false
                },
                size: {
                    type: Number,
                    notify: false,
                    value: 45
                },
                title: {
                    type: String,
                    notify: false,
                    value: 'Kazoup Search'
                },
                selectedCategory: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {
                            index: 0,
                            label: 'My Files'
                        }
                    }
                },
                item: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {};
                    }
                },
                itemSelected: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: 'itemSelectedChanged'
                },
                doScan: {
                    type: Boolean,
                    notify: true,
                    value: false,
                },
                view: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {
                            icon: 'icons:view-module',
                            isGrid: false
                        };
                    }
                },
                datasourceResults: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },
                searchResults: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },
                totalResults: {
                    type: Number,
                    notify: false,
                    value: 0
                },
                searching: {
                    type: Boolean,
                    notify: true,
                    value: false
                },
                datasourceListView: {
                    type: Boolean,
                    notify: true,
                    value: true
                },
                breadcrumbs: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },
                lastBreadcrumb: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {};
                    }
                },
                bigVideoClass: {
                    type: String,
                    notify: false,
                    value: ''
                }
            },
            observers: [
                'breadcrumbsChanged(breadcrumbs.*)'
            ],
            breadcrumbsChanged: function(newVal, oldVal) {
                this.set('lastBreadcrumb', this.breadcrumbs[this.breadcrumbs.length - 1]);
            },
            itemSelectedChanged: function(oldval, newVal) {
                if (!this.itemSelected) {
                    if (document.querySelector("video")) {
                        document.querySelector("video").pause();
                    }
                    if (document.querySelector("wave-player")){
                        document.querySelector("wave-player").wavesurfer.stop();
                    }
                }
            },
            ready: function() {
                var resizeCallback;

                this.$.rpcGetDatasources.body = this.rpcGetDatasourcesParams;

                this.$.filterConverter.addEventListener('filter-changed', this._handleFilterChanged.bind(this));

                window.addEventListener('web-app-activated', this.init.bind(this));
                window.addEventListener('resize',function(e) {
                    e.preventDefault();

                    clearTimeout(resizeCallback);
                    resizeCallback = setTimeout(function() {
                            this.checkBreadcrumbsView(0);
                    }.bind(this), 300);
                }.bind(this));

                if (window && window.process && window.process.type){
                    ipcRenderer.on('home-dir-message', this._handleHomeDir.bind(this));
                    ipcRenderer.send('home-dir-message');
                }
            },
            init: function(e, detail) {
                this.clearIronList();

                if (e.data && e.data.first_scan) {
                    this.showScanSnack();
                } else if (e.data && e.data.callback && e.data.e) {
                    this[e.data.callback](e.data.e);
                    if (e.data.e.selectedCategory) {
                        this.set('selectedCategory', e.data.e.selectedCategory);
                    }
                } else {
                    this.listDatasources();
                    this.checkBreadcrumbsView(0);
                }
            },
            _handleFilterChanged: function(e) {
                var url = this.$.filterConverter.getFilterAsObj().url,
                    breadcrumbUrl = '',
                    length = 0;

                this.set('breadcrumbs', []);
                if (url.length) {
                    if (url.charAt(0) === '/') {
                        url = url.substring(1);
                    }
                    length = url.split('/').length;

                    _.forEach(url.split('/'), function(label, i) {
                        breadcrumbUrl += '/' + label;
                        this.push('breadcrumbs', {
                            label: label,
                            url: breadcrumbUrl,
                            depth: i + 1
                        });
                    }, this);
                }

                this.$.breadcrumbsSteps.render();
                this.$.breadcrumbsStepsMenu.render();
                this.checkBreadcrumbsView(0);
                this.set('datasourceListView', false);

                this.search();
            },
            _handleScroll: function(e) {
                if (!this.$.rpcElastic.loading) {
                    if (this.$.searchList.scrollTop >
                        ((this.$.searchList._virtualCount / this.$.searchList._itemsPerRow) *
                        this.$.searchList._physicalAverage) - (this.$.searchList.getBoundingClientRect().height + 300)) {
                        var from = this.$.filterConverter.getFilterAsObj().from + this.size;

                        if (from < this.totalResults) {
                            this.$.filterConverter.setValue('from', from);
                        }
                    }
                }
            },
            _handleStartScan: function(e) {
                if (e.detail.response) {
                    this.$.snackbar.hide();
                    this.$.toast.text = 'Scanning started, data will appear shortly';
                    this.$.toast.show();
                    this.async(function() {
                        this.init({});
                    }, 3500);
                }
            },
            _handleElastic: function(e) {
                var result;

                if (e.detail.response && e.detail.response.result) {
                    result = JSON.parse(e.detail.response.result);
                    this.set('totalResults', JSON.parse(e.detail.response.info).total);
                    _.forEach(result, function(record) {
                        this.push('searchResults', record);
                    }, this);
                    this.$.searchList.fire('iron-resize');
                }
                this.set('loading', false);
            },
            _handleHomeDir: function(e, detail) {
                this.set('homeDirPath', detail);
            },
            _computeListWidth: function(isMobile) {
                // when in mobile screen size, make the list be 100% width to cover the whole screen
                return isMobile ? '100%' : '35%';
            },
            _listTap: function() {
                this.$.mainDrawerPanel.closeDrawer();
            },
            _onOpen: function() {

            },
            _onClose: function() {

            },
            _onMessage: function(e) {
                // No crawler running
                if (_.isEmpty(e.detail)) {
                    this.$.scan.removeAttribute('disabled');
                // Crawler running
                } else {
                    this.$.scan.setAttribute('disabled', '');
                }
            },
            _onError: function(e) {
                console.log(e)
            },
            _handleError: function(e, detail) {
                this.set('loading', false);
                if (e.detail.request && e.detail.request.response) {
                    this.$.toast.text = e.detail.request.response.detail;
                    this.$.toast.show();
                }
            },
            _handleAddDatasource: function(e) {
                if (e.detail.response) {
                    this.$.toast.text = 'New datasource created succesfully';
                    this.$.toast.show();

                    this.async(function() {
                        this.$.rpcGetDatasources.generateRequest();
                    }, 1000);
                }
            },
            _handleGetDatasource: function(e) {
                if (e.detail.response && e.detail.response.result) {
                    var results = JSON.parse(e.detail.response.result);

                    if (this.doScan) {
                        // Scan datasources
                        _.forEach(results, function(datasource) {
                            this.rpcStartScanParams.request.id = datasource.id;
                            this.$.rpcStartScan.body = this.rpcStartScanParams;
                            this.$.rpcStartScan.generateRequest();
                        }.bind(this));
                    } else {
                        // List datasources
                        this.set('datasourceResults', results);
                        this.$.datasourcesList.fire('iron-resize')
                    }
                }
            },
            clearIronList: function() {
                this.set('searchResults', []);
                this.$.searchList.fire('iron-resize');
            },
            setCategory: function(e, detail) {
                this.clearIronList();
                this.set('itemSelected', false);
                this.$.navDrawerPanel.closeDrawer();
                if (e.target.dataset.value === this.categoriesMap.images) {
                    this.setGridView();
                } else {
                    this.setListView();
                }

                if (e.target.dataset.value === this.categoriesMap.videos) {
                    this.set('bigVideoClass', 'big-video');
                } else {
                    this.set('bigVideoClass', '');
                }

                this.refreshView();
                this.set('title', e.target.dataset.value + ' Search');
                this.set('searching', false);

                // depth must be 0 for search
                // When there is no search term and user didn't selected a category, then browse
                this.$.filterConverter.setValues({
                    from: 0,
                    size: this.size,
                    category: e.target.dataset.value,
                    term: '',
                    type: 'file',
                    url: (e.target.dataset.value || this.$.filterConverter.getFilterAsObj().term) ? '' : '/',
                    depth: (e.target.dataset.value || this.$.filterConverter.getFilterAsObj().term) ? 0 : 1
                });
            },
            listDatasources: function(e, detail) {
                this.clearIronList();
                this.set('itemSelected', false);
                this.$.filterConverter.setValue('category', '');
                this.$.navDrawerPanel.closeDrawer();
                this.set('doScan', false);
                this.set('breadcrumbs', []);
                if (this.$.search.input.value) {
                    this.set('datasourceListView', false);
                } else {
                    this.set('datasourceListView', true);
                }
                this.set('bigVideoClass', '');
                this.set('title', 'Kazoup Search');
                this.$.rpcGetDatasources.generateRequest();
            },
            browseDatasource: function(e, detail) {
                this.clearIronList();

                if (this.getDatasourceType(e.model.__data__.item.url) === 'local') {
                    var url = this.getDatasourceUrl(e.model.__data__.item.url);
                    var depth = url.split('/').length;

                    this.$.filterConverter.setValues({
                        term: '',
                        category: '',
                        from: 0,
                        size: this.size,
                        type: 'file',
                        depth: depth,
                        url: '/local' + url
                    });
                }
            },
            browse: function(e, detail) {
                this.clearIronList();
                this.$.filterConverter.setValues({
                    from: 0,
                    size: this.size,
                    type: 'file',
                    url: e.model.__data__.item.url,
                    depth: this.$.filterConverter.getFilterAsObj().term ? 0 : e.model.__data__.item.depth
                });
            },
            search: function(request) {
                if (!this.$.rpcElastic.loading) {
                    this.set('loading', true);
                    this.set('rpcElasticParams', {
                        service: 'go.micro.srv.search',
                        method: 'Search.Search',
                        request: this.$.filterConverter
                          .getFilterAsObj()
                    });
                    this.$.rpcElastic.body = this.rpcElasticParams;
                    this.$.rpcElastic.generateRequest();
                }
            },
            searchAsYouType: function(e, detail) {
                var term = this.$.search.input.value;

                if ((term.length > 2 || term.length === 0) && !this.$.rpcElastic.loading) {
                    clearTimeout(this.searchAsYouTypeTimeout);
                    this.searchAsYouTypeTimeout = setTimeout(function() {
                        this.set('itemSelected', false);
                        this.set('datasourceListView', false);
                        this.clearIronList();

                        this.$.filterConverter.setValues({
                            from: 0,
                            size: this.size,
                            term: term,
                            url: this.$.filterConverter.getFilterAsObj().url ? this.$.filterConverter.getFilterAsObj().url : '',
                            depth: 0,
                            type: 'file'
                        });
                    }.bind(this), 450);
                }
            },
            resetSearch: function(e, detail) {
                var depth;

                this.set('itemSelected', false);
                this.clearIronList();
                this.toggleSearch();

                this.$.filterConverter.setValues({
                    term: '',
                    from: 0,
                    size: this.size,
                    url: '',
                    depth: this.$.filterConverter.getFilterAsObj().category ? 0 : 1,
                    type: '' // By default get files and directories
                });
            },
            toggleSearch: function(e, detail) {
                this.$.search.input.value = this.$.filterConverter.getFilterAsObj().term ?
                  this.$.filterConverter.getFilterAsObj().term : '';
                this.$.search._inputHandler();

                this.async(function() {
                    // Explicity remove all focus from <mat-item>
                    _.forEach(document.querySelectorAll('mat-item'), function(el){
                        el.setAttribute('tabindex', -1);
                    });
                    this.$.search.focus();
                }, 10);
                this.set('searching', !this.searching);
            },
            addDatasourceAndScan: function(e, detail) {
                this.set('doScan', true);
                this.$.rpcAddDatasource.body = {
                    service: 'go.micro.srv.datasource',
                    method: 'DataSource.Create',
                    request: {
                        endpoint: {
                            url: 'local://' + this.homeDirPath
                        }
                    }
                };
                this.$.rpcAddDatasource.generateRequest();
            },
            scanAll: function() {
                this.set('doScan', true);
                this.$.rpcGetDatasources.generateRequest();
            },
            mainAction: function(e, detail) {
                if (e.model.__data__.item.is_dir) {
                    // Browse one level deeper
                    this.clearIronList();
                    this.set('searching', false);

                    this.$.filterConverter.setValues({
                        from: 0,
                        size: this.size,
                        type: 'file',
                        term: '',
                        url: e.model.__data__.item.url,
                        depth: e.model.__data__.item.depth + 1
                    });
                } else {
                    // Detail view
                    this.set('item', e.model.__data__.item);
                    this.set('itemSelected', true);
                    this.$.mainDrawerPanel.openDrawer();

                    if (document.querySelector('video')) {
                        document.querySelector('video').load();
                    }
                    if (document.querySelector('wave-player')){
                        try {
                            document.querySelector('wave-player').wavesurfer.stop();
                        } catch(e) {}
                        document.querySelector('wave-player').deactivateAnimation();
                        document.querySelector('wave-player').updateWavesurfer();
                        document.querySelector('wave-player wave').remove();
                    }
                }
            },
            openFile: function(e) {
                ipcRenderer.send('open-file-message', {
                    url: this.getLocalAsset(this.item.url)
                });
            },
            closeDetails: function(e, detail) {
                this.set('itemSelected', false);
                this.$.mainDrawerPanel.closeDrawer();
            },
            refreshView: function() {
                this.async(function() {
                    this.$.searchList.fire('iron-resize');
                    this.$.searchList.notifyResize();
                    this.$.searchList.scrollToIndex(0);
                }, 1);
            },
            setGridView: function() {
                this.set('view.icon', 'icons:view-list');
                this.$.searchList.setAttribute('grid', '');
                this.set('view.isGrid', true);
            },
            setListView: function() {
                this.set('view.icon', 'icons:view-module');
                this.$.searchList.removeAttribute('grid');
                this.set('view.isGrid', false);
            },
            toggleView: function(e, detail) {
                if (this.view.isGrid) {
                    this.setListView();
                } else {
                    this.setGridView();
                }
                this.refreshView();
            },
            showScanSnack: function(e) {
                this.$.snackbar.label = 'Add your home folder ' + this.homeDirPath + ' to datasources';
                this.$.snackbar.show();
            },
            checkBreadcrumbsView: function(count) {
                this.async(function() {
                    var containerWidth = document.querySelector('.browse').getBoundingClientRect().width;
                    var crumbsWidth = 0;

                    _.forEach(document.querySelectorAll('.browse mat-breadcrumb-step'), function(breadcrumb) {
                        crumbsWidth += breadcrumb.getBoundingClientRect().width
                    });

                    if (crumbsWidth > containerWidth) {
                        // Breadcrumbs does not fit available space, collapse as mobile
                        this.$.noFitBreadcrumbs.style.display = 'block';
                        this.$.fitBreadcrumbs.style.display = 'none';
                    } else {
                        this.$.noFitBreadcrumbs.style.display = 'none';
                        this.$.fitBreadcrumbs.style.display = 'block';
                    }

                    if (crumbsWidth === 0 && count < 3) {
                        this.checkBreadcrumbsView(count);
                    }
                }, 10);
            },
            handleSearchHeader: function(selected) {
                return (selected !== 0);
            }
        });
    }()); 
    </script>
</dom-module>
