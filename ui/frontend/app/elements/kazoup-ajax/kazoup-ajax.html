<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="kazoup-ajax">
  <template>
    <iron-ajax
      id="ironAjax"
      url="[[url]]"
      method="[[method]]"
      handle-as="[[handleas]]"
      on-response="handleResponse"
      on-error="handleError"
      content-type="application/json"
      debounce-duration="300"></iron-ajax>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-ajax',
        properties: {
          url: {
            type: String,
            notify: true
          },
          method: {
            type: String,
            notify: true
          },
          params: {
            type: Object,
            notify: true
          },
          handleas: {
            type: String,
            notify: true
          },
          isAuthorize: {
            type: Boolean,
            notify: true
          }
        },
        ready: function() {
          this.ironAjax = this.$.ironAjax;
          this.paperToast = this.$.paperToast;
        },
        generateRequest: function() {
          this.promise = pinkySwear();

          if (this.isAuthorize) {
            this.ironAjax.headers = {
              Authorization: 'JWT ' + localStorage.getItem('authToken')
            };
          }
          this.ironAjax.generateRequest();

          return this.promise;
        },
        handleResponse: function(e) {
          this.promise(true, [{
            status: e.detail.xhr.status,
            response: e.detail.response
          }]);
        },
        handleError: function(e, error) {
          var redeableError;
          // jshint unused:false
          // API error
          if (e.detail.request.status === 400) {
            this.promise(true, [{
              status: e.detail.request.status,
              response: e.detail.request.xhr.response
            }]);
          // Not authenticated
          } else if (e.detail.request.status === 401) {
            localStorage.removeItem('authToken');
            document.location = '/';
          // Empty response & timeout = 0; likely lost connection
          // Empty response can be retrieved in other request like DELETION
          // but eill be successfull and managed by handleResponse
          } else if (e.detail.request.status === 0 && e.detail.request.xhr.timeout === 0) {
            Polymer.dom(document).querySelector('#paperToast').text = 'Network connection lost';
            Polymer.dom(document).querySelector('#paperToast').show();
          // Other errors
          } else {
            if (e.detail &&
                e.detail.request &&
                e.detail.request.xhr &&
                e.detail.request.xhr.response &&
                e.detail.request.xhr.response.detail) {
              redeableError = e.detail.request.xhr.response.detail;
            } else {
              redeableError = e.detail.error;
            }

            Polymer.dom(document).querySelector('#paperToast').text = redeableError;
            Polymer.dom(document).querySelector('#paperToast').show();
          }

          // Reject if not 400
          this.promise(false, [{
            status: e.detail.request.status,
            response: e.detail.error
          }]);
        },
        setParams: function(params) {
          this.ironAjax.body = JSON.stringify(params);
        },
        setParamsAsObj: function(params) {
          this.ironAjax.body = params;
        }
      });
    }());
  </script>
</dom-module>
