<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="kazoup-analytics-filters">
  <link rel="import" type="css" href="kazoup-analytics-filters.css">

  <template>

    <div id="filters" class$="[[mobileDevice]]">
      <paper-icon-button icon="chevron-left"
                         class="arrow arrow-left"
                         on-tap="translateFilters"
                         data-orientation="left"
                         role="button"
                         hidden$="[[!filtersUI.arrowsVisible]]"></paper-icon-button>

      <div class="filters-box">
        <div class="filters-container">
          <template is="dom-repeat" items="[[filtersArray]]">
            <div class="filter">
              <span class="label">
                <span>[[getDimensionLabel(item.dimension)]]</span>:
                <span>[[analyticsLabel(item.label)]]</span>
                <iron-icon class="cursor-pointer"
                           icon="cancel"
                           on-tap="removeFilter"
                           data-dimension$="{{dimension}}"
                           data-label$="{{label}}"></iron-icon>
              </span>
            </div>
          </template>
        </div>
      </div>

      <paper-icon-button icon="chevron-right"
                         class="arrow arrow-right"
                         on-tap="translateFilters"
                         data-orientation="right"
                         role="button"
                         hidden$="[[!filtersUI.arrowsVisible]]"></paper-icon-button>
    </div>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-analytics-filters',
        behaviors: [
          KazoupBehaviors.Util,
          KazoupBehaviors.Devices
        ],
        properties: {
          target: {
            type: String,
            notify: false
          },
          filtersArray: {
            type: Array,
            notify: true
          },
          filtersUI: {
            type: Object,
            notify: true,
            value: function() {
              return {};
            }
          },
          xTranslation: {
            type: Number,
            notify: false,
            value: 0
          },
          waitForDomReady: {
            type: Number,
            notify: false,
            value: 1000
          },
          mobileDevice: {
            type: Boolean,
            notify: false
          }
        },
        setFiltersWidth: function() {
          var width = 0;

          _.forEach(Polymer.dom(this.root).querySelectorAll('.filters-container .filter'), function(filter) {
            width += Math.ceil(filter.getBoundingClientRect().width + 1);
          }, this);

          this.set('filtersUI.filtersWidth', width);
        },
        setFiltersContainerWidth: function() {
          this.set(
            'filtersUI.containerWidth',
            this.$.filters.querySelector('.filters-box').getBoundingClientRect().width
          );
        },
        getFiltersDimensions: function() {
          Polymer.dom.flush();

          // Dom is not ready
          this.async(function() {
            this.setFiltersContainerWidth();
            this.setFiltersWidth();

            if (this.filtersUI.filtersWidth > this.filtersUI.containerWidth) {
              this.set('filtersUI.arrowsVisible', true);
              Polymer.dom(this.$.filters).classList.remove('fit');
            } else {
              this.set('filtersUI.arrowsVisible', false);
              this.resetFiltersTranslation();
              Polymer.dom(this.$.filters).classList.add('fit');
            }

            // When element loads needs more time to render dom
            this.waitForDomReady = 100;
          }, this.waitForDomReady);
        },
        translateFilters: function(e, detail, sender) {
          var x = 0;

          this.setFiltersContainerWidth();
          this.setFiltersWidth();

          if (this.filtersUI.filtersWidth > this.filtersUI.containerWidth) {
            x = Math.floor(this.filtersUI.containerWidth / 2);

            if (e.currentTarget.dataset.orientation === 'left') {
              this.xTranslation += x;
            } else if (e.currentTarget.dataset.orientation === 'right') {
              this.xTranslation -= x;
            }

            if (this.xTranslation > 0) {
              this.xTranslation = 0;
            } else if (this.xTranslation < -(this.filtersUI.filtersWidth - this.filtersUI.containerWidth)) {
              this.xTranslation = -(this.filtersUI.filtersWidth - this.filtersUI.containerWidth);
            }

            Polymer.dom(this.root).querySelector('.filters-container').style.transform =
              'translate(' + this.xTranslation + 'px, 0)';
          }
        },
        resetFiltersTranslation: function() {
          this.xTranslation = 0;

          Polymer.dom(this.root).querySelector('.filters-container').style.transform =
            'translate(' + this.xTranslation + 'px,0)';
        },
        removeFilter: function(e, detail) {
          // Remove filter on kazoup-d3-charts
          this._d3Charts.removeFilter(e.model.__data__.item);
        },
        _handleFiltersChanged: function(e) {
          this.set('filtersArray', []);

          _.forEach(this._filterConverter.asObj(), function(valuesArray, key) {
            _.forEach(valuesArray, function(value) {
              if (!_.contains([
                  'dirpath',
                  'timestampType',
                  'from',
                  'to',
                  'q',
                  'sort'
                ], key)) {

                this.push('filtersArray', {
                  dimension: key,
                  label: value
                });
              }
            }, this);

            if (key === 'q') {
              this.push('filtersArray', {
                dimension: key,
                label: valuesArray
              });
            }
          }, this);

          this.getFiltersDimensions();
        },
        attached: function() {
          Polymer.dom.flush();

          this.set(
            'mobileDevice',
            this.isMobileDevice().any() ? 'mobile' : ''
          );

          this._d3Charts = Polymer.dom(document)
            .querySelector(this.target).querySelector('kazoup-d3-charts');
          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target).querySelector('#filterConverter');
          this._filterConverter.addEventListener('filters-changed', this._handleFiltersChanged.bind(this));
        }
      });
    }());
  </script>
</dom-module>
