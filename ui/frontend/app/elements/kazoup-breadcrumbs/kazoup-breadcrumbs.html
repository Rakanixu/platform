<dom-module id="kazoup-breadcrumbs">
  <link rel="import" type="css" href="kazoup-breadcrumbs.css">
  <template>
    <div id="crumbs">
      <paper-icon-button icon="home" on-tap="goHome" class="cursor-pointer"></paper-icon-button>

      <iron-selector>
        <template is="dom-repeat" items="[[crumbs]]" as="crumb">
          <li on-tap="_setDirpathFilter"
              on-mouseover="crumbHovered"
              on-mouseout="crumbUnhovered"
              class="label">
            <a disabled class="cursor-pointer">{{crumb.label}}</a>
          </li>
          <iron-icon icon="chevron-right"></iron-icon>
        </template>
      </iron-selector>
    </div>
  </template>
  <script>
    'use strict';

    (function() {
      var font = '14px "Gotham Rounded SSm A"';

      function generateBreadcrumbs() {
        var i = 0;
        var dirpath = this._filterConverter.getValue('dirpath');

        this.set('crumbs', []);

        if (dirpath.length) {
          this.breadcrumbsArray = dirpath[0].substring(2, dirpath[0].length).split('/');

          for (i = 0; i < this.breadcrumbsArray.length; i++) {
            this.push('crumbs', {
              label: this.breadcrumbsArray[i],
              value: '//' + _.slice(this.breadcrumbsArray, 0, i + 1).join('/'),
              width: this.getTextWidth(this.breadcrumbsArray[i], font)
            });
          }

          this.async(function() {
            var maxWidth = Polymer.dom(this.root).querySelector('#crumbs').offsetWidth - 40;
            var totalWidth = 0;

            _.forEach(this.breadcrumbsArray, function(label, index) {
              var width = this.getTextWidth(label, font);

              Polymer.dom(this.root).querySelectorAll('#crumbs li.label')[index].style.width = width + 3 + 'px';
              totalWidth += width + 24;
            }, this);

            if (maxWidth <= totalWidth) {
              this.collapsable = true;
              _.forEach(Polymer.dom(this.root).querySelectorAll('#crumbs li.label'), function(el, index) {
                if (index < this.breadcrumbsArray.length - 1) {
                  Polymer.dom(el).classList.add('collapse');
                } else {
                  Polymer.dom(el).node.style.width = 'auto';
                }
              }, this);
            } else {
              this.collapsable = false;
              _.forEach(Polymer.dom(this.root).querySelectorAll('#crumbs li.label'), function(el) {
                Polymer.dom(el).classList.remove('collapse');
              });
            }
          }, 200);
        }
      }

      Polymer({
        is: 'kazoup-breadcrumbs',
        behaviors: [KazoupBehaviors.Util],
        properties: {
          target: {
            type: String,
            notify: false
          },
          breadcrumbsArray: {
            type: Array,
            notify: false,
            value: function() {
              return [];
            }
          },
          collapsable: {
            type: Boolean,
            notify: false,
            value: true
          },
          crumbs: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          }
        },
        crumbHovered: function(e, detail) {
          var index = e.model.__data__.index;

          if (index < this.crumbs.length - 1 && this.collapsable) {
            Polymer.dom(Polymer.dom(this.root).querySelectorAll('html /deep/ #crumbs li.label')[index])
              .classList.remove('collapse');
          }
        },
        crumbUnhovered: function(e, detail) {
          var index = e.model.__data__.index;

          if (index < this.crumbs.length - 1 && this.collapsable) {
            Polymer.dom(Polymer.dom(this.root).querySelectorAll('html /deep/ #crumbs li.label')[index])
              .classList.add('collapse');
          }
        },
        _setDirpathFilter: function(e, detail) {
          var crumb = e.model.__data__.crumb;

          if (crumb.value.length > 2) {
            this._filterConverter.setValue('dirpath', crumb.value);
          } else {
            this._filterConverter.setValue('dirpath');
          }
        },
        _setBreadcrumbs: function(event) {
          if (event && !_.isEmpty(event.detail)) {
            _.forEach(event.detail.fieldsChanged, function(filter) {
              if (filter.field === 'dirpath') {
                generateBreadcrumbs.call(this);
                return;
              }
            }, this);
          } else {
            generateBreadcrumbs.call(this);
          }
        },
        goHome: function() {
          this.crumbs = [];
          this._filterConverter.setValue('dirpath');
        },
        attached: function() {
          Polymer.dom.flush();

          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
          this._filterConverter.addEventListener('filters-changed', this._setBreadcrumbs.bind(this));
        }
      });
    }());
  </script>
</dom-module>
