<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel='import' href='../../bower_components/lib-d3/lib-d3.html'>
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">
<link rel="import" href="../kazoup-mini-chart/kazoup-mini-chart.html">
<link rel="import" href="../kazoup-ajax/kazoup-ajax.html">

<dom-module id="kazoup-dashboard">
  <link rel="import" type="css" href="kazoup-dashboard.css">

  <template>
    <paper-toolbar class="medium-tall">
      <paper-icon-button icon="menu" on-tap="openDrawerPanel"></paper-icon-button>

      <div class="title">Dashboard</div>
      <paper-progress id="progressBar"
                      class="middle fit"
                      hidden$="[[dataLoaded]]"
                      indeterminate></paper-progress>
    </paper-toolbar>

    <div class="container box vertical layout center-justified">
      <neon-animated-pages id="neonPages"
                           class="fit"
                           entry-animation="fade-in-animation"
                           exit-animation="fade-out-animation"
                           selected="0">
        <neon-animatable>
          <template is="dom-if" if="{{!applianceIsConfigured}}">
            <kazoup-empty-state
              icon="settings"
              header="To get started"
              description="<span>Just point Kazoup at your network and data.
              Start analyzing by configuring your </span><a href='/settings?section=sources'> data sources</a>
              <span> and </span><a href='/settings?section=conf'>network access</a>
              <span> in Settings.</span>"></kazoup-empty-state>
          </template>

          <template is="dom-if" if="{{applianceIsConfigured}}">
            <div class="chip-container">

              <template is="dom-repeat" items="[[items]]" sort="sortByPriority">
                <div class="chip" on-tap="toggleCard" >
                  <div class="chip-top">
                    <div class="colour-header" style$="background:{{item.color}};"></div>
                    <div class="flex vertical layout center center-justified">
                      <div class="background-icon" style$="background-image: url('{{item.iconPath}}')"></div>
                        <span>
                          <span class="text">{{item.value}}</span>
                          <span class="sub-text">{{item.valueInfo}}</span>
                        </span>
                    </div>
                  </div>
                  <div class="chip-bottom">
                    <div class="chip-label-title primary-text-color">{{item.label}}</div>
                  </div>
                  <paper-ripple class="light-background"></paper-ripple>
                </div>
              </template>

            </div>
          </template>
        </neon-animatable>

        <neon-animatable>
          <div class="card">
            <div class="heading primary-color-text horizontal layout" style$="background:{{selectedCard.color}};">
              <span class="flex">{{selectedCard.detailedLabel}}</span>
              <paper-icon-button class="close cursor-pointer"
                                 on-tap="toggleCard"
                                 icon="icons:highlight-off"></paper-icon-button>

            </div>
            <paper-progress hidden$="[[dataChartLoaded]]" indeterminate></paper-progress>
            <div class="chart">
              <kazoup-mini-chart
                id="miniChart"
                options="[[selectedCard.options]]"
                data-chart="[[selectedCard.data]]"
                type="[[selectedCard.type]]"
                label-text="[[selectedCard.label]]"
                label-value="[[selectedCard.value]]"
                label-value-info="[[selectedCard.valueInfo]]"></kazoup-mini-chart>
            </div>
          </div>
        </neon-animatable>
      </neon-animated-pages>
    </div>

    <kazoup-ajax id="accessedPastYear"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="totalFileSizeAndCount"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="archiveSize"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="nextYearSize"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="topShare"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="topFileCategory"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="duplicates"
                 method="POST"
                 url="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="searchStatistics"
                 method="POST"
                 url="[[endpointList.ESAuditTrail]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="elasticSearchQuery"
                 method="POST"
                 url$="[[endpointList.ESFiles]]"
                 handleas="json"
                 is-authorize="true"></kazoup-ajax>

    <iron-media-query query="max-width: 1024px"
                      query-matches="{{tabletScreen}}"></iron-media-query>
    <iron-media-query query="max-width: 360px"
                      query-matches="{{phoneScreen}}"></iron-media-query>

  </template>
  <script>
    'use strict';

    (function () {
      Polymer({
        is: 'kazoup-dashboard',
        behaviors: [
          KazoupBehaviors.PanelActions,
          KazoupBehaviors.APIUrls
        ],
        properties: {
          dataLoaded: {
            type: Boolean,
            notify: false,
            value: false
          },
          dataLoadedCounter: {
            type: Number,
            notify: true,
            value: 0,
            observer: 'dataLoadedCounterChanged'
          },
          applianceIsConfigured: {
            type: Boolean,
            notify: true,
            value: function() {
              // At init time, this is likely to be undefined (race condition),
              // see config-ready listener on attached callback
              return Kazoup.SharedData.config.APPLIANCE_IS_CONFIGURED;
            }
          },
          items: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          selectedCard: {
            type: Object,
            notify: true,
            value: function() {
              return {};
            }
          }
        },
        dataLoadedCounterChanged: function() {
          if (this.dataLoadedCounter >= 8) {
            this.dataLoaded = true;
          } else {
            this.dataLoaded = false;
          }
        },
        loadCards: function() {
          if (this.applianceIsConfigured) {
            this.dataLoaded = false;

            this.makeCardsRequest();
          } else {
            this.dataLoaded = true;
          }
        },
        makeCardsRequest: function() {
          this.set('items', []);

          this.$.accessedPastYear.setParamsAsObj(ElasticSearch.queries.accessedPastYearDashboard);
          this.$.accessedPastYear.generateRequest().then(
            this.accessedPastYearCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.totalFileSizeAndCount.setParamsAsObj(ElasticSearch.queries.totalFileSizeAndCountDashboard);
          this.$.totalFileSizeAndCount.generateRequest().then(
            this.totalFileSizeAndCountCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.archiveSize.setParamsAsObj(ElasticSearch.queries.archiveSizeDashboard);
          this.$.archiveSize.generateRequest().then(
            this.archiveSizeCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.nextYearSize.setParamsAsObj(ElasticSearch.queries.nextYearSizeDashboard);
          this.$.nextYearSize.generateRequest().then(
            this.nextYearSizeCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.topShare.setParamsAsObj(ElasticSearch.queries.topShareDashboard);
          this.$.topShare.generateRequest().then(
            this.topShareCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.topFileCategory.setParamsAsObj(ElasticSearch.queries.topFileCategoryDashboard);
          this.$.topFileCategory.generateRequest().then(
            this.topFileCategoryCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.duplicates.setParamsAsObj(ElasticSearch.queries.duplicatesDashboard);
          this.$.duplicates.generateRequest().then(
            this.duplicatesCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);

          this.$.searchStatistics.setParamsAsObj(ElasticSearch.queries.searchStatisticsCount);
          this.$.searchStatistics.generateRequest().then(
            this.searchStatisticsCallback.bind(this),
            this.onError.bind(this)
          ).bind(this);
        },
        onError: function() {
          this.dataLoadedCounter++;
        },
        accessedPastYearCallback: function(e) {
          var accessedPastYearSize = 0;
          if (e.response.aggregations.total_size.value) {
            accessedPastYearSize = e.response.aggregations.total_size.value;
          }
          accessedPastYearSize = filesize(accessedPastYearSize).split(' ');

          if (parseFloat(accessedPastYearSize[0]) <= 0) {
            accessedPastYearSize[0] = 'None';
            accessedPastYearSize[1] = '';
          } else {
            accessedPastYearSize[0] = this.toFixedTwoDecimals(accessedPastYearSize[0]);
          }

          this.push('items', {
            priority: 2,
            label: 'Accessed past year',
            detailedLabel: 'Files accessed last year by type',
            value: accessedPastYearSize[0],
            valueInfo: accessedPastYearSize[1],
            color: '#972ff8',
            iconPath: '/static/images/accessed-last-year.svg',
            data: undefined,
            type: 'renderPieChart',
            options: {
              elasticSearchEndpoint: 'files'
            },
            query: ElasticSearch.queries.accessedPastYear
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        totalFileSizeAndCountCallback: function(e) {
          var totalSize = 0;
          if (e.response.aggregations.total_size.sum) {
            totalSize = e.response.aggregations.total_size.sum;
          }
          totalSize = filesize(totalSize).split(' ');

          if (parseFloat(totalSize[0]) <= 0) {
            totalSize[0] = 'None';
            totalSize[1] = '';
          } else {
            totalSize[0] = this.toFixedTwoDecimals(totalSize[0]);
          }

          this.push('items', {
            priority: 1,
            label: 'Total file size',
            detailedLabel: 'Total file size by year',
            value: totalSize[0],
            valueInfo: totalSize[1],
            color: '#FDA43A',
            iconPath: '/static/images/total-file-size.svg',
            data: undefined,
            type: 'renderBarChart',
            options: {
              elasticSearchEndpoint: 'files',
              yAxis: 'size'
            },
            query: ElasticSearch.queries.totalFileSize
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          var totalCount = 0;
          if(e.response.aggregations.total_size.count) {
            totalCount = e.response.aggregations.total_size.count;
          }

          this.push('items', {
            priority: 9,
            label: 'Total number of files',
            detailedLabel: 'Total number of files by modified time',
            value: totalCount,
            valueInfo: 'Files',
            color: '#2CB3D8',
            iconPath: '/static/images/total-number-of-files.svg',
            data: undefined,
            type: 'renderBarChart',
            options: {
              elasticSearchEndpoint: 'files',
              yAxis: 'numberOfFiles'
            },
            query: ElasticSearch.queries.totalNumberOfFiles
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        archiveSizeCallback: function(e) {
          var archiveSize = 0;
          if (e.response.aggregations.total_size.sum) {
            archiveSize = e.response.aggregations.total_size.sum;
          }
          archiveSize = filesize(archiveSize).split(' ');

          if (parseFloat(archiveSize[0]) <= 0) {
            archiveSize[0] = 'None';
            archiveSize[1] = '';
          } else {
            archiveSize[0] = this.toFixedTwoDecimals(archiveSize[0]);
          }

          this.push('items', {
            priority: 7,
            label: 'Archive size',
            detailedLabel: 'Archived file size by year',
            value: archiveSize[0],
            valueInfo: archiveSize[1],
            color: '#7dd6fe',
            iconPath: '/static/images/archive-size.svg',
            data: undefined,
            type: 'renderBarChart',
            options: {
              elasticSearchEndpoint: 'files',
              yAxis: 'size'
            },
            query: ElasticSearch.queries.archiveSize
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        nextYearSizeCallback: function(e) {
          var dataInThePast = {};
          var growthRate = 0;
          var nextYearSize = 0;

          _.forEach(e.response.aggregations.buckets.buckets, function(bucket) {
            dataInThePast[bucket.key] = bucket.total_size.value;
          });

          for (var i = 3; i > 0; i--) {
            if (dataInThePast['all_data_except_last_' + i + '_year'] &&
              dataInThePast['all_data_except_last_' + i + '_year'] !== 0) {
              growthRate = this.growthRate(
                dataInThePast['all_data_except_last_' + i + '_year'],
                dataInThePast.all_data,
                i
              );
              break;
            }
          }

          nextYearSize = filesize((dataInThePast.all_data * growthRate) + dataInThePast.all_data).split(' ');

          if (parseFloat(nextYearSize[0]) <= 0) {
            nextYearSize[0] = 'None';
            nextYearSize[1] = '';
          } else {
            nextYearSize[0] = this.toFixedTwoDecimals(nextYearSize[0]);
          }

          this.push('items', {
            priority: 3,
            label: 'Next year size',
            detailedLabel: 'Data storage growth prediction',
            value: nextYearSize[0],
            valueInfo: nextYearSize[1],
            color: '#EA4A3E',
            iconPath: '/static/images/next-year-size.svg',
            data: undefined,
            type: 'renderLineChart',
            options: {
              elasticSearchEndpoint: 'files',
              accumulateXAxisValues: true,
              yAxis: 'size',
              prediction: true,
              predictedValue: (dataInThePast.all_data * growthRate) + dataInThePast.all_data
            },
            query: ElasticSearch.queries.nextYearSize
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        topShareCallback: function(e) {
          var share = 'None';
          if (e.response.aggregations.top_shares.buckets.length &&
            e.response.aggregations.top_shares.buckets[0].key) {
            share = e.response.aggregations.top_shares.buckets[0].key.split('/');

            if (!share[share.length - 1]) {
              share.pop();
            }
            share = share[share.length - 1];
          }

          this.push('items', {
            priority: 5,
            label: 'Top share',
            detailedLabel: 'Top shares by size',
            value: share,
            valueInfo: '',
            color: '#4FE3C2',
            iconPath: '/static/images/top-share.svg',
            data: undefined,
            type: 'renderPieChart',
            options: {
              elasticSearchEndpoint: 'files'
            },
            query: ElasticSearch.queries.topShare
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        topFileCategoryCallback: function(e) {
          var topCategory = 'None';
          if (e.response.aggregations.top_categories.buckets.length &&
            e.response.aggregations.top_categories.buckets[0].key) {
            topCategory = e.response.aggregations.top_categories.buckets[0].key;
          }

          this.push('items', {
            priority: 6,
            label: 'Top file category',
            detailedLabel: 'Top 10 file categories by size',
            value: topCategory,
            valueInfo: '',
            color: '#8983F2',
            iconPath: '/static/images/top-file-category.svg',
            data: undefined,
            type: 'renderRadarChart',
            options: {
              elasticSearchEndpoint: 'files',
              yAxis: 'size'
            },
            query: ElasticSearch.queries.topFileCategory
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        duplicatesCallback: function(e) {
          var duplicates = 0;
          if (e.response.aggregations.known.buckets.length &&
            e.response.aggregations.known.buckets[0].total_size.value) {
            duplicates = e.response.aggregations.known.buckets[0].total_size.value;
          }
          duplicates = filesize(duplicates).split(' ');

          if (parseFloat(duplicates[0]) <= 0) {
            duplicates[0] = 'None';
            duplicates[1] = '';
          } else {
            duplicates[0] = this.toFixedTwoDecimals(duplicates[0]);
          }

          this.push('items', {
            priority: 4,
            label: 'Duplicates',
            detailedLabel: 'Duplicates by type',
            value: duplicates[0],
            valueInfo: duplicates[1],
            color: '#73CF43',
            iconPath: '/static/images/local-file-size.svg',
            data: undefined,
            type: 'renderPieChart',
            options: {
              elasticSearchEndpoint: 'files'
            },
            query: ElasticSearch.queries.duplicates
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        searchStatisticsCallback: function(e) {
          var searchCount = 'None';
          if (e.response.hits && parseInt(e.response.hits.total)) {
            searchCount = parseInt(e.response.hits.total);
          }

          this.push('items', {
            priority: 8,
            label: 'Search queries last 30 days',
            detailedLabel: 'Search queries last 30 days',
            value: searchCount,
            valueInfo: '',
            color: '#17A085',
            iconPath: '/static/images/number-of-searches.svg',
            data: undefined,
            type: 'renderBarChart',
            options: {
              elasticSearchEndpoint: 'audit-trail',
              yAxis: 'numberOfSearch'
            },
            query: ElasticSearch.queries.searchStatistics
          });
          this.notifyPath('items.' + this.items.length -1, this.items[this.items.length - 1]);

          this.dataLoadedCounter++;
        },
        transformDataFormat: function(data, entity) {
          var i = 0;
          var type = entity.type;
          var label = entity.label;
          var description = entity.description;
          var options = entity.options;
          var formattedData = null;
          var acumulateValue = 0;
          var monthNames = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December'
          ];
          var colourGenerator = d3.scale.category20().range([
            '#1EB3DA', '#99CDDA', '#3A424E', '#7D8EA8', '#5D6575',
            '#A8A8A8', '#ED4937', '#FFA499', '#FFA528', '#FFD8A3',
            '#46E4C2', '#B2EDE0', '#70D137', '#C4F0AA', '#00A185',
            '#6CD4C1', '#8980F5', '#CFCBF5', '#F5E663', '#F5F0C4'
          ]);

          if (data && data.aggregations) {
            var field = null;
            for (var attr in data.aggregations) {
              field = attr;
            }
            data = data.aggregations[field].buckets;
          } else if (data && data.facets) {
            data = data.facets.modified.entries;
          }

          if (type === 'renderLineChart' || type === 'renderBarChart' || type === 'renderRadarChart') {
            formattedData = {
              labels: [],
              datasets: [{
                label: description,
                fillColor: this.hexToRgba(entity.color, 0.2),
                strokeColor: this.hexToRgba(entity.color, 0.6),
                highlightFill: entity.color,
                highlightStroke: entity.color,
                data: []
              }]
            };

            for (i = 0; i < data.length; i++) {
              if (options.yAxis === 'numberOfSearch') {
                label = new Date(data[i].key);
                label = label.getUTCDate() + ' ' +  monthNames[label.getUTCMonth()];
                acumulateValue = data[i].doc_count;
              } else {
                if (!_.isNaN(parseInt(data[i].key))) {
                  label = new Date(data[i].key).getUTCFullYear();
                } else {
                  label = data[i].key;
                }

                if (options.accumulateXAxisValues === true) {
                  if (options.yAxis === 'size') {
                    acumulateValue += data[i].total_size.value;
                  } else if (options.yAxis === 'numberOfFiles') {
                    acumulateValue += data[i].doc_count;
                  }
                } else if (options.yAxis === 'size') {
                  acumulateValue = data[i].total_size.value;
                } else if (options.yAxis === 'numberOfFiles') {
                  acumulateValue = data[i].doc_count;
                }
              }

              formattedData.labels.push(label);
              formattedData.datasets[0].data.push(acumulateValue);
            }

            if (options.prediction === true) {
              formattedData.labels.push(ElasticSearch.utils.getDateByMonthsAgo(-12).getUTCFullYear());
              formattedData.datasets[0].data.push(options.predictedValue);
            }
          } else if (type === 'renderPieChart') {
            formattedData = [];

            for (i = 0; i < data.length; i++) {
              // Filter removes empty strings from Array
              var keys = data[i].key.split('/').filter(Boolean);
              var labelValue = filesize(data[i].total_size.value).split(' ');

              formattedData.push({
                value: data[i].total_size.value,
                color: colourGenerator(i),
                highlight: colourGenerator(i),
                label: keys[keys.length -1] + ' ' + parseFloat(labelValue[0]).toFixed(2) + ' ' + labelValue[1]
              });
            }
          }

          return formattedData;
        },
        growthRate: function(previous, current, periods) {
          // http://www.wikihow.com/Calculate-Growth-Rate

          return Math.pow((current / previous), (1 / periods)) - 1;
        },
        toFixedTwoDecimals: function(val) {
          val = parseFloat(val);
          val = +val.toFixed(2);

          return val;
        },
        sortByPriority: function (obj1, obj2) {
          if(obj1.priority < obj2.priority) {
            return -1;
          }
          if(obj1.priority > obj2.priority) {
            return 1;
          }
          return 0;
        },
        hexToRgba: function(hex, opacity) {
          hex = hex.replace('#','');
          var r = parseInt(hex.substring(0,2), 16);
          var g = parseInt(hex.substring(2,4), 16);
          var b = parseInt(hex.substring(4,6), 16);

          return 'rgba(' + r + ',' + g + ',' + b + ',' + opacity + ')';
        },
        toggleCard: function(e, detail) {
          var page = parseInt(this.$.neonPages.selected);

          if (!this.phoneScreen) {
            if (page === 0) {
              this.set('selectedCard', e.model.__data__.item);

              // Get data if not available
              if (this.selectedCard.data === undefined) {
                this.set('dataChartLoaded', false);
                this.$.elasticSearchQuery.setParamsAsObj(this.selectedCard.query);
                this.$.elasticSearchQuery.generateRequest().then(
                  function(e) {
                    this.selectedCard.data = this.transformDataFormat(e.response, this.selectedCard);
                    this.notifyPath('selectedCard.data', this.selectedCard.data);
                    this.set('dataChartLoaded', true);
                  }.bind(this)
                ).bind(this);
              } else {
                this.set('dataChartLoaded', true);
              }

              this.$.neonPages.selected = 1;
            } else if (page === 1) {
              this.$.neonPages.selected = 0;
            }
          }
        },
        attached: function() {
          Polymer.dom.flush();

/*          window.addEventListener('kazoup-dashboard-initialized', function() {
            if (Kazoup.SharedData.currentUser.group_name !== 'user') {
              this.applianceIsConfigured = Kazoup.SharedData.config.APPLIANCE_IS_CONFIGURED;
              this.loadCards();
            }
          }.bind(this));*/
          // TODO: clean up and integrate properly when user srv/api is done
          this.applianceIsConfigured = true;
          this.loadCards();

        }
      });
    }());
  </script>
</dom-module>
