<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel='import' href='../../bower_components/paper-date-picker/paper-date-picker.html'>
<link rel="import" href="../kazoup-moment-duration-import/kazoup-moment-duration-import.html">

<dom-module id="kazoup-date-picker">
  <link rel="stylesheet" href="kazoup-date-picker.css">

  <template>

    <paper-dialog id="kazoupDatePickerDialog"
                  class="paper-date-picker-dialog"
                  entry-animation="scale-up-animation"
                  exit-animation="scale-down-animation"
                  class$="[[mobileDevice]]"
                  with-backdrop>
      <paper-dialog-scrollable>
        <paper-date-picker id="pickerFromDate"
                           force-narrow="true"
                           min-date="[[fromDateMin]]"
                           max-date="[[fromDateMax]]"
                           date="{{fromDate}}"></paper-date-picker>

        <paper-date-picker id="pickerToDate"
                           force-narrow="true"
                           min-date="[[toDateMin]]"
                           max-date="[[toDateMax]]"
                           date="{{toDate}}"></paper-date-picker>

        <div class="buttons-container">
          <paper-toggle-button id="dateType"
                               checked$="{{dateType.value}}">[[dateType.label]]</paper-toggle-button>

          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button on-tap="submitDates" dialog-confirm>OK</paper-button>
        </div>


        <div class="header-decorator vertical layout">
          <iron-icon icon="icons:radio-button-unchecked"></iron-icon>
          <iron-icon icon="icons:more-vert"></iron-icon>
          <iron-icon icon="icons:radio-button-unchecked"></iron-icon>
        </div>
      </paper-dialog-scrollable>
    </paper-dialog>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-date-picker',
        behaviors: [
          KazoupBehaviors.Util,
          KazoupBehaviors.Devices
        ],
        properties: {
          target: {
            type: String,
            notify: false
          },
          dateRangeData: {
            type: Array,
            notify: true,
            observer: 'dateRangeDataChanged'
          },
          period: {
            type: String,
            notify: true
          },
          dateType: {
            type: Object,
            notify: true,
            value: function() {
              return {
                label: 'Relative range',
                value: true
              };
            }
          },
          fromDate: {
            type: Date,
            notify: true,
            observer: 'fromDateChanged'
          },
          toDate: {
            type: Date,
            notify: true,
            observer: 'toDateChanged'
          },
          fromDateMin: {
            type: Date,
            notify: false
          },
          fromDateMax: {
            type: Date,
            notify: false
          },
          toDateMin: {
            type: Date,
            notify: false
          },
          toDateMax: {
            type: Date,
            notify: false
          }
        },
        dateRangeDataChanged: function() {
          var from = this._filterConverter.getValue('from');
          var to = this._filterConverter.getValue('to');
          var today = new Date().getTime();

          if (typeof from === 'number' && typeof to === 'number') {
            this.set('fromDate', new Date(from));
            this.set('toDate', new Date(new Date(to).setHours(0, 0, 0, 0)));

            this.set('dateType.value', false);
            this.set('dateType.label', 'Absolute range');
          } else if (typeof from === 'string' && typeof to === 'string') {
            from = parseInt(from.replace('now-', '').replace('d/d', '') ,10);
            to = parseInt(to.replace('now-', '').replace('d/d', '') ,10);

            this.set('fromDate', new Date(new Date(today - (from * 1000 * 60 * 60 * 24)).setHours(0, 0, 0, 0)));
            this.set('toDate', new Date(new Date(today - (to * 1000 * 60 * 60 * 24)).setHours(0, 0, 0, 0)));

            this.set('dateType.value', true);
            this.set('dateType.label', 'Relative range');
          } else if (!from && !to) {
            if (this.dateRangeData && this.dateRangeData.length) {
              this.set('fromDate', new Date(this.dateRangeData[0]));
              this.set('toDate', new Date(new Date().setHours(0, 0, 0, 0)));
            }
          }

          this.set('fromDateMin', new Date(this.dateRangeData[0]));
          this.set('toDateMax', new Date());
        },
        fromDateChanged: function() {
          if (this.fromDate) {
            // Ensure range correctness
            this.set('toDateMin', new Date(this.fromDate));
          }
        },
        toDateChanged: function() {
          if (this.toDate) {
            // Ensure range correctness
            this.set('fromDateMax', new Date(this.toDate));
          }
        },
        openDialog: function() {
          this.$.kazoupDatePickerDialog.open();

          // From date active by default
          this.toggleActiveDatePicker('pickerFromDate', 'pickerToDate');
        },
        submitDates: function() {
          var from, to;

          if (this.dateType.value) { //Relative
            from = this.generateRelativeDate(this.fromDate);
            to = this.generateRelativeDate(this.toDate);
          } else { // Absolute
            from = new Date(this.fromDate).getTime();
            to = new Date(this.toDate).getTime();
          }

          if (new Date(this.toDate).getTime() - new Date(this.fromDate).getTime() <= 1000 * 60 * 60 * 24 * 365) {
            this.set('period', 'month');
            //this._filterConverter.setValue('period', 'month');
          } else {
            this.set('period', 'year');
            //this._filterConverter.setValue('period', 'year');
          }

          this._filterConverter.setValues([
            {field: 'from', val: from},
            {field: 'to', val: to}
          ]);
        },
        toggleActiveDatePicker: function(activeRef, unactiveRef) {
          // Toggle from background / foreground the active one
          this.$[activeRef].querySelector('#pages').style['z-index'] = 9999;
          this.$[activeRef].querySelector('#pages').style.display = 'flex';
          this.$[unactiveRef].querySelector('#pages').style['z-index'] = 0;
          this.$[unactiveRef].querySelector('#pages').style.display = 'none';
        },
        _handleFromDateActive: function(e) {
          this.toggleActiveDatePicker('pickerFromDate', 'pickerToDate', e);
        },
        _handleToDateActive: function(e) {
          this.toggleActiveDatePicker('pickerToDate', 'pickerFromDate', e);
        },
        _forcePickerRefresh: function(e) {
          // This force a refresh to picker element
          // it is required for updating correctly minDate and maxDate.
          // If not, those values are not updated and user is able to select invalid
          // or useless time ranges, also reset calendar pagination to show current selected date
          this.async(function() {
            this.$.pickerFromDate._tapHeadingYear();
            this.$.pickerFromDate._tapHeadingDate();
            this.$.pickerToDate._tapHeadingYear();
            this.$.pickerToDate._tapHeadingDate();
          }, 1);
        },
        _handleDateTypeChanged: function(e) {
          if (e.target && e.target.checked) {
            this.set('dateType.label', 'Relative range');
            this.set('dateType.value', true);
          } else if (e.target && !e.target.checked) {
            this.set('dateType.label', 'Absolute range');
            this.set('dateType.value', false);
          }
        },
        attached: function() {
          Polymer.dom.flush();

          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');

          if (this.isMobileDevice().any()) {
            this.$.kazoupDatePickerDialog.classList.add('mobile-device');
          }

          this.$.pickerFromDate.querySelector('#datePicker #heading')
            .addEventListener('tap', this._handleFromDateActive.bind(this));
          this.$.pickerToDate.querySelector('#datePicker #heading')
            .addEventListener('tap', this._handleToDateActive.bind(this));
          this.$.pickerFromDate.querySelector('#datePicker #heading .date')
            .addEventListener('tap', this._forcePickerRefresh.bind(this));
          this.$.pickerToDate.querySelector('#datePicker #heading .date')
            .addEventListener('tap', this._forcePickerRefresh.bind(this));
          this.$.dateType.addEventListener('change', this._handleDateTypeChanged.bind(this));
        }
      });
    }());
  </script>
</dom-module>
