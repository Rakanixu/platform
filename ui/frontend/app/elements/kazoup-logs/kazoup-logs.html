<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../kazoup-ajax/kazoup-ajax.html">
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">

<dom-module id="kazoup-logs">
  <link rel="import" type="css" href="kazoup-logs.css">

  <template>

    <neon-animated-pages id="neonPages"
                         class="fit"
                         entry-animation="fade-in-animation"
                         exit-animation="fade-out-animation"
                         selected="0">

      <neon-animatable>
        <paper-toolbar class="medium-tall fit">
          <paper-icon-button icon="menu" on-tap="openDrawerPanel" paper-drawer-toggle></paper-icon-button>
          <div class="horizontal layout flex search">
            <div class="search-box horizontal layout flex">
              <iron-icon icon="search"></iron-icon>
              <input id="searchInput"
                     class="flex"
                     is="iron-input"
                     placeholder="Search logs"
                     bind-value="{{q}}">
              <paper-ripple class="light-background"></paper-ripple>
            </div>
            <div>
              <paper-icon-button id="download-icon"
                                 class="cursor-pointer"
                                 icon="icons:file-download"
                                 on-tap="generateCSV"></paper-icon-button>
              <paper-tooltip for="download-icon"
                             animation-delay="100"
                             position="left">Generate CSV</paper-tooltip>
            </div>
            <div>
              <paper-icon-button id="calendar-icon"
                                 class="cursor-pointer"
                                 src="/static/images/calendar-icon.svg"
                                 on-tap="openDropdown"></paper-icon-button>
              <paper-tooltip for="calendar-icon"
                             animation-delay="100"
                             position="left">Set a time range</paper-tooltip>

              <iron-dropdown id="dropdown"
                             open-animation-config="[[openDropdownAnimation]]"
                             close-animation-config="[[closeDropdownAnimation]]"
                             horizontal-align="right"
                             vertical-align="top">
                <div class="dropdown-content">
                  <paper-item on-tap="setTimeRange" data-value="hour">Last hour
                    <paper-ripple class="light-background"></paper-ripple>
                  </paper-item>
                  <paper-item on-tap="setTimeRange" data-value="day">Last day
                    <paper-ripple class="light-background"></paper-ripple>
                  </paper-item>
                  <paper-item on-tap="setTimeRange" data-value="week">Last week
                    <paper-ripple class="light-background"></paper-ripple>
                  </paper-item>
                  <paper-item on-tap="setTimeRange" data-value="all">All
                    <paper-ripple class="light-background"></paper-ripple>
                  </paper-item>
                </div>
              </iron-dropdown>
            </div>
          </div>

          <paper-tabs class="middle horizontal layout" selected="[[selectedTab]]"scrollable>
            <paper-tab data-category="*"
                       on-tap="filterByCategory"
                       class="flex" active>ALL</paper-tab>
            <paper-tab data-category="Authentication"
                       on-tap="filterByCategory"
                       class="flex">AUTHENTICATION</paper-tab>
            <paper-tab data-category="Scan"
                       on-tap="filterByCategory"
                       class="flex">SCAN</paper-tab>
            <paper-tab data-category="Search"
                       on-tap="filterByCategory"
                       class="flex">SEARCH</paper-tab>
            <paper-tab data-category="Configuration"
                       on-tap="filterByCategory"
                       class="flex">CONFIGURATION</paper-tab>
          </paper-tabs>

          <paper-progress id="progressBar"
                          class="middle fit"
                          hidden$="[[!requestInProgress]]"
                          indeterminate></paper-progress>
        </paper-toolbar>

        <div class="container box vertical layout center-justified">
          <kazoup-empty-state icon="search"
                              header="Nope, nothing. Nada."
                              description="<span>Try another search.</span>"
                              hidden$="[[availableResults]]"></kazoup-empty-state>

          <iron-list id="list" items="[[logResults]]" as="item">
            <template>
              <div class="horizontal layout row">
                <div class="log-icon">
                  <iron-icon icon="[[getIcon(item._source.level)]]"
                             class$="[[getIcon(item._source.level)]]"></iron-icon>
                </div>
                <div class="vertical layout flex">
                  <h4>[[item._source.message]]</h4>
                  <p>[[timestampToHumanTime(item._source.timestamp)]]</p>
                </div>
              </div>
            </template>
          </iron-list>
        </div>

      </neon-animatable>
    </neon-animated-pages>

    <kazoup-ajax id="auditTrail"
                 method="POST"
                 url="[[endpointList.ESAuditTrail]]"
                 is-authorize="true"
                 handle-as="json"></kazoup-ajax>

    <iron-a11y-keys keys="enter"
                    target="[[searchInputTarget]]"
                    on-keys-pressed="search"></iron-a11y-keys>
    <iron-media-query query="max-width: 1024px"
                      query-matches="{{phoneScreen}}"></iron-media-query>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-logs',
        behaviors: [
          KazoupBehaviors.PanelActions,
          KazoupBehaviors.Util,
          KazoupBehaviors.Devices,
          KazoupBehaviors.CustomAnimations,
          KazoupBehaviors.APIUrls
        ],
        properties: {
          searchInputTarget: {
            type: Object,
            notify: false,
            value: function() {
              return this.$.searchInput;
            }
          },
          q: {
            type: String,
            notify: true,
            value: ''
          },
          from: {
            type: Number,
            notify: false,
            value: 0
          },
          requestInProgress: {
            type: Boolean,
            notify: true,
            value: false
          },
          scroll: {
            type: Number,
            notify: true,
            observer: 'scrollChanged'
          },
          category: {
            type: String,
            notify: true,
            value: '*',
            observer: 'categoryChanged'
          },
          categoryMap: {
            type: Array,
            notify: false,
            value: function() {
              return [
                '*',
                'Authentication',
                'Scan',
                'Search',
                'Configuration'
              ];
            }
          },
          logResults: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          availableResults: {
            type: Boolean,
            notify: true,
            value: true
          },
          fromDate: {
            type: String,
            notify: false
          },
          toDate: {
            type: String,
            notify: false
          },
          selectedTab: {
            type: Number,
            notify: false,
            value: 0
          }
        },
        categoryChanged: function(newVal, oldVal) {
          if (oldVal !== undefined) {
            this.getLogs();
          }
        },
        scrollChanged: function(newVal, oldVal) {
          if (oldVal) {
            this.set('requestInProgress', true);
            this.set('from', this.from + 20);
            this.$.auditTrail.setParamsAsObj(this.getElasticParams());
            this.$.auditTrail.generateRequest().then(this._handleLogs.bind(this));
          }
        },
        generateCSV: function(e, detail) {
          var csvWorker = new Worker('/scripts/workers/generate-csv.js');
          var params = JSON.parse(this.getElasticParams());

          params.from = 0;
          params.size = 1000;

          Polymer.dom(document).querySelector('#paperToast').text = 'Generating CSV file';
          Polymer.dom(document).querySelector('#paperToast').show();

          csvWorker.postMessage({
            params: params,
            type: 'logs',
            url: this.endpointList.ESAuditTrail,
            authToken: localStorage.getItem('authToken')
          });

          // CSV file has been generated in memory.
          // Workers does not have the document object, DOM, etc, so we force to write
          // the file into the hard drive by "interacting with the DOM" in the main thread
          csvWorker.addEventListener('message', function(e) {
            var linkHelper = document.createElement('a');

            Polymer.dom(document).querySelector('#paperToast').text = 'Kazoup logs ready!';
            Polymer.dom(document).querySelector('#paperToast').show();

            linkHelper.href = e.data.href;
            linkHelper.target = '_blank';
            linkHelper.download = 'kazoup-logs-' + new Date().toString().replace(/ /g, '-') + '.csv';
            linkHelper.click();
          });
        },
        getElasticParams: function() {
          var body = {
            'from': this.from,
            'size': 20,
            'query': {
              'filtered': {
                'filter': {
                  'bool': {
                    'must': []
                  }
                }
              }
            },
            'sort': [
              {
                'timestamp': {
                  'order': 'desc'
                }
              }
            ]
          };
          // Add category filter if set
          if (this.category.length > 0 && this.category !== '*') {
            body.query.filtered.filter.bool.must.push({
              'term': {
                'category': this.category
              }
            });
          }
          // Add query search param if set
          if (this.q.length > 0) {
            body.query.filtered.query = {
              'match': {
                'message': {
                  'query': this.q,
                  'type': 'phrase'
                }
              }
            };
          }
          // Add timestamp filters
          if (this.fromDate && this.toDate) {
            body.query.filtered.filter.bool.must.push({
              'range': {
                'timestamp': {
                  'gte': this.fromDate,
                  'lte': this.toDate
                }
              }
            });
          }

          return JSON.stringify(body);
        },
        filterByCategory: function(e, detail) {
          this.set('category', e.currentTarget.dataset.category);
        },
        search: function() {
          this.set('logResults', []);
          this.getLogs();

          if (this.isMobileDevice().any()) {
            document.activeElement.blur();
          }
        },
        openDropdown: function() {
          this.$.dropdown.open();
        },
        setTimeRange: function(e, detail) {
          switch (e.currentTarget.dataset.value) {
            case 'hour':
              this.fromDate = 'now-1h';
              break;
            case 'day':
              this.fromDate = 'now-1d';
              break;
            case 'week':
              this.fromDate = 'now-1w';
              break;
            case 'all':
              this.fromDate = 0;
              break;
          }
          this.toDate = 'now';

          this.$.dropdown.close();
          this.getLogs();
        },
        getIcon: function(type) {
          switch (type) {
            case 'info':
              return 'info';
            case 'warn':
              return 'warning';
            case 'error':
              return 'error';
            default:
              return '';
          }
        },
        _handleLogs: function(e) {
          this.set('requestInProgress', false);
          if (e && e.response && e.response.hits && e.response.hits.hits && e.response.hits.hits.length) {
            this.set('availableResults', true);

            _.forEach(e.response.hits.hits, function(logEntry) {
              this.push('logResults', logEntry);
            }, this);
          } else {
            if (!this.logResults.length) {
              this.set('availableResults', false);
            }
          }
          this.$.list.fire('iron-resize');
        },
        getLogs: function() {
          this.set('from', 0);
          this.set('logResults', []);
          this.set('requestInProgress', true);
          this.replaceHistoryState();
          this.$.auditTrail.setParamsAsObj(this.getElasticParams());
          this.$.auditTrail.generateRequest().then(this._handleLogs.bind(this));
        },
        replaceHistoryState: function() {
          history.replaceState(
            {},
            'Logs',
            location.origin + '/logs?category=' + this.category + '&q=' + this.q
          );
        },
        init: function(e) {
          if (!_.isEmpty(e.data)) {
            if (e.data.category && this.categoryMap.indexOf(e.data.category) !== -1) {
              this.set('selectedTab', this.categoryMap.indexOf(e.data.category));
              this.set('category', e.data.category);
            } else {
              this.set('category', '*'); // Default
            }

            if (e.data.q) {
              this.set('q', e.data.q);
            }
          } else {
            this.set('category', '*'); // Default
          }

          this.replaceHistoryState();
          this.getLogs();
        },
        attached: function() {
          Polymer.dom.flush();

          window.addEventListener('kazoup-logs-initialized', this.init.bind(this));

          // Infinite scroll
          this.async(function() {
            Polymer.dom(this.$.list).node._scroller.addEventListener('scroll', function(e) {
              var totalHeight = 0,
                viewportPosition = 0;

              if (!this.requestInProgress) {
                totalHeight =
                  this.logResults.length *
                  (Polymer.dom(this.$.list).querySelector('.row').offsetHeight || 81);
                viewportPosition =
                  Polymer.dom(this.$.list).node._scroller.scrollTop +
                  Polymer.dom(this.$.list).node._scroller.offsetHeight;

                if (totalHeight - 350 < viewportPosition) {
                  this.scroll = Date.now();
                }
              }
            }.bind(this));
          }, 1000);
        }
      });
    }());
  </script>
</dom-module>
