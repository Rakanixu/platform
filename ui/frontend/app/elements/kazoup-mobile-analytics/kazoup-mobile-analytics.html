<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel='import' href='../../bower_components/lib-d3/lib-d3.html'>
<link rel="import" href="../kazoup-filters-converter/kazoup-filters-converter.html">
<link rel="import" href="../kazoup-analytics-data/kazoup-analytics-data.html">
<link rel="import" href="../kazoup-analytics-filters-menu/kazoup-analytics-filters-menu.html">
<link rel="import" href="../kazoup-analytics-filters/kazoup-analytics-filters.html">
<link rel="import" href="../kazoup-d3-charts/kazoup-d3-charts.html">
<link rel="import" href="../kazoup-download-report/kazoup-download-report.html">
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">
<link rel="import" href="../kazoup-timestamp-data/kazoup-timestamp-data.html">
<link rel="import" href="../kazoup-time-range-selector/kazoup-time-range-selector.html">

<dom-module id="kazoup-mobile-analytics">
  <link rel="import" type="css" href="kazoup-mobile-analytics.css">

  <template>
    <paper-toolbar>
      <paper-icon-button icon="menu"
                         on-tap="openDrawerPanel"
                         hidden$="[[!isRootDirectory]]"
                         paper-drawer-toggle></paper-icon-button>

      <paper-icon-button icon="arrow-back"
                         class="arrow-back"
                         hidden$="[[isRootDirectory]]"
                         on-tap="goPreviousDirectory"></paper-icon-button>

      <div class="horizontal layout flex directory">
        <span>[[directory]]</span>
      </div>

      <paper-icon-button id="go-to-search-icon"
                 on-tap="switchToSearch"
                 icon="search"></paper-icon-button>

      <paper-icon-button id="more-icon"
                 on-tap="toggleRightDrawer"
                 icon="icons:more-vert"
                 class="cursor-pointer"></paper-icon-button>

      <paper-progress id="progressBar"
                      class="middle fit"
                      hidden$="[[!requestInProgress]]"
                      indeterminate></paper-progress>
    </paper-toolbar>

    <div class="container box vertical layout center-justified">
      <paper-drawer-panel id="rightDrawer"
                          edge-swipe-sensitivity="15"
                          force-narrow="true"
                          drawer-width="200px"
                          right-drawer>
        <!-- Analytics menu -->
        <paper-header-panel drawer>
          <paper-toolbar id="right-toolbar">
            <div class="ripple-container">
              <iron-icon id="calendar"
                         on-tap="openTimeRangeSelector"
                         src="/static/images/calendar-icon.svg"></iron-icon>
              <paper-ripple class="dark-background"></paper-ripple>
            </div>

            <kazoup-download-report visualisation="[[visualisation]]"
                                    dimension="[[dimension]]"
                                    period="[[period]]"
                                    chart-data="[[chartData]]"></kazoup-download-report>
          </paper-toolbar>

          <kazoup-analytics-filters-menu id="kazoupAnalyticsFiltersMenu"
                                         dimension="{{dimension}}"
                                         second-dimension="{{secondDimension}}"
                                         visualisation="{{visualisation}}"></kazoup-analytics-filters-menu>

        </paper-header-panel>
        <!-- Main anlaytics panel -->
        <paper-header-panel main>
          <div class="vertical layout analytics-main-panel">
            <div class="filters">
              <kazoup-analytics-filters target="kazoup-mobile-analytics"></kazoup-analytics-filters>
            </div>

            <div class="vertical layout flex main-chart">
              <kazoup-d3-charts id="mainChart"
                                target="kazoup-mobile-analytics"
                                chart-data="{{chartData}}"
                                visualisation="{{visualisation}}"
                                dimension="{{dimension}}"
                                period="{{period}}"
                                requestinprogress="{{requestInProgress}}"></kazoup-d3-charts>
            </div>
          </div>
        </paper-header-panel>
      </paper-drawer-panel>
    </div>

    <kazoup-filters-converter id="filterConverter"
                              filters="{{filters}}"></kazoup-filters-converter>

    <kazoup-analytics-data chart-data="{{chartData}}"
                           dimension="{{dimension}}"
                           second-dimension="{{secondDimension}}"
                           visualisation="{{visualisation}}"
                           timestamptype="{{timestampType}}"
                           period="{{period}}"
                           request-in-progress="{{requestInProgress}}"
                           target="kazoup-mobile-analytics"></kazoup-analytics-data>

    <kazoup-timestamp-data target="kazoup-mobile-analytics"
                           date-range-data="{{dateRangeData}}"></kazoup-timestamp-data>

    <!-- Period param is not required for mobile, because we do not handle histogram -->
    <kazoup-time-range-selector id="timeRangeSelector"
                        target="kazoup-mobile-analytics"
                        date-range-data="[[dateRangeData]]"></kazoup-time-range-selector>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-mobile-analytics',
        behaviors: [
          KazoupBehaviors.Devices,
          KazoupBehaviors.PanelActions,
          KazoupBehaviors.CustomAnimations,
          KazoupBehaviors.Util
        ],
        properties: {
          dateRangeData: {
            type: Array,
            notify: true,
            observer: 'dateRangeDataChanged'
          },
          dimension: {
            type: String,
            notify: true
          },
          secondDimension: {
            type: String,
            notify: true
          },
          filters: {
            type: Object,
            notify: true
          },
          period: {
            type: String,
            notify: true
          },
          requestInProgress: {
            type: Boolean,
            value: false
          },
          selectedDimension: {
            type: Number,
            value: 0
          },
          chartData: {
            type: Object,
            notify: true
          },
          visualisation: {
            type: String,
            notify: true
          },
          directory: {
            type: String,
            notify: false,
            value: ''
          },
          isRootDirectory: {
            type: Boolean,
            notify: false,
            value: true
          }
        },
        dateRangeDataChanged: function() {
          var years = new Date().getFullYear() - new Date(this.dateRangeData[0]).getFullYear();

          this.set('beginningOfTime', 'now-' + years + 'y/d');

          if (!this.$.filterConverter.getValue('from') && !this.$.filterConverter.getValue('to')) {
            // Firing on load, sets from date with the data retrieved by kazoup-timestamp-data
            this.$.filterConverter.setValues([
              {field: 'from', val: this.beginningOfTime},
              {field: 'to', val: 'now-0y/d'}
            ]);
          }
        },
        buildQuery: function() {
          var routerUrl = '';

          this.setDateLabels(
            this.$.filterConverter.getValue('from'),
            this.$.filterConverter.getValue('to')
          );

          routerUrl = '/analytics?' +
            'dimension=' + this.dimension +
            '&secondDimension=' + this.secondDimension +
            '&visualisation=' + this.visualisation +
            '&filters=' + this.$.filterConverter.asQuerystring() +
            '&period=' + this.period;

          history.pushState({}, 'Analytics', routerUrl);
        },
        setDirectory: function(e) {
          var customPath = this.$.filterConverter.getValue('dirpath');

          if (e.detail.fieldsChanged === undefined ||
              e.detail.fieldsChanged[0].field === 'dirpath') {
            if (customPath[0] !== undefined) {
              this.set('isRootDirectory', false);
              this.set('directory', this.customDirectoryName(customPath[0]));
            } else {
              this.set('isRootDirectory', true);
              this.set('directory', '');
            }
          }
        },
        goPreviousDirectory: function(e, detail) {
          var path = this.$.filterConverter.getValue('dirpath')[0];
          var index = path.lastIndexOf('/');

          path = path.substring(0, index);
          if (path === '/') {
            path = '//';
            this.async(function() {
              this.set('isRootDirectory', true);
            });
          }

          this.$.filterConverter.setValue('dirpath', path);
        },
        dirPathEncode: function() {
          return encodeURIComponent(this.dirpath);
        },
        switchToSearch: function() {
          document.location = '/search?q=&browser=false&view=search&filters=' + this.$.filterConverter.asQuerystring();
        },
        toggleRightDrawer: function() {
          this.$.rightDrawer.openDrawer();

          // Fix to get the focus on the filtes and be able to scroll them
          this.async(function() {
            Polymer.dom(this.$.kazoupAnalyticsFiltersMenu)
              .node.querySelector('#filtersPanel').click();
          }, 100);
        },
        openTimeRangeSelector: function() {
          this.$.timeRangeSelector.open();
          this.$.rightDrawer.closeDrawer();
        },
        init: function(e) {
          // This approach solves an issue getting data more times than required
          // when observers are being fire more than once
          // On observers we check old and new values must be defined
          this.set('dimension', undefined);
          this.set('secondDimension', undefined);
          this.set('visualisation', undefined);
          this.set('period', undefined);

          if (e.data.dimension) {
            this.set('dimension', e.data.dimension);
          } else {
            this.set('dimension', 'location'); // default
          }

          if (e.data.secondDimension) {
            this.set('secondDimension', e.data.secondDimension);
          } else {
            this.set('secondDimension', 'none');
          }

          if (e.data.visualisation) {
            this.set('visualisation', e.data.visualisation);
          } else {
            this.set('visualisation', 'bubble'); // default
          }

          if (e.data.period) {
            this.set('period', e.data.period);
          } else {
            this.set('period', 'year'); // default
          }

          if (e.data.filters) {
            this.set('filters', JSON.parse(e.data.filters));
          } else {
            this.set('filters', {}); // default
          }

          if (e.data.fromSearch) {
            this.async(function() {
              Polymer.dom(this.root).querySelector('kazoup-analytics-data')._fetchAllData();
            }, 10);
          }
        },
        attached: function() {
          Polymer.dom.flush();

          localStorage.getItem('advance_anlytics_enabled') === 'true' ?
            this.advance_anlytics_enabled = true :
            this.advance_anlytics_enabled = false;

          // kazoup-mobile-analytics initialized with URL params
          window.addEventListener('kazoup-mobile-analytics-initialized', this.init.bind(this));

          this.$.filterConverter.addEventListener('filters-changed', this.buildQuery.bind(this));
          this.$.filterConverter.addEventListener('filters-changed', this.setDirectory.bind(this));
        }
      });
    }());
  </script>
</dom-module>
