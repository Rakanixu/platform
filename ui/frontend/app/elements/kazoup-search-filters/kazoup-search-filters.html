<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../kazoup-search-filters-data/kazoup-search-filters-data.html">

<dom-module id="kazoup-search-filters">
  <link rel="import" type="css" href="kazoup-search-filters.css">

  <template>

    <paper-progress id="progressBar"
                    hidden$="[[!requestInProgress]]"
                    indeterminate></paper-progress>

    <div id="filtersPanel" class$="[[deviceType]]">
      <div class="horizontal layout heading">
        <span class="flex unselectable">Filters</span>
        <span class="cursor-pointer clear-filters"
              on-tap="clearFilters">Clear filters</span>
      </div>

      <div class="filters-container">

        <div id="doc_type">
          <paper-item class="horizontal layout" data-filtertype="doc_type" on-tap="toggleAll">
            <span class="flex">Categories</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{doc_type}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!doc_typeShow.more}}">
              <span class="show-more cursor-pointer"
                    data-filtertype="doc_type"
                    on-tap="toggleMore">Show less
                <iron-icon class="small" icon="remove" data-filtertype="doc_type"></iron-icon>
              </span>
            </template>
            <template is="dom-if" if="{{doc_typeShow.more}}">
              <span class="show-more cursor-pointer"
                    data-filtertype="doc_type"
                    data-more-data="true"
                    on-tap="toggleMore">Show more
                <iron-icon class="small" icon="add" data-filtertype="doc_type"></iron-icon>
              </span>
            </template>
          </div>
        </div>

        <div id="extension">
          <paper-item class="horizontal layout" data-filtertype="extension" on-tap="toggleAll">
            <span class="flex">Extensions</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{extension}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!extensionShow.more}}">
              <span class="show-more cursor-pointer"
                    data-filtertype="extension"
                    on-tap="toggleMore">Show less
                <iron-icon class="small" icon="remove" data-filtertype="extension"></iron-icon>
              </span>
            </template>
            <template is="dom-if" if="{{extensionShow.more}}">
              <span class="show-more cursor-pointer"
                    data-filtertype="extension"
                    data-more-data="true"
                    on-tap="toggleMore">Show more
                <iron-icon class="small" icon="add" data-filtertype="extension"></iron-icon>
              </span>
            </template>
          </div>
        </div>

        <div id="duplicates">
          <paper-item class="horizontal layout" data-filtertype="duplicates" on-tap="toggleAll">
            <span class="flex">Duplicates</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{duplicates}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{analyticsLabel(filter.term)}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
          </div>
        </div>

        <div id="allow">
          <paper-item class="horizontal layout" data-filtertype="allow" on-tap="toggleAll">
            <span class="flex">Permissions</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{allow}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!allowShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="allow"
                      on-tap="toggleMore">Show less
                  <iron-icon class="small" icon="remove" data-filtertype="allow"></iron-icon>
                </span>
            </template>
            <template is="dom-if" if="{{allowShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="allow"
                      data-more-data="true"
                      on-tap="toggleMore">Show more
                  <iron-icon class="small" icon="add" data-filtertype="allow"></iron-icon>
                </span>
            </template>
          </div>
        </div>

        <div id="archive_status">
          <paper-item class="horizontal layout" data-filtertype="archive_status" on-tap="toggleAll">
            <span class="flex">Archive</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{archive_status}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
          </div>
        </div>

        <div id="file_size">
          <paper-item class="horizontal layout" data-filtertype="file_size" on-tap="toggleAll">
            <span class="flex">Size</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{file_size}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
          </div>
        </div>

        <div id="places_person">
          <paper-item class="horizontal layout" data-filtertype="places_person" on-tap="toggleAll">
            <span class="flex">Persons</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{places_person}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!places_personShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_person"
                      on-tap="toggleMore">Show less
                  <iron-icon class="small" icon="remove" data-filtertype="places_person"></iron-icon>
                </span>
            </template>
            <template is="dom-if" if="{{places_personShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_person"
                      data-more-data="true"
                      on-tap="toggleMore">Show more
                  <iron-icon class="small" icon="add" data-filtertype="places_person"></iron-icon>
                </span>
            </template>
          </div>
        </div>

        <div id="places_organisation">
          <paper-item class="horizontal layout" data-filtertype="places_organisation" on-tap="toggleAll">
            <span class="flex">Organisations</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{places_organisation}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!places_organisationShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_organisation"
                      on-tap="toggleMore">Show less
                  <iron-icon class="small" icon="remove" data-filtertype="places_organisation"></iron-icon>
                </span>
            </template>
            <template is="dom-if" if="{{places_organisationShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_organisation"
                      data-more-data="true"
                      on-tap="toggleMore">Show more
                  <iron-icon class="small" icon="add" data-filtertype="places_organisation"></iron-icon>
                </span>
            </template>
          </div>
        </div>

        <div id="places_location">
          <paper-item class="horizontal layout" data-filtertype="places_location" on-tap="toggleAll">
            <span class="flex">Locations</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <template is="dom-repeat" items="{{places_location}}" as="filter">
              <div class$="horizontal layout filter {{_computeFilterVisibility(index)}}">
                <paper-checkbox checked$="{{filter.selected}}"
                                on-tap="applyFilter">
                  <span>{{filter.term}}</span>
                  <span>({{filter.count}})</span>
                </paper-checkbox>
              </div>
            </template>
            <template is="dom-if" if="{{!places_locationShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_location"
                      on-tap="toggleMore">Show less
                  <iron-icon class="small" icon="remove" data-filtertype="places_location"></iron-icon>
                </span>
            </template>
            <template is="dom-if" if="{{places_locationShow.more}}">
                <span class="show-more cursor-pointer"
                      data-filtertype="places_location"
                      data-more-data="true"
                      on-tap="toggleMore">Show more
                  <iron-icon class="small" icon="add" data-filtertype="places_location"></iron-icon>
                </span>
            </template>
          </div>
        </div>

        <div id="range">
          <paper-item class="horizontal layout" data-filtertype="range" on-tap="toggleAll">
            <span class="flex">Range</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters" on-tap="openDatePicker">
            <span>[[fromDateLabel]]</span>
            <span hidden$="[[_computeDateIntervalInfo(fromDateLabel, toDateLabel)]]"> - </span>
            <span>[[toDateLabel]]</span>
          </div>
        </div>

        <div id="timestampType">
          <paper-item class="horizontal layout" data-filtertype="timestampType" on-tap="toggleAll">
            <span class="flex">Timestamp</span>
            <iron-icon icon="icons:expand-less"></iron-icon>
            <paper-ripple class="light-background"></paper-ripple>
          </paper-item>

          <div class="filters">
            <div class="horizontal layout filter">
              <paper-checkbox id="accessed"
                              data-filter-type="timestampType"kazoupSubmitButton
                              data-filter="accessed"
                              on-tap="applyFilter">
                <span>Accesed</span>
              </paper-checkbox>
            </div>
            <div class="horizontal layout filter">
              <paper-checkbox id="modified"
                              data-filter-type="timestampType"
                              data-filter="modified"
                              on-tap="applyFilter">
                <span>Modified</span>
              </paper-checkbox>
            </div>
          </div>
        </div>

      </div>
    </div>

    <kazoup-search-filters-data id="searchFiltersData"
                                target="[[target]]"
                                request-in-progress="{{requestInProgress}}"
                                category-data="{{doc_type}}"
                                extensions-data="{{extension}}"
                                duplicates-data="{{duplicates}}"
                                permissions-data="{{allow}}"
                                archive-status-data="{{archive_status}}"
                                file-size-data="{{file_size}}"
                                places-persons-data="{{places_person}}"
                                places-organisations-data="{{places_organisation}}"
                                places-locations-data="{{places_location}}"></kazoup-search-filters-data>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-search-filters',
        behaviors: [
          KazoupBehaviors.Devices,
          KazoupBehaviors.Util,
          KazoupBehaviors.NetworkError
        ],
        properties: {
          target: {
            type: String,
            notify: true
          },
          requestInProgress: {
            type:Boolean,
            notify: true,
            value: false
          },
          doc_type: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          extension: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          duplicates: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          allow: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          places_person: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          places_organisation: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          places_location: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          doc_typeShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          extensionShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          duplicatesShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          archive_statusShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          file_sizeShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          allowShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          places_locationShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          places_organisationShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          places_personShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          rangeShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          },
          timestampTypeShow: {
            type: Object,
            notify: true,
            value: function() {
              return {
                more: true,
                all: true
              };
            }
          }
        },
        observers: [
          'filtersDataChanged(' +
            'doc_type, ' +
            'extension, ' +
            'allow, ' +
            'places_person, ' +
            'places_organisation, ' +
            'places_location' +
          ')'
        ],
        filtersDataChanged: function() {
          Polymer.dom.flush();

          if (this.doc_type && typeof this.doc_typeShow === 'object') {
            if (this.doc_type.length >= 4) {
              Polymer.dom(this.root).querySelector('#doc_type .show-more').classList.remove('hidden');
              this.set('doc_typeShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#doc_type .show-more').classList.add('hidden');
              this.set('doc_typeShow.more', false);
            }
          }

          if (this.extension && typeof this.extensionShow === 'object') {
            if (this.extension.length >= 4) {
              Polymer.dom(this.root).querySelector('#extension .show-more').classList.remove('hidden');
              this.set('extensionShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#extension .show-more').classList.add('hidden');
              this.set('extensionShow.more', false);
            }
          }

          if (this.allow && typeof this.allowShow === 'object') {
            if (this.allow.length >= 4) {
              Polymer.dom(this.root).querySelector('#allow .show-more').classList.remove('hidden');
              this.set('allowShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#allow .show-more').classList.add('hidden');
              this.set('allowShow.more', false);
            }
          }

          if (this.places_location && typeof this.places_locationShow === 'object') {
            if (this.places_location.length >= 4) {
              Polymer.dom(this.root).querySelector('#places_person .show-more').classList.remove('hidden');
              this.set('places_locationShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#places_person .show-more').classList.add('hidden');
              this.set('places_locationShow.more', false);
            }
          }

          if (this.places_organisation && typeof this.places_organisationShow === 'object') {
            if (this.places_organisation.length >= 4) {
              Polymer.dom(this.root).querySelector('#places_organisation .show-more').classList.remove('hidden');
              this.set('places_organisationShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#places_organisation .show-more').classList.add('hidden');
              this.set('places_organisationShow.more', false);
            }
          }

          if (this.places_location && typeof this.places_locationShow === 'object') {
            if (this.places_location.length >= 4) {
              Polymer.dom(this.root).querySelector('#places_location .show-more').classList.remove('hidden');
              this.set('places_locationShow.more', true);
            } else {
              Polymer.dom(this.root).querySelector('#places_location .show-more').classList.add('hidden');
              this.set('places_locationShow.more', false);
            }
          }
        },
        updateTimestampCheckbox: function() {
          this.timestampType = this._filterConverter.getValue('timestampType');

          if (this.timestampType === 'modified') {
            this.$.modified.checked = true;
            this.$.modified.disabled = true;
            this.$.accessed.checked = !this.$.modified.checked;
            this.$.accessed.disabled = !this.$.modified.disabled;
          } else {
            this.$.accessed.checked = true;
            this.$.accessed.disabled = true;
            this.$.modified.checked = !this.$.accessed.checked;
            this.$.modified.disabled = !this.$.accessed.disabled;
          }
        },
        updateRangeLabels: function() {
          this.setDateLabels(
            this._filterConverter.getValue('from'),
            this._filterConverter.getValue('to')
          );
        },
        applyFilter: function(e, detail) {
          if (e.model && e.model.__data__) {
            if (e.currentTarget.checked) {
              this._filterConverter.addValue(e.model.__data__.filter.filterType, e.model.__data__.filter.term);
            } else {
              this._filterConverter.removeValue(e.model.__data__.filter.filterType, e.model.__data__.filter.term);
            }

            this.$.searchFiltersData._fetchAllData(e.model.__data__.filter.filterType);
          } else if (e.currentTarget.dataset && e.currentTarget.dataset.filterType) {
            // UI switching
            if (e.currentTarget.dataset.filter === 'accessed' && this.$.accessed.checked) {
              this.$.modified.checked = false;
              this.$.accessed.disabled = true;
              this.$.modified.disabled = false;
            } else if (e.currentTarget.dataset.filter === 'modified' && this.$.modified.checked) {
              this.$.accessed.checked = false;
              this.$.modified.disabled = true;
              this.$.accessed.disabled = false;
            }

            this.timestampType = e.currentTarget.dataset.filter;

            this._filterConverter.setValues([
              {
                 field: e.currentTarget.dataset.filterType,
                 val: e.currentTarget.dataset.filter
              }
            ]);
          }
        },
        toggleMore: function(e, detail) {
          var filters;
          var value;

          if (e.target.dataset.moreData) {
            if (this[e.target.dataset.filtertype].length <= 4) {
              this.$.searchFiltersData.fetchFilterData(e.target.dataset.filtertype, 50)
                .then(this.toggleFilters.bind(this, e.target.dataset.filtertype, 'remove'));
            } else {
              this.toggleFilters(e.target.dataset.filtertype, 'remove');
            }

            this.set(e.target.dataset.filtertype + 'Show.more', false);
          } else {
            this.toggleFilters(e.target.dataset.filtertype, 'add');

            this.set(e.target.dataset.filtertype + 'Show.more', true);
          }
        },
        toggleAll: function(e, detail) {
          var value = !this[e.currentTarget.dataset.filtertype + 'Show'].all;

          if (value) {
            this.$[e.currentTarget.dataset.filtertype].querySelector('.filters').classList.remove('collapse');
            this.$[e.currentTarget.dataset.filtertype].querySelector('iron-icon').classList.remove('rotate');
          } else {
            this.$[e.currentTarget.dataset.filtertype].querySelector('.filters').classList.add('collapse');
            this.$[e.currentTarget.dataset.filtertype].querySelector('iron-icon').classList.add('rotate');
          }

          this.set(e.currentTarget.dataset.filtertype + 'Show.all', value);
        },
        toggleFilters: function(filterType, action) {
          var filters = this.$[filterType].querySelectorAll('.filter');

          _.forEach(filters, function(filter, index) {
            if (index > 3) {
              filter.classList[action]('collapsable-filter');
            }
          });

          if (filters.length > 4) {
            this.set(filterType + 'Show.more', false);
          }
        },
        openDatePicker: function(e, detail) {
          Polymer.dom(document).querySelector(this.target)
            .querySelector('paper-drawer-panel').closeDrawer();
          Polymer.dom(document).querySelector(this.target)
            .querySelector('kazoup-time-range-selector').open();
        },
        clearFilters: function() {
          this._filterConverter.setValues([
            {
              field: 'dirpath',
              value: this._filterConverter.getValue('dirpath')
            },
            {
              field: 'q',
              value: this._filterConverter.getValue('q')
            }
          ], true);
          this.$.searchFiltersData._fetchAllData();
        },
        _computeFilterVisibility: function(index) {
          return (index > 3) ? 'collapsable-filter' : 'non-collapsable-filter';
        },
        _computeDateIntervalInfo: function(fromLabel, toLabel) {
          return !(fromLabel && toLabel);
        },
        attached: function() {
          Polymer.dom.flush();

          if (this.isMobileDevice().any()) {
            this.set('deviceType', 'mobile');
          } else {
            this.set('deviceType', 'desktop');
          }

          // Selects its filter converter, if not,
          // the one from kazoup-analytics can be selected erroneously
          // trigerring observer in the wrong place,
          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
          this._filterConverter.addEventListener('filters-changed', this.updateTimestampCheckbox.bind(this));
          this._filterConverter.addEventListener('filters-changed', this.updateRangeLabels.bind(this));
        }
      });
    }());
  </script>
</dom-module>
