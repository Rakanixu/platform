<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../kazoup-ajax/kazoup-ajax.html">
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">

<dom-module id="kazoup-settings-data-sources">
  <link rel="import" type="css" href="kazoup-settings-data-sources.css">

  <template>

    <div class="flex layout vertical container">
      <kazoup-empty-state icon="editor:insert-chart"
                          header="No data sources"
                          description="<a href='/settings/scan'>Add</a>
                                      <span> data sources by scanning your servers </span>"
                          hidden$="[[!emptyStateVisible]]"></kazoup-empty-state>

      <iron-list id="list" items="[[dataSources]]" as="item">
        <template>
          <div class="horizontal layout row">
            <div class="icon">
              <iron-icon icon="folder-open"></iron-icon>
            </div>

            <div class="vertical layout flex data-source cursor-pointer"
                 on-tap="openScaning"
                 data-server$="[[item.server]]">
              <h4>[[item.url]]</h4>
              <p>Last scan:
                <span> [[timestampToHumanDate(item.last_scan)]]</span>
              </p>
            </div>

            <div class="horizontal layout actions">
              <paper-icon-button id="deletion-icon"
                                 icon="av:play-arrow"
                                 data-value$="[[item.id]]"
                                 on-tap="startScan"></paper-icon-button>
              <paper-tooltip for$="deletion-icon"
                             animation-delay="100"
                             position="left">Start scaning</paper-tooltip>
            </div>

            <template is="dom-if" if="[[item.pending_delete]]">
              <div class="horizontal layout actions">
                <span>[[item.pending_delete]]</span>
              </div>
            </template>

            <template is="dom-if" if="[[!item.pending_delete]]">
              <div class="horizontal layout actions">
                <paper-icon-button id="deletion-icon"
                                   icon="delete"
                                   data-value$="[[item.id]]"
                                   on-tap="openDeletionDialog"></paper-icon-button>
                <paper-tooltip for$="deletion-icon"
                               animation-delay="100"
                               position="left">Delete data source</paper-tooltip>
              </div>
            </template>

            <paper-ripple class="light-background"></paper-ripple>
          </div>
        </template>
      </iron-list>

      <paper-fab on-tap="openScaning"
                 icon="add" title="Add new data source"></paper-fab>
    </div>

    <paper-dialog id="deleteShareDialog" with-backdrop>
      <h2>Delete data source</h2>
      <section>
        <p>Are you sure you want to delete this data source?</p>
      </section>
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-click="deleteShare">OK</paper-button>
    </paper-dialog>

    <paper-dialog id="addDataSourceDialog" with-backdrop>
      <h2>Add datasource</h2>
      <section>
        <paper-dropdown-menu label="Select data source type"
                             on-iron-select="setDataSourceType">
          <paper-listbox class="dropdown-content">
            <paper-item>local</paper-item>
            <paper-item>fake</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </section>
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-click="addDataSource">OK</paper-button>
    </paper-dialog>

    <kazoup-ajax id="searchDataSourcesReq"
                 method="POST"
                 url="[[endpointList.searchDataSources]]"
                 is-authorize="true"
                 handle-as="json"></kazoup-ajax>

    <kazoup-ajax id="deleteDataSourceReq"
                 method="DELETE"
                 url="[[endpointList.deleteDataSource]]"
                 is-authorize="true"></kazoup-ajax>

    <kazoup-ajax id="addDataSourceReq"
                 method="POST"
                 url="[[endpointList.createDataSource]]"
                 is-authorize="true"></kazoup-ajax>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-settings-data-sources',
        behaviors: [
          KazoupBehaviors.Util,
          KazoupBehaviors.APIUrls
        ],
        properties: {
          emptyStateVisible: {
            type: Boolean,
            notify: false,
            value: false
          },
          dataSourceId: {
            type: Number,
            notify: false,
            value: null
          },
          dataSources: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },
          dataSourceType: {
            type: Array,
            notify: true
          }
        },
        openScaning: function(e, detail) {
          //This was redirecting to other page
          // Now we open a dialog for custom data sources
          // We will come back later on
/*          var url = '/settings/scan';

          if (e.currentTarget.dataset.server) {
            url += '?server=' + e.currentTarget.dataset.server;

            if (e.model && e.model.__data__.item.pending_delete !== 'Deleting') {
              document.location = url;
            }
          } else {
            document.location = url;
          }*/
          this.$.addDataSourceDialog.open();
        },
        setDataSourceType: function(e, detail) {
          this.set('dataSourceType', e.target.selectedItem.textContent.replace(/\s/g, ""));
        },
        addDataSource: function(e, detail) {
          var url

          if (this.dataSourceType === "local") {
            url = this.dataSourceType + '://'
          } else {
            url = this.dataSourceType
          }

          this.$.addDataSourceReq.setParamsAsObj({
            endpoint: {
              url: url
            }
          });
          this.$.addDataSourceReq.generateRequest().then(this._handleAddDataSource.bind(this));
          this.$.addDataSourceDialog.close();
        },
        openDeletionDialog: function(e, detail) {
          this.set('dataSourceId', e.model.__data__.item.id);
          this.$.deleteShareDialog.open();
        },
        deleteShare: function() {
          this.$.deleteDataSourceReq.setParamsAsObj({
            id: this.dataSourceId
          });
          this.$.deleteDataSourceReq.generateRequest().then(this._handleShareDeletion.bind(this));
        },
        _handleAddDataSource: function(e) {
          if (e && e.status === 200) {
            Polymer.dom(document).querySelector('paper-toast').text = 'Data source added successfully';
            Polymer.dom(document).querySelector('paper-toast').show();
            // We cannot append (UI) a datasource without quering backend, we need to retrieve info just created
            // So we ensure ES index has been recalculated and eventually consistent
            this.async(function() {
              this.getDataSources();
            }, 1001);
          }
        },
        _handleShareDeletion: function(e) {
          if (e && e.status === 204 || e.status === 200) {
            var index = _.findIndex(this.dataSources, function(dataSource) {
              return dataSource.id === this.dataSourceId
            }.bind(this));

            this.dataSources.splice(index, 1);
            this.set('dataSources', this.dataSources);
            this.$.list.fire('iron-resize');

            this.set('dataSourceId', null);
            this.$.deleteShareDialog.close();
            Polymer.dom(document).querySelector('paper-toast').text = 'Share deleted successfully';
            Polymer.dom(document).querySelector('paper-toast').show();
          }
        },
        _handleDataSources: function(e) {
          if (e && e.response) {
            this.set('dataSources', e.response);

            _.forEach(this.dataSources, function(share, index) {
              if (share.pending_delete) {
                this.dataSources[index].pending_delete = 'Deleting';
              } else {
                this.dataSources[index].pending_delete = undefined;
              }
            }, this);
          }
          this.$.list.fire('iron-resize');
          this.set('emptyStateVisible', !this.dataSources.length);
        },
        getDataSources: function() {
          this.set('dataSources', []);
          this.$.searchDataSourcesReq.setParamsAsObj({
            offset: 0,
            limit: 1000
          });
          this.$.searchDataSourcesReq.generateRequest().then(this._handleDataSources.bind(this));
        },
        startScan: function(e, detail) {
          console.log(e.model.__data__.item)
        },
        init: function() {
          this.getDataSources();
        },
        attached: function() {
          Polymer.dom.flush();

          window.addEventListener('kazoup-settings-data-sources-initialized', this.init.bind(this));
        }
      });
    }());
  </script>
</dom-module>
