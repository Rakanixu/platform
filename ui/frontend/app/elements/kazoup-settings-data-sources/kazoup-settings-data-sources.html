<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../kazoup-ajax/kazoup-ajax.html">
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">

<dom-module id="kazoup-settings-data-sources">
  <link rel="import" type="css" href="kazoup-settings-data-sources.css">

  <template>

    <div class="flex layout vertical container">
      <kazoup-empty-state icon="editor:insert-chart"
                          header="No data sources"
                          description="<a href='/settings/scan'>Add</a>
                                      <span> data sources by scanning your servers </span>"
                          hidden$="[[!emptyStateVisible]]"></kazoup-empty-state>

      <iron-list id="list" items="[[shares]]" as="item">
        <template>
          <div class="horizontal layout row">
            <div class="icon">
              <iron-icon icon="folder-open"></iron-icon>
            </div>

            <div class="vertical layout flex data-source cursor-pointer"
                 on-tap="openScaning"
                 data-server$="[[item.server]]">
              <h4>[[item.share]]</h4>
              <p>Last scan:
                <span> [[timestampToHumanDate(item.scan_last_completed)]]</span>
              </p>
            </div>

            <template is="dom-if" if="[[item.pending_delete]]">
              <div class="horizontal layout actions">
                <span>[[item.pending_delete]]</span>
              </div>
            </template>

            <template is="dom-if" if="[[!item.pending_delete]]">
              <div class="horizontal layout actions">
                <paper-icon-button id="deletion-icon"
                                   icon="delete"
                                   data-value$="[[item.id]]"
                                   on-tap="openDeletionDialog"></paper-icon-button>
                <paper-tooltip for$="deletion-icon"
                               animation-delay="100"
                               position="left">Delete data source</paper-tooltip>
              </div>
            </template>

            <paper-ripple class="light-background"></paper-ripple>
          </div>
        </template>
      </iron-list>

      <paper-fab on-tap="openScaning"
                 icon="add" title="Add new data source"></paper-fab>
    </div>

    <paper-dialog id="deleteShareDialog" with-backdrop>
      <h2>Delete data source</h2>
      <section>
        <p>Are you sure you want to delete this data source?</p>
      </section>
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-click="deleteShare">OK</paper-button>
    </paper-dialog>

    <kazoup-ajax id="shares"
                 method="GET"
                 url="[[endpointList.shares]]"
                 is-authorize="true"
                 handle-as="json"></kazoup-ajax>

    <kazoup-ajax id="deleteShare"
                 method="DELETE"
                 url="[[deleteShareEndpoint(shareId)]]"
                 is-authorize="true"></kazoup-ajax>

  </template>
  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'kazoup-settings-data-sources',
        behaviors: [
          KazoupBehaviors.Util,
          KazoupBehaviors.APIUrls
        ],
        properties: {
          emptyStateVisible: {
            type: Boolean,
            notify: false,
            value: false
          },
          shareId: {
            type: Number,
            notify: false,
            value: null
          },
          shares: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          }
        },
        openScaning: function(e, detail) {
          var url = '/settings/scan';

          if (e.currentTarget.dataset.server) {
            url += '?server=' + e.currentTarget.dataset.server;

            if (e.model && e.model.__data__.item.pending_delete !== 'Deleting') {
              document.location = url;
            }
          } else {
            document.location = url;
          }
        },
        openDeletionDialog: function(e, detail) {
          this.set('shareId', e.model.__data__.item.id);
          this.$.deleteShareDialog.open();
        },
        deleteShare: function() {
          this.$.deleteShare.generateRequest().then(this._handleShareDeletion.bind(this));
        },
        _handleShareDeletion: function(e) {
          if (e.status === 204) {
            this.set('shareId', null);
            this.$.deleteShareDialog.close();
            this.getShares();
            Polymer.dom(document).querySelector('paper-toast').text = 'Share deleted successfully';
            Polymer.dom(document).querySelector('paper-toast').show();
          }
        },
        _handleShares: function(e) {
          if (e && e.response && e.response.results) {
            this.set('shares', e.response.results);

            _.forEach(this.shares, function(share, index) {
              if (share.pending_delete) {
                this.shares[index].pending_delete = 'Deleting';
              } else {
                this.shares[index].pending_delete = undefined;
              }
            }, this);
          }
          this.$.list.fire('iron-resize');
          this.set('emptyStateVisible', !this.shares.length);
        },
        getShares: function() {
          this.set('shares', []);
          this.$.shares.generateRequest().then(this._handleShares.bind(this));
        },
        init: function() {
          this.getShares();
        },
        attached: function() {
          Polymer.dom.flush();

          window.addEventListener('kazoup-settings-data-sources-initialized', this.init.bind(this));
        }
      });
    }());
  </script>
</dom-module>
