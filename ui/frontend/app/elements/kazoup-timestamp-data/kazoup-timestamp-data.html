<dom-module id="kazoup-timestamp-data">
  <script>
    (function() {
      /**
       * makes requests to elasticsearch based on timestampType change
       */
      Polymer({
        is: 'kazoup-timestamp-data',
        behaviors: [
          KazoupBehaviors.NetworkError,
          KazoupBehaviors.APIUrls
        ],
        properties: {
          target: {
            type: String,
            notify: false
          },
          dateRangeData: {
            type: Array,
            notify: true
          },
          timestampKey: {
            type: String,
            notify: false,
            value: 'timestampType'
          }
        },
        _fetchData: function() {
          var timestampType = this._filterConverter.getValue('timestampType');
          var query = {
            'query': {
              'constant_score': {
                'filter': {
                  'bool': {
                    'should': [
                      {
                        'term': {
                          'exists_on_disk': true
                        }
                      },
                      {
                        'exists': {
                          'field': 'archive_complete'
                        }
                      }
                    ],
                    'must': [
                    ]
                  }
                }
              }
            },
            'aggs': {
              'slider_dates': {
                'date_histogram': {
                  'field': timestampType,
                  'interval': 'year'
                }
              }
            },
            'size': 0
          };

          var range = {range: {}};
          range.range[timestampType] = {lt: Date.now()};
          query.query.constant_score.filter.bool.must.push(range);

          qwest.post(
            this.endpointList.ESFiles,
            query,
            {
              dataType: 'json',
              cache: true,
              headers: {
                Accept: 'application/json',
                Authorization: 'JWT ' + localStorage.getItem('authToken')
              }
            }
          ).then(function (xhr, response) {
            // Previously we passed an array full of dates, but the date slider only uses the first one, so we pass an
            // array of only the first possible date
            this.set('dateRangeData', [response.aggregations.slider_dates.buckets[0].key]);
          }.bind(this)).catch(this.handleNetworkError);
        },
        _handleFiltersChanged: function(e) {
          if (_.isEmpty(e.detail)) {
            this._fetchData();
            return;
          }

          _.forEach(e.detail.fieldsChanged, function(filter) {
            if (filter.field === this.timestampKey) {
              this._fetchData();
              return false;
            }
          }, this);
        },
        attached: function() {
          Polymer.dom.flush();

          this._filterConverter = Polymer.dom(document)
            .querySelector(this.target)
            .querySelector('#filterConverter');
          this._filterConverter.addEventListener('filters-changed', this._handleFiltersChanged.bind(this));
        }
      });
    })();
  </script>
</dom-module>
