<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/left-swipe-action/left-swipe-action.html">
<link rel="import" href="../kazoup-filters-converter/kazoup-filters-converter.html">
<link rel="import" href="../kazoup-search-data/kazoup-search-data.html">
<link rel="import" href="../kazoup-search-filters/kazoup-search-filters.html">
<link rel="import" href="../kazoup-empty-state/kazoup-empty-state.html">
<link rel="import" href="../kazoup-checksum-icon/kazoup-checksum-icon.html">
<link rel="import" href="../kazoup-search-sorting/kazoup-search-sorting.html">
<link rel="import" href="../kazoup-timestamp-data/kazoup-timestamp-data.html">
<link rel="import" href="../kazoup-time-range-selector/kazoup-time-range-selector.html">

<dom-module id="kazoup-user-mobile-search">
  <link rel="import" type="css" href="kazoup-user-mobile-search.css">

  <template>

    <neon-animated-pages id="neonPages"
                         class="fit"
                         entry-animation="fade-in-animation"
                         exit-animation="fade-out-animation"
                         selected="[[selected]]">
      <!-- Search / browse view-->
      <neon-animatable>

        <neon-animated-pages id="neonPagesToolbar"
                             entry-animation="fade-in-animation"
                             exit-animation="fade-out-animation"
                             selected="[[selectedToolbar]]">
          <!-- Main toolbar with actions panel -->
          <neon-animatable>
            <paper-toolbar>
              <paper-icon-button icon="arrow-back"
                                 hidden$="[[isRootDirectory]]"
                                 class="arrow-back"
                                 on-tap="goPreviousDirectory"></paper-icon-button>

              <div class="horizontal layout flex placeholder">
                <div class="placeholder-container">
                  <template is="dom-if" if="[[!isRootDirectory]]">
                    <span>[[placeholder]]</span>
                  </template>
                </div>
              </div>

              <div class="actions">
                <paper-icon-button icon="search"
                                   on-tap="openSearch"></paper-icon-button>

                <paper-icon-button on-tap="toggleRightDrawer"
                                   icon="icons:more-vert"
                                   class="cursor-pointer"></paper-icon-button>
              </div>

              <paper-progress id="progressBar"
                              class="middle fit"
                              hidden$="[[!requestInProgress]]"
                              indeterminate></paper-progress>
            </paper-toolbar>
          </neon-animatable>

          <!-- Auxiliar search toolbar -->
          <neon-animatable>
            <paper-toolbar>
              <paper-icon-button icon="arrow-back"
                                 class="arrow-back"
                                 on-tap="goBack"></paper-icon-button>

              <div class="search-box horizontal layout">
                <input id="searchInput"
                       class="flex"
                       is="iron-input"
                       placeholder="[[placeholderInput]]"
                       bind-value="{{q}}">
              </div>
              <div class="actions">
                <paper-icon-button on-tap="toggleRightDrawer"
                                   icon="icons:more-vert"
                                   class="cursor-pointer"></paper-icon-button>
              </div>

              <paper-progress id="progressBar"
                              class="middle fit"
                              hidden$="[[!requestInProgress]]"
                              indeterminate></paper-progress>
            </paper-toolbar>
          </neon-animatable>

          <!-- Checksum search toolbar -->
          <neon-animatable>
            <paper-toolbar>
              <paper-icon-button icon="arrow-back"
                                 class="arrow-back"
                                 on-tap="removeChecksum"></paper-icon-button>

              <div class="horizontal layout flex placeholder">
                <span>Duplicates</span>
              </div>

              <paper-progress id="progressBar"
                              class="middle fit"
                              hidden$="[[!requestInProgress]]"
                              indeterminate></paper-progress>
            </paper-toolbar>
          </neon-animatable>
        </neon-animated-pages>

        <div class="container box vertical layout center-justified">
          <paper-drawer-panel id="rightDrawer"
                              edge-swipe-sensitivity="15"
                              force-narrow="true"
                              right-drawer>
            <!-- Search filters -->
            <paper-header-panel drawer>
              <paper-toolbar id="right-toolbar">
                <template is="dom-if" if="[[browser]]">
                  <paper-icon-button id="fileIcon"
                                     icon="editor:insert-drive-file"
                                     class="cursor-pointer"
                                     on-tap="toggleSearchExplorer"></paper-icon-button>
                </template>

                <template is="dom-if" if="[[!browser]]">
                  <kazoup-search-sorting hidden$="[[browser]]"
                                         target="kazoup-user-mobile-search"></kazoup-search-sorting>

                  <paper-icon-button id="folderIcon"
                                     icon="icons:folder"
                                     class="cursor-pointer"
                                     on-tap="toggleSearchExplorer"></paper-icon-button>
                </template>
              </paper-toolbar>

              <kazoup-search-filters id="kazoupSearchFilters"
                                     target="kazoup-user-mobile-search"></kazoup-search-filters>

            </paper-header-panel>
            <!-- Search results -->
            <paper-scroll-header-panel main>
              <kazoup-empty-state id="noResults"
                                  icon="search"
                                  header="Nope, nothing. Nada."
                                  description="<span>Try another search.</span>"></kazoup-empty-state>

              <iron-list id="results"
                         class$="[[computeIsWiderDevice(tabletScreen)]]"
                         items="[[results]]"
                         as="item">
                <template>
                  <div>
                    <template is="dom-if" if="[[item.size_data]]">
                      <div on-tap="setDirpath"
                           class="center horizontal layout row cursor-pointer">
                        <div class="icon-container">
                          <iron-image src="/static/images/directory-icon.svg"></iron-image>
                        </div>

                        <div class="info flex center-justify">
                          <h4>[[customDirectoryName(item.key)]]</h4>
                          <p>
                            <span>[[bytesToSize(item.size_data.sum)]]</span>,
                            <span>[[item.doc_count]]</span> files
                          </p>
                        </div>
                      </div>
                    </template>

                    <template is="dom-if" if="[[item._type]]">
                      <div class="center horizontal layout row cursor-pointer">
                        <kazoup-checksum-icon id$="[[_computeId(index)]]"
                                              on-tap="openDownloadDialog"
                                              class="icon"
                                              model="[[item]]"></kazoup-checksum-icon>

                        <left-swipe-action on-touchstart="swipeConstraints"
                                           offset$="[[_computeSwipeOffset(item)]]"
                                           class="horizontal layout flex">

                          <div class="info flex center-justify">
                            <h4>[[item._source.metadata.filename]]</h4>
                            <p>
                              <span>[[bytesToSize(item._source.metadata.size)]]</span>, modified
                              <span>[[timeSince(item._source.metadata.modified)]]</span> ago
                            </p>
                          </div>

                          <left-swipe-action-button>
                            <div class="horizontal layout center">
                              <div class="action">
                                <paper-icon-button id="duplicatesIcon"
                                                   src="/static/images/duplicated-file.svg"
                                                   on-tap="setChecksumEvent"></paper-icon-button>
                              </div>

                              <div class="action" hidden$="[[!_computeArchive(item._source.archive_complete)]]">
                                <paper-icon-button icon="icons:cloud-done"
                                                   class="archive-icon"
                                                   data-archive="true"
                                                   on-tap="openDownloadDialog"></paper-icon-button>
                              </div>
                            </div>
                          </left-swipe-action-button>
                        </left-swipe-action>
                      </div>
                    </template>
                    <paper-ripple class="light-background"></paper-ripple>
                  </div>
                </template>
              </iron-list>
            </paper-scroll-header-panel>
          </paper-drawer-panel>
        </div>
      </neon-animatable>
    </neon-animated-pages>

    <paper-dialog id="confirmDownload"
                  entry-animation="scale-up-animation"
                  exit-animation="scale-down-animation"
                  with-backdrop>
      <h2>[[dialogHeader]]</h2>
      <section>
        <p>Are you sure you want to download this file to your mobile device?</p>
      </section>
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-tap="confirmDownload">OK</paper-button>
    </paper-dialog>

    <kazoup-filters-converter id="filterConverter"
                              filters="{{filters}}"></kazoup-filters-converter>

    <kazoup-search-data id="searchData"
                        target="kazoup-user-mobile-search"
                        request-in-progress="{{requestInProgress}}"
                        results="{{results}}"
                        browser="{{browser}}"
                        scroll="{{scroll}}"></kazoup-search-data>

    <kazoup-timestamp-data target="kazoup-user-mobile-search"
                           date-range-data="{{dateRangeData}}"></kazoup-timestamp-data>

    <kazoup-time-range-selector id="timeRangeSelector"
                                target="kazoup-user-mobile-search"
                                date-range-data="[[dateRangeData]]"
                                period="{{period}}"></kazoup-time-range-selector>

    <iron-a11y-keys keys="enter"
                    target="[[searchInputElem]]"
                    on-keys-pressed="search"></iron-a11y-keys>

    <iron-media-query query="max-width: 900px"
                      query-matches="{{tabletScreen}}"></iron-media-query>
    <iron-media-query query="max-width: 360px"
                      query-matches="{{phoneScreen}}"></iron-media-query>

  </template>
  <script>
    'use strict';

    (function() {
      // Recursive function to provide a fitting screen text
      function cropText(text, font, textWidth, availableWidth) {
        if (textWidth > availableWidth) {
          // Still does not fit, keep going croping
          return cropText.call(
            this,
            text.substring(0, text.length - 2),
            font,
            this.getTextWidth(text, font),
            availableWidth
          );
        } else {
          // Now fits the screen
          // Remove last 3 characters and add ' ..'
          return text + ' ..';
        }
      }

      Polymer({
        is: 'kazoup-user-mobile-search',
        behaviors: [
          KazoupBehaviors.Devices,
          KazoupBehaviors.PanelActions,
          KazoupBehaviors.Util
        ],
        properties: {
          selected: {
            type: Number,
            notify: true,
            value: 0
          },
          selectedToolbar: {
            type: Number,
            notify: true,
            value: 0
          },
          isRootDirectory: {
            type: Boolean,
            notify: true
          },
          dialogHeader: {
            type: String,
            notify: false
          },
          checksum: {
            type: String,
            notify: true,
            value: false,
            observer: 'checksumChanged'
          },
          placeholder: {
            type: String,
            notify: true,
            value: ''
          },
          placeholderInput: {
            type: String,
            notify: true,
            value: 'Search all files'
          },
          q: {
            type: String,
            value: ''
          },
          results: {
            type: Array,
            notify:true,
            value: function() {
              return [];
            }
          },
          requestInProgress: {
            type: Boolean,
            notify: true,
            value: true,
            observer: 'requestInProgressChanged'
          },
          searchResultsDetails: {
            type: Object,
            notify: true,
            value: function() {
              return {};
            }
          },
          dateRangeData: {
            type: Array,
            notify: true
          },
          searchInputElem: {
            type: Object,
            notify: false,
            value: function() {
              return this.$.searchInput;
            }
          },
          filters: {
            type: Object,
            notify: true
          },
          browser: {
            type: Boolean,
            notify: true
          }
        },
        requestInProgressChanged: function() {
          if (this.results.length || this.requestInProgress) {
            this.set('$.noResults.hidden', true);
          } else {
            this.set('$.noResults.hidden', false);
          }
        },
        checksumChanged: function(newValue, oldValue) {
          if (this.checksum === undefined || this.checksum === '') {
            this.$.filterConverter.removeValue('checksum', oldValue);
          } else {
            if (typeof this.checksum === 'string') {
              this.$.filterConverter.setValue('checksum', this.checksum);
            }
          }
        },
        openSearch: function(e, detail) {
          this.set('selectedToolbar', 1);
          this.async(function() {
            this.$.searchInput.focus();
          }, 100);
        },
        goBack: function(e, detail) {
          this.$.filterConverter.setValue('q');
          this.set('selectedToolbar', 0);
        },
        goPreviousDirectory: function(e, detail) {
          var path = this.$.filterConverter.getValue('dirpath')[0];
          var index = path.lastIndexOf('/');

          path = path.substring(0, index);
          if (path === '/') {
            path = '//';
            this.async(function() {
              this.set('isRootDirectory', true);
            });
          }

          this.$.filterConverter.setValue('dirpath', path);
        },
        openDownloadDialog: function(e, detail) {
          e.stopPropagation();

          if (e.currentTarget && e.currentTarget.dataset && e.currentTarget.dataset.archive) {
            this.set('dialogHeader', 'Confirm Archive download');
          } else {
            this.set('dialogHeader', 'Confirm download');
          }

          this.model = e.model;
          this.$.confirmDownload.refit();
          this.$.confirmDownload.open();
        },
        confirmDownload: function(e, detail) {
          this.$.confirmDownload.close();
          this.download();
        },
        download: function() {
          var downloadURL = '/download/' +
            this.model.__data__.item.id_b64 + '/' +
            localStorage.getItem('authToken') + '/' +
            this.model.__data__.item._source.metadata.filename_b64 + '/';

          window.open(downloadURL, '_blank');
        },
        toggleSearchExplorer: function() {
          this.browser = !this.browser;
          this.goToNewUrl();
          this.$.results.fire('iron-resize');
        },
        setQ: function() {
          // keep this.q in sync with the value in filter converter
          this.q = this.$.filterConverter.getValue('q');
        },
        setChecksum: function() {
          this.checksum = this.$.filterConverter.getValue('checksum')[0];
        },
        goToNewUrl: function() {
          var routeUrl = '';

          routeUrl = '/search' + '?browser=' + this.browser + '&filters=' + this.$.filterConverter.asQuerystring();
          // Push new state, clear results and make request with updated values
          history.pushState({}, 'Search', routeUrl);
        },
        search: function() {
          document.activeElement.blur();

          // we don't want q to be an empty string, set to undefined to explicitly unset
          this.$.filterConverter.setValue('q', this.q || undefined);
        },
        bytesToSize: function(bytes) {
          if (typeof bytes === 'number') {
            return filesize(bytes);
          }
        },
        updatePlaceholder: function() {
          var customPath = this.$.filterConverter.getValue('dirpath');
          var font = '16px "Gotham Rounded SSm A"';
          var text;
          var availableWidth;

          if (customPath[0] !== undefined) {
            this.set('isRootDirectory', false);

            text = this.customDirectoryName(customPath[0]);
            availableWidth = window.innerWidth - 170; // Width of fixed elements

            if (this.getTextWidth(text, font) > availableWidth && availableWidth > 0) {
              // This is a recursive call to remove characters until all of them
              // fit in the container; see implementation on top
              this.set('placeholder', cropText.call(this, text, font, this.getTextWidth(text, font), availableWidth));
            } else {
              this.set('placeholder', this.customDirectoryName(customPath[0]));
            }

            if (this.placeholder) {
              this.set(
                'placeholderInput',
                'Search in ' + this.placeholder.substring(0, this.placeholder.length - 8) + '..'
              );
            } else {
              this.set('placeholderInput', 'Search all files ');
            }
          } else {
            this.set('isRootDirectory', true);
            this.set('placeholderInput', 'Search all files ');
          }
        },
        setDirpath: function(e, detail) {
          this.$.filterConverter.setValue('dirpath', e.model.__data__.item.key);
        },
        toggleRightDrawer: function() {
          // We do filters request now, so search is decoupled from filters and lighter-weight
          this.$.kazoupSearchFilters.$.searchFiltersData._fetchAllData();

          this.$.rightDrawer.togglePanel();

          // Fix to get the focus on the filtes and be able to scroll them
          this.async(function() {
            Polymer.dom(this.$.kazoupSearchFilters).node.querySelector('#filtersPanel span').click();
          }, 100);
        },
        setChecksumEvent: function(e, detail) {
          if (e.model.__data__.item._source.content.checksum) {
            this.resetSwipeElements();
            this.setCheckumSearch(e.model.__data__.item._source.content.checksum);
            this.set('placeholder', e.model.__data__.item._source.metadata.filename);
            this.set('browser', false);
            this.set('selectedToolbar', 2);
          }
        },
        setCheckumSearch: function(checksum) {
          this.$.filterConverter.saveValues();
          this.checksum = checksum;
          this.$.filterConverter.setValues([{
            field: 'checksum',
            val: checksum
          }], true);
        },
        removeChecksum: function() {
          this.checksum = undefined;
          this.$.filterConverter.setStoredValues();
          this.set('selectedToolbar', 0);
          this.resetSwipeElements();
        },
        swipeConstraints: function(e, detail) {
          var elemIndex = parseInt(e.model.index, 10);
          var event = e;
          var el = e.currentTarget;
          var openNow = el.open;
          var openDelayed;

          this.async(function() {
            // When openNow and openDelayed are not equal, an open / close swipe action had happen
            // In a (false, false) case, user click with itention of opening detail view
            openDelayed = el.open;

            if (openNow === openDelayed) {
              this.openDownloadDialog(event);
            }
          }, 150);

          // Get if we have duplicates for given file from our kazoup-cheksum-icon element
          try {
            this.results[elemIndex].numberOfDuplicates =
              Polymer.dom(this.root).querySelector('#kazoupChecksumIcon' + elemIndex).numberOfDuplicates;
          } catch(e) {}

          // Update / overwrite  swipe offset
          e.currentTarget.set('offset', this._computeSwipeOffset(this.results[elemIndex]));

          this.resetSwipeElements(e.currentTarget);
        },
        resetSwipeElements: function(el) {
          // Closes all swipe elements except the one pass as argument if exists
          _.forEach(
            this.$.results.querySelector('#items').querySelectorAll('left-swipe-action'),
            function(swipeEl) {
              if (!el || !el.isEqualNode(swipeEl)) {
                swipeEl.open = false;
              }

              // offset for swipe could have been updated, so force an UI update to reflect changes
              // if you want more info about the swipe, have a look on its source code
              swipeEl.transition();
            }
          );
        },
        init: function(e) {
          // view param specific for mobile to toggle the search header;
          // only set when coming from analytics
          if (e.data.view === 'search') {
            this.set('selectedToolbar', 1);
          }

          if (e.data.browser !== undefined && e.data.browser !== 'undefined') {
            if (e.data.browser === 'true') {
              e.data.browser = true;
            } else if (e.data.browser === 'false') {
              e.data.browser = false;
            }

            this.set('browser', e.data.browser);
          } else {
            // Default value if not defined in URL
            this.set('browser', false);
          }

          if (e.data.filters) {
            this.set('filters', JSON.parse(e.data.filters));
          } else {
            this.set('filters', {});
          }

          // Updates UI elements with current filters when page loads first time
          if (this.filters) {
            if (this.filters.q) {
              this.q = this.filters.q;
            }
            if (this.filters.checksum) {
              if (this.filters.checksum instanceof Array) {
                this.checksum = this.filters.checksum[0];
              } else {
                this.checksum = this.filters.checksum;
              }
            }
          }
        },
        attached: function() {
          Polymer.dom.flush();

          window.addEventListener('kazoup-user-mobile-search-initialized', this.init.bind(this));

          // filters changed
          this.$.filterConverter.addEventListener('filters-changed', this.goToNewUrl.bind(this));
          this.$.filterConverter.addEventListener('filters-changed', this.setQ.bind(this));
          this.$.filterConverter.addEventListener('filters-changed', this.setChecksum.bind(this));
          this.$.filterConverter.addEventListener('filters-changed', this.updatePlaceholder.bind(this));

          // Infinite scroll
          this.async(function() {
            Polymer.dom(this.$.results).node._scroller.addEventListener('scroll', function(e) {
              var totalHeight = 0,
                viewportPosition = 0;

              this.resetSwipeElements();

              if (!this.requestInProgress) {
                totalHeight =
                  this.results.length *
                  (Polymer.dom(this.$.results).querySelector('.row').offsetHeight || 61);
                viewportPosition =
                  Polymer.dom(this.$.results).node._scroller.scrollTop +
                  Polymer.dom(this.$.results).node._scroller.offsetHeight;

                if (totalHeight - 350 < viewportPosition) {
                  this.scroll = Date.now();
                }
              }
            }.bind(this));
          }, 1000);
        },
        _computeId: function(index) {
          return 'kazoupChecksumIcon' + index;
        },
        _computeArchive: function(archive) {
          return !!archive;
        },
        _computeSwipeOffset: function(model) {
          var offset = this.$.results.getBoundingClientRect().width - 65;

          if (model && model._source && !!model._source.archive_complete) {
            offset -= 50;
          }

          if (model && model.numberOfDuplicates > 1) {
            offset -= 50;
          }

          return offset;
        }
      });
    }());
  </script>
</dom-module>
