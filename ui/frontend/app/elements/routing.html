<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
<script src="../bower_components/page/page.js"></script>
<script>
  'use strict';

  window.Kazoup = window.Kazoup || {};

  Kazoup.router = (function() {
    var wantedURL = null;

    var _routeUnauthenticated = function() {
      // Check token
      if (_checkToken()) {
        // User is authenticated, go to default authenticated section
        _userAuthenticated();
      } else {
        // User is not authenticated, go to default unauthenticated section
        app.route = 'unauthenticate';

        // Config has to be retrieve every single time.
        // This is because appliance can be registered, the user log out.
        // Register appliance will be shown istead, because config state is old and not longer valid
        Kazoup.SharedData.getConfig().then(
          _routeUnauthenticatedSection,
          _errorRetrievingConfig
        );
      }
    };

    var _routeAuthenticatedSection = function(routeSection) {
      var promise = pinkySwear();

      if (_checkToken()) {

        app.route = 'authenticate';

        // Gets config
        Kazoup.SharedData.getConfig()
          .then(
            function() {
              return Kazoup.SharedData.getCurrentUser();
          })
          .then(
            function(e) {
              var intercomData;
              var eventName;

              // Route user permission
              if (Kazoup.SharedData.currentUser.group_name === 'user') {
                app.route = 'authenticate-user';

                if (KazoupBehaviors.Devices.isMobileDevice().any()) {
                  eventName = 'kazoup-user-mobile-search-initialized';
                  app.routeSection = 'authenticate-user-mobile-search';
                } else {
                  eventName = 'kazoup-user-search-initialized';
                  app.routeSection = 'authenticate-user-search';
                }

                Kazoup.SharedData._fireEvent(
                  eventName,
                  Kazoup.router.parseQueryString(decodeURIComponent(page.current.split('&')[1]))
                );

                history.pushState({}, 'Search', '/search');
              } else {
                app.routeSection = routeSection;
              }

              intercomData = Kazoup.SharedData.currentUser.intercom;

              // Default user for demo is info@kazoup.com
              // We do want o use anonymnous user in this case
              if (Kazoup.SharedData.config.APPLIANCE_IS_DEMO) {
                intercomData = {
                  app_id: '765edcee587b03dba65dcf9c8b7ea0b1f488a7c5',
                  widget: {
                    activator: '#intercom_support'
                  }
                };
              } else {
                intercomData.widget = {
                  activator: '#intercom_support'
                };
              }

              window.Intercom('boot', intercomData);

              promise(true, []);
            },
            _userNotAuthenticated
          );
      } else {
        // Store wanted url althou user is not authenticated
        // After authentication, this url will be forwarded; see
        wantedURL = page.current;
        _userNotAuthenticated();
        promise(true, []);
      }

      return promise;
    };

    var _validateDemoDetails = function(user) {
      var promise = pinkySwear();

      qwest.get(
        KazoupBehaviors.APIUrls.userLoginDemo(user),
        {},
        {
          dataType: 'json',
          cache: true,
          headers: {
            Accept: 'application/json'
          }
        }
      ).then(function(xhr, response) {
        var gaScript;

        localStorage.setItem('authToken', response.token);

        // Load google Analytics after demo validation
        gaScript = document.createElement('script');
        gaScript.type = 'text/javascript';
        gaScript.async = true;
        gaScript.src = '/scripts/googleAnalytics.js';
        Polymer.dom(document).querySelector('head').appendChild(gaScript);

        promise(true, [response]);
      }).catch(function(xhr, response, e) {
        promise(false, [e]);
      });

      return promise;
    };

    var _getWantedURL = function() {
      return wantedURL;
    };

    var _resetWantedURL = function() {
      wantedURL = null;
    };

    function _userAuthenticated() {
      page(app.baseUrl + 'dashboard');
    }

    function _userNotAuthenticated() {
      page(app.baseUrl);
    }

    function _checkToken() {
      var token = localStorage.getItem('authToken');

      if (token && token.length > 0) {
        return true;
      } else {
        return false;
      }
    }

    function _routeUnauthenticatedSection(config) {
      if (config.APPLIANCE_IS_DEMO) {
        app.routeSection = 'unauthenticate-register-demo';
      } else if (!config.APPLIANCE_IS_REGISTERED) {
        app.routeSection = 'unauthenticate-register-appliance';
      } else if (config.APPLIANCE_IS_REGISTERED) {
        Polymer.dom(document).querySelector('kazoup-login').reset();
        app.routeSection = 'unauthenticate-login';
      }
    }

    function _errorRetrievingConfig() {
      Polymer.dom(document).querySelector('#paperToast').text = 'Error retrieving config. Please try again.';
      Polymer.dom(document).querySelector('#paperToast').show();
    }

    function _parseQueryString(queryString) {
      var params = queryString.split('&');
      var paramsObj = {};
      var keyValue;

      if (queryString.length) {
        _.forEach(params, function(param) {
          keyValue = param.split('=');

          paramsObj[keyValue[0]] = decodeURIComponent(keyValue[1]);
        });
      }

      return paramsObj;
    }

    return {
      routeUnauthenticated: _routeUnauthenticated,
      routeAuthenticatedSection: _routeAuthenticatedSection,
      validateDemoDetails: _validateDemoDetails,
      getWantedURL: _getWantedURL,
      resetWantedURL: _resetWantedURL,
      parseQueryString: _parseQueryString
    };
  }());

  window.addEventListener('WebComponentsReady', function() {

    // We use Page.js for routing. This is a Micro
    // client-side router inspired by the Express router
    // More info: https://visionmedia.github.io/page.js/

    // Removes end / from app.baseUrl which page.base requires for production
    if (window.location.port === '') {  // if production
      page.base(app.baseUrl.replace(/\/$/, ''));
    }

    // Routes
    page('*', function(ctx, next) {
      next();
    });

    page(app.baseUrl, function() {
      // Clear user eveytime user ends in login, that ensures identity is always correct
      Kazoup.SharedData.currentUser = {};

      Kazoup.router.routeUnauthenticated();
    });

    page('/restore', function() {
      app.route = 'unauthenticate';
      app.routeSection = 'unauthenticate-restore-appliance';
    });

    page('/demo/login/*', function(data) {
      Kazoup.router.validateDemoDetails(data.querystring).then(
        function(e) {
          page('/dashboard');
        },
        function(e) {
          page('/');
        }
      );
    });

    page('/dashboard', function(data) {
      Kazoup.router.routeAuthenticatedSection('authenticate-dashboard').then(function() {
        Kazoup.SharedData._fireEvent(
          'kazoup-dashboard-initialized',
          Kazoup.router.parseQueryString(data.querystring)
        );
      });
    });

    page('/analytics', function(data) {
      var routeAuthenticatedName;
      var eventName;
      var safeQueryString = data.path; //https://github.com/visionmedia/page.js/issues/216

      // take out '/analytics?' part
      safeQueryString = safeQueryString.substring(11, safeQueryString.length);

      if (KazoupBehaviors.Devices.isMobileDevice().any()) {
        routeAuthenticatedName = 'authenticate-mobile-analytics';
        eventName = 'kazoup-mobile-analytics-initialized';
      } else {
        routeAuthenticatedName = 'authenticate-analytics';
        eventName = 'kazoup-analytics-initialized';
      }

      Kazoup.router.routeAuthenticatedSection(routeAuthenticatedName).then(function() {
        Kazoup.SharedData._fireEvent(
          eventName,
          Kazoup.router.parseQueryString(safeQueryString)
        );
      });
    });

    page('/search', function(data) {
      var routeAuthenticatedName;
      var eventName;
      var safeQueryString = data.path; //https://github.com/visionmedia/page.js/issues/216

      // take out '/search?' part
      safeQueryString = safeQueryString.substring(8, safeQueryString.length);

      if (KazoupBehaviors.Devices.isMobileDevice().any()) {
        routeAuthenticatedName = 'authenticate-mobile-search';
        eventName = 'kazoup-mobile-search-initialized';
      } else {
        routeAuthenticatedName = 'authenticate-search';
        eventName = 'kazoup-search-initialized';
      }

      Kazoup.router.routeAuthenticatedSection(routeAuthenticatedName).then(function() {
        Kazoup.SharedData._fireEvent(
          eventName,
          Kazoup.router.parseQueryString(safeQueryString)
        );
      });
    });

    page('/settings', function(data) {
      Kazoup.router.routeAuthenticatedSection('authenticate-settings').then(function() {
        Kazoup.SharedData._fireEvent(
          'kazoup-settings-initialized',
          Kazoup.router.parseQueryString(data.querystring)
        );
      });
    });

    page('/settings/scan', function(data) {
      Kazoup.router.routeAuthenticatedSection('authenticate-settings-scan').then(function() {
        Kazoup.SharedData._fireEvent(
          'kazoup-settings-scan-initialized',
          Kazoup.router.parseQueryString(data.querystring)
        );
      });
    });

    page('/logs', function(data) {
      Kazoup.router.routeAuthenticatedSection('authenticate-logs').then(function() {
        Kazoup.SharedData._fireEvent(
          'kazoup-logs-initialized',
          Kazoup.router.parseQueryString(data.querystring)
        );
      });
    });

    page('/docs', function(data) {
      Kazoup.router.routeAuthenticatedSection('authenticate-docs').then(function() {
        Kazoup.SharedData._fireEvent(
          'kazoup-docs-initialized',
          Kazoup.router.parseQueryString(data.querystring)
        );
      });
    });

    page('/user/search', function() {
      app.route = 'authenticate-user';
    });

    // 404
    page('*', function() {

    });

    // add #! before urls
    page({
      hashbang: false
    });
  });
</script>
-->
