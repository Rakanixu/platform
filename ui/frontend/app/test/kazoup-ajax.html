<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-ajax</title>

  <script src="/app/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/app/bower_components/web-component-tester/browser.js"></script>

  <!-- Tests dependencies -->
  <script src="../bower_components/PinkySwear.js/pinkyswear.min.js"></script>
  <script src="../bower_components/page/page.js"></script>

  <link rel="import" href="../elements/kazoup-ajax/kazoup-ajax.html">

  <!-- Every single element can refer to the unique papaer-toast in the app-->
  <!-- Error Ui handling is unified this way. Paper toast need to exists on these tests -->
  <paper-toast id="paperToast"></paper-toast>

</head>
<body>

  <kazoup-ajax id="fixture"></kazoup-ajax>

  <script>
    suite('<kazoup-ajax>', function() {
      var el = document.querySelector('#fixture');
      var params = {
        param1: 'value1',
        param2: 'value2'
      };
      var response = {
        count: 2,
        hits: [
          'value1',
          'value2'
        ]
      };
      var error = {
        error: 'API error'
      };
      var server, stub;

      function resetElement() {
        el.$.ironAjax.body = undefined;
      }

      function runFakeServer() {
        server = sinon.fakeServer.create();

        server.respondWith(
          'GET',
          '/get_endpoint',
          [
            200,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(response)
          ]
        );

        server.respondWith(
          'POST',
          '/post_endpoint',
          [
            200,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(response)
          ]
        );

        server.respondWith(
          'PUT',
          '/put_endpoint',
          [
            200,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(response)
          ]
        );

        server.respondWith(
          'DELETE',
          '/delete_endpoint',
          [
            200,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(response)
          ]
        );

        server.respondWith(
          '/error_api_endpoint',
          [
            400,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(error)
          ]
        );

        server.respondWith(
          'POST',
          '/not_authorize_endpoint',
          [
            401,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(error)
          ]
        );

        server.respondWith(
          'POST',
          '/internal_server_error_endpoint',
          [
            500,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(error)
          ]
        );
      }

      function restoreFakeServer() {
        server.restore();
      }

      function setSpy() {
        sinon.spy(el, 'handleResponse');
        sinon.spy(el, 'handleError');
      }

      function unsetSpy() {
        el.handleResponse.restore();
        el.handleError.restore();
      }

      function setStub() {
        sinon.spy(el, 'handleError');
        sinon.stub(window, 'page', function() {});
        sinon.stub(Polymer, 'dom', function(param) {
          return {
            querySelector: function(param) {
              return {
                text: 'text',
                show: function() {}
              }
            }
          }
        });
      }

      function unsetStub() {
        el.handleError.restore();
        window.page.restore();
        Polymer.dom.restore();
      }

      suite('setParams', function() {
        setup(resetElement);

        test('should set params as a query string', function() {
          el.setParams(params);

          assert.isString(el.$.ironAjax.body);
        });
      });

      suite('setParamsAsObj', function() {
        setup(resetElement);

        test('should set params as an object', function() {
          el.setParamsAsObj(params);

          assert.deepEqual(el.$.ironAjax.body, params);
        });
      });

      suite('generateRequest (functional success)', function() {
        setup(function() {
          resetElement();
          setSpy();
          runFakeServer();
        });

        teardown(function() {
          unsetSpy();
          restoreFakeServer();
        });

        test('should generate a GET http request', function(done) {
          el.url = '/get_endpoint';
          el.method = 'GET';
          el.generateRequest().then(function(e) {
            assert(el.handleError.notCalled);
            assert(el.handleResponse.calledOnce);
            assert.deepEqual(e.response, response);
            assert.equal(e.status, 200);

            done();
          });

          server.respond();
        });

        test('should generate a POST http request', function(done) {
          el.url = '/post_endpoint';
          el.method = 'POST';
          el.generateRequest().then(function(e) {
            assert(el.handleError.notCalled);
            assert(el.handleResponse.calledOnce);
            assert.deepEqual(e.response, response);
            assert.equal(e.status, 200);

            done();
          });

          server.respond();
        });

        test('should generate a PUT http request', function(done) {
          el.url = '/put_endpoint';
          el.method = 'PUT';
          el.generateRequest().then(function(e) {
            assert(el.handleError.notCalled);
            assert(el.handleResponse.calledOnce);
            assert.deepEqual(e.response, response);
            assert.equal(e.status, 200);

            done();
          });

          server.respond();
        });

        test('should generate a DELETE http request', function(done) {
          el.url = '/delete_endpoint';
          el.method = 'DELETE';
          el.generateRequest().then(function(e) {
            assert(el.handleError.notCalled);
            assert(el.handleResponse.calledOnce);
            assert.deepEqual(e.response, response);
            assert.equal(e.status, 200);

            done();
          });

          server.respond();
        });

        test('should generate a http request retrieving API error', function(done) {
          el.url = '/error_api_endpoint';
          el.generateRequest().then(function(e) {
            assert(el.handleResponse.notCalled);
            assert(el.handleError.calledOnce);
            assert.deepEqual(e.response, error);
            assert.equal(e.status, 400);

            done();
          });

          server.respond();
        });
      });

      suite('generateRequest (functional fail)', function() {
        setup(function() {
          resetElement();
          setStub();
          runFakeServer();
        });

        teardown(function() {
          unsetStub();
          restoreFakeServer();
        });

        test('should generate a GET http request retrieving not authorize error', function(done) {
          el.url = '/not_authorize_endpoint';
          el.method = 'POST';
          el.generateRequest().then(
            function(e) {},
            function(e) {
              assert(el.handleError.calledOnce);
              assert(window.page.calledOnce);
              assert(Polymer.dom.notCalled);
              assert.equal(e.status, 401);
              assert.equal(localStorage.getItem('authToken'), null);

              done();
            }
          );

          server.respond();
        });

        test('should generate a GET http request retrieving server internal error', function(done) {
          el.url = '/internal_server_error_endpoint';
          el.method = 'POST';
          el.generateRequest().then(
            function(e) {},
            function(e) {
              assert(el.handleError.calledOnce);
              assert(window.page.notCalled);
              assert(Polymer.dom.calledTwice);
              assert.equal(e.status, 500);

              done();
            }
          );

          server.respond();
        });
      });
    });
  </script>
</body>
</html>
