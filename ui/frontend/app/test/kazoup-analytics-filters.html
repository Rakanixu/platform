<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-ajax</title>

  <script src="/app/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/app/bower_components/web-component-tester/browser.js"></script>

  <!-- Tests dependencies -->
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-analytics-filters/kazoup-analytics-filters.html">


</head>
<body>

<kazoup-analytics-filters id="fixture"></kazoup-analytics-filters>

<script>
  suite('<kazoup-analytics-filters>', function() {
    var el = document.querySelector('#fixture');
    var domAPIMock;
    var width = 100;
    var domEl = {
      getBoundingClientRect: function() {
        return {
          width: width
        }
      },
      style: {
        transform: ''
      }
    };

    setup(function() {
      sinon.stub(Polymer, 'dom', function(param) {
        return {
          flush: function() {},
          querySelector: function(param) {
            return domEl;
          },
          querySelectorAll: function(param) {
            return [domEl, domEl];
          },
          classList: {
            add: function(param) {},
            remove: function(param) {}
          }
        }
      });
    });

    teardown(function() {
      Polymer.dom.restore();
    });

    suite('setFiltersWidth', function() {
      test('should set filters width', function() {
        el.setFiltersWidth();

        assert(Polymer.dom.calledOnce);
        assert.equal(el.filtersUI.filtersWidth, 202);
      });
    });

    suite('setFiltersContainerWidth', function() {
      setup(function() {
        sinon.spy(el.$.filters, 'querySelector');
      });

      teardown(function() {
        el.$.filters.querySelector.restore();
      });

      test('should set filters container width', function() {
        el.setFiltersContainerWidth();

        assert(el.$.filters.querySelector.calledOnce);
        assert.isAbove(el.filtersUI.containerWidth, 0);
      });
    });

    suite('getFiltersDimensions', function() {

      setup(function() {
        sinon.stub(el, 'setFiltersContainerWidth', function() {});
        sinon.stub(el, 'setFiltersWidth', function() {});
        sinon.stub(el, 'resetFiltersTranslation', function() {});
        // Polymer is calling 'node.removeAttribute' when setting 'filtersUI.arrowsVisible'
        // and node is undefined
        // Why is not failing on previous tests? Fuck knows, it's just a setter notifying observers
        // BTW stub as dirty workaround to set values
        sinon.stub(el, 'set', function(arg1, arg2) {
          var aux = arg1.split('.');
          el[aux[0]][aux[1]] = arg2;
        });
      });

      teardown(function() {
        el.setFiltersContainerWidth.restore();
        el.setFiltersWidth.restore();
        el.resetFiltersTranslation.restore();
        el.set.restore();
      });

      test('should set arrowsVisible to true & remove "fit" class', function(done) {
        el.filtersUI.filtersWidth = 200;
        el.filtersUI.containerWidth = 100;
        el.getFiltersDimensions();

        setTimeout(function() {
          assert(el.setFiltersContainerWidth.calledOnce);
          assert(el.setFiltersWidth.calledOnce);
          assert(Polymer.dom.calledOnce);
          assert(el.set.calledOnce);
          assert.isTrue(el.filtersUI.arrowsVisible);
          done();
        }, 1100);
      });

      test('should set arrowsVisible to false & add "fit" class', function(done) {
        el.filtersUI.filtersWidth = 100;
        el.filtersUI.containerWidth = 200;
        el.getFiltersDimensions();

        setTimeout(function() {
          assert(el.setFiltersContainerWidth.calledOnce);
          assert(el.setFiltersWidth.calledOnce);
          assert(Polymer.dom.calledOnce);
          assert(el.set.calledOnce);
          assert(el.resetFiltersTranslation.calledOnce);
          assert.isFalse(el.filtersUI.arrowsVisible);
          done();
        }, 1100);
      });
    });

    suite('translateFilters', function() {
      setup(function() {
        sinon.stub(el, 'setFiltersContainerWidth', function() {});
        sinon.stub(el, 'setFiltersWidth', function() {});
      });

      teardown(function() {
        el.setFiltersContainerWidth.restore();
        el.setFiltersWidth.restore();
      });

      test('should not move filters container', function() {
        el.filtersUI.filtersWidth = 100;
        el.filtersUI.containerWidth = 200;
        el.translateFilters({
          currentTarget: {
            dataset: {
              orientation: 'left'
            }
          }
        });

        assert(el.setFiltersContainerWidth.calledOnce);
        assert(el.setFiltersWidth.calledOnce);
        assert(Polymer.dom.notCalled);
      });

      test('should move filters container to the left', function() {
        el.filtersUI.filtersWidth = 200;
        el.filtersUI.containerWidth = 100;
        el.translateFilters({
          currentTarget: {
            dataset: {
              orientation: 'left'
            }
          }
        });

        assert(el.setFiltersContainerWidth.calledOnce);
        assert(el.setFiltersWidth.calledOnce);
        assert(Polymer.dom.calledOnce);
      });

      test('should move filters container to the right', function() {
        el.filtersUI.filtersWidth = 200;
        el.filtersUI.containerWidth = 100;
        el.translateFilters({
          currentTarget: {
            dataset: {
              orientation: 'right'
            }
          }
        });

        assert(el.setFiltersContainerWidth.calledOnce);
        assert(el.setFiltersWidth.calledOnce);
        assert(Polymer.dom.calledOnce);
      });
    });

    suite('resetFiltersTranslation', function() {
      test('should reset filters translation to default (not translated)', function() {
        el.resetFiltersTranslation();

        assert(Polymer.dom.calledOnce);
        assert.equal(el.xTranslation, 0);
      });
    });

    suite('removeFilter', function() {
      var event = {
        model: {
          __data__: {
            item: {
              filterObj: 'filterValue'
            }
          }
        }
      };

      setup(function() {
        // Object does not exist in unit tests scope, so we define for testing purposes
        el._d3Charts = {
          removeFilter: function() {}
        };

        sinon.stub(el._d3Charts, 'removeFilter', function(args) {});
      });

      teardown(function() {
        el._d3Charts.removeFilter.restore();
      });

      test('should call "el._d3Charts.removeFilter" ', function() {
        el.removeFilter(event);

        assert(el._d3Charts.removeFilter.withArgs(event.model.__data__.item));
      });
    });

    suite('removeFilter', function() {
      var event = {
        model: {
          __data__: {
            item: {
              filterObj: 'filterValue'
            }
          }
        }
      };

      setup(function() {
        // Object does not exist in unit tests scope, so we define for testing purposes
        el._d3Charts = {
          removeFilter: function() {}
        };

        sinon.stub(el._d3Charts, 'removeFilter', function(args) {});
      });

      teardown(function() {
        el._d3Charts.removeFilter.restore();
      });

      test('should call "el._d3Charts.removeFilter" ', function() {
        el.removeFilter(event);

        assert(el._d3Charts.removeFilter.withArgs(event.model.__data__.item));
      });
    });

    suite('_handleFiltersChanged', function() {
      var filters = {
        "from":"now-26y/d",
        "to":"now-0y/d",
        "extension":[".pst"],
        "unique":["unique"],
        "q":"file"
      };

      setup(function() {
        el._filterConverter = {
          asObj: function() {}
        };

        sinon.mock(el._filterConverter).expects('asObj').once().returns(filters);
        sinon.stub(el, 'getFiltersDimensions', function() {});
      });

      teardown(function() {
        el._filterConverter.asObj.restore();
        el.getFiltersDimensions.restore();
      });

      test('should update filtersArray with filters from filterConverter', function() {
        el._handleFiltersChanged();

        assert(el.getFiltersDimensions.calledOnce);
        assert.equal(el.filtersArray.length, 3);
      });
    });
  });
</script>
</body>
</html>
