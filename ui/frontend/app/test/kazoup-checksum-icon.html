<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-checksum-icon</title>

  <script src="/app/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/app/bower_components/web-component-tester/browser.js"></script>

  <!-- Tests dependencies -->
  <!--<link rel="import" href="/app/bower_components/polymer/polymer.html">-->
  <script src="/app/bower_components/qwest/qwest.min.js"></script>
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-checksum-icon/kazoup-checksum-icon.html">

</head>
<body>

<kazoup-checksum-icon id="fixture"></kazoup-checksum-icon>

<script>
  suite('<kazoup-checksum-icon>', function() {
    var el = document.querySelector('#fixture');
    var server;
    var response = {
      hits: {
        total: 2
      }
    };

    suite('modelChanged', function() {
      setup(function() {
        server = sinon.fakeServer.create();

        server.respondWith(
          'POST',
          '/api/v1/elasticsearch/files/?search_type=count&query_cache=true&format=json',
          [
            200,
            {
              'Content-Type': 'application/json'
            },
            JSON.stringify(response)
          ]
        );
        sinon.spy(window.qwest, 'post');
      });

      teardown(function() {
        server.restore();
        window.qwest.post.restore();
      });

      test('should not query number of duplicates', function() {
        el.modelChanged();

        assert(window.qwest.post.notCalled);

        server.respond();
      });

      test('should set numberOfDuplicates', function(done) {
        el.modelChanged({
          _source: {
            content: {
              checksum: 'checksum'
            }
          }
        });

        setTimeout(function() {
          assert(window.qwest.post.calledOnce);
          assert.equal(el.numberOfDuplicates, response.hits.total);

          done();
        }, 200);

        server.respond();
      });
    });

    suite('crop', function() {
      var extension = '.ext';
      var lenght;
      var result;

      test('should return empty string', function() {
        lenght = 3;
        result = el.crop(extension, lenght);

        assert.equal(result, '');
      });

      test('should return the string', function() {
        lenght = 6;
        result = el.crop(extension, lenght);

        assert.equal(result, extension);
      });
    });

    suite('_computeDuplicates', function() {
      var result;

      test('should return true', function() {
        result = el._computeDuplicates(2);

        assert.isTrue(result);
      });

      test('should return false', function() {
        result = el._computeDuplicates(1);

        assert.isFalse(result);
      });
    });

    suite('_showNumberOfDuplicates', function() {
      var result;

      test('should return number of duplicates', function() {
        result = el._showNumberOfDuplicates(2);

        assert.equal(result, 2);
      });

      test('should return empty string', function() {
        result = el._showNumberOfDuplicates(1);

        assert.equal(result, '');
      });
    });

    suite('_showExtension', function() {
      var result;
      var model = {
        _source: {}
      };

      setup(function() {
        sinon.stub(el, 'crop', function() {});
      });

      teardown(function() {
        el.crop.restore();
      });

      test('should do nothing', function() {
        result = el._showExtension(model);

        assert(el.crop.notCalled);
      });

      test('should call crop method', function() {
        model._source.metadata = {
          extension: '.ext'
        };
        result = el._showExtension(model);

        assert(el.crop.calledOnce);
      });
    });
  });
</script>
</body>
</html>
