<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-d3-histogram</title>

  <script src="/app/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/app/bower_components/web-component-tester/browser.js"></script>

  <!-- Tests dependencies -->
  <link rel="import" href="/app/bower_components/polymer/polymer.html">
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-d3-histogram/kazoup-d3-histogram.html">

</head>
<body>

<kazoup-d3-histogram id="fixture"></kazoup-d3-histogram>

<svg id="paper1"><title>svg</title></svg>

<script>
  suite('<kazoup-d3-histogram>', function() {
    var el = document.querySelector('#fixture');
    var histogramData = [{"time":1293840000000,"count":57,"total":31641934,"size_human":30.18,"size_human_measure":"MB"},{"time":1325376000000,"count":42,"total":31545856,"size_human":30.08,"size_human_measure":"MB"},{"time":1356998400000,"count":22,"total":409791,"size_human":400.19,"size_human_measure":"KB"},{"time":1388534400000,"count":42,"total":1340839,"size_human":1.28,"size_human_measure":"MB"},{"time":1420070400000,"count":210958,"total":143805477086,"size_human":133.93,"size_human_measure":"GB"},{"time":1451606400000,"count":33886,"total":14537753185,"size_human":13.54,"size_human_measure":"GB"}];

    function setStubPolymerDOM_API() {
      var domEl = {
        querySelector: qSelector, // For chainability
        querySelectorAll: qSelectorAll,
        remove: function() {},
        getBoundingClientRect: function() {
          return {
            width: 0,
            height: 0
          };
        },
        classList: {
          add: function() {},
          remove: function() {}
        }
      };

      function qSelector() {
        return domEl;
      }

      function qSelectorAll() {
        return [
          domEl
        ];
      }

      sinon.stub(Polymer, 'dom', function(param) {
        return {
          querySelector: qSelector,
          querySelectorAll: qSelectorAll
        };
      });
    }

    function restoreStubPolymerDOM_API() {
      Polymer.dom.restore();
    }

    suite('histogramDataChanged', function() {
      setup(function() {
        sinon.stub(el, 'prepare', function(){});
      });

      teardown(function() {
        el.prepare.restore();
      });

      test('should call "prepare" method', function() {
        el.histogramDataChanged(histogramData, []);

        assert(el.prepare.calledOnce);
      });

      test('should not call "prepare" method', function() {
        el.histogramDataChanged([], undefined);

        assert(el.prepare.notCalled);
      });
    });

    suite('prepare', function() {
      setup(function() {
        setStubPolymerDOM_API();
        sinon.stub(el, 'renderBarChart', function() {});
      });

      teardown(function() {
        restoreStubPolymerDOM_API();
        el.renderBarChart.restore();
      });

      test('should call "renderBarChart" method', function() {
        el.prepare();

        assert(el.renderBarChart.calledOnce);
      });
    });

    suite('renderBarChart', function() {
      var svg = d3.select(document.querySelector('#paper1'));

      setup(function() {
        sinon.stub(el, 'histogramDataChanged', function(){});
        setStubPolymerDOM_API();
      });

      teardown(function() {
        el.histogramDataChanged.restore();
        restoreStubPolymerDOM_API();
      });

      test('should render a histogram chart', function() {
        el.histogramData = histogramData;

        el.renderBarChart(svg, histogramData, 500, 500);

        assert(
          svg.select('g.bars').selectAll('rect')[0].length,
          histogramData.length
        );
      });
    });

    suite('setTimestampType', function() {
      var event = {
        target: {
          dataset: {
            timestampType: 'modified'
          }
        }
      };

      el._filterConverter = {};
      el._filterConverter.setValues = function() {};
      el._filterConverter.getValue = function() {};

      setup(function() {
        sinon.stub(el._filterConverter, 'setValues', function() {});
      });

      teardown(function() {
        el._filterConverter.setValues.restore();
      });

      test('should set a timestampType on filter converter', function() {
        el.setTimestampType(event);

        assert.equal(el.timestampType, event.target.dataset.timestampType);
        assert(el._filterConverter.setValues.calledWith([
          {
            field: 'timestampType',
            val: event.target.dataset.timestampType
          }
        ]));
      });
    });

    suite('_handleTimestampChanged', function() {
      var timestampType = 'accessed';

      setup(function() {
        setStubPolymerDOM_API();
        sinon.stub(el._filterConverter, 'getValue', function() {
          return timestampType;
        });
      });

      teardown(function() {
        restoreStubPolymerDOM_API();
        el._filterConverter.getValue.restore();
      });

      test('should update <.timestamp-container> class', function() {
        el._handleTimestampChanged();

        assert(Polymer.dom.calledTwice);
        assert(el._filterConverter.getValue.calledOnce);
        assert.equal(el.timestampType, timestampType);
      });
    });
  });
</script>
</body>
</html>
