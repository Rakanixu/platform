<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-form</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>

  <!-- Import the element to test -->
  <script src="../bower_components/PinkySwear.js/pinkyswear.min.js"></script>
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-form/kazoup-form.html">
</head>
<body>

  <kazoup-form id="fixture"></kazoup-form>

  <script>

    suite('<kazoup-form>', function() {
      var el = document.querySelector('#fixture');
      var fields = [
        {
          'attr': 'type',
          'type': 'choice',
          'required': true,
          'read_only': false,
          'label': 'Provider',
          'max_length': 256,
          'choices': [
            {
              'display_name': 'Amazon S3',
              'value': 's3'
            },
            {
              'display_name': 'Microsoft Azure',
              'value': 'azure'
            }
          ]
        },
        {
          'attr': 'access_key',
          'type': 'password',
          'required': true,
          'read_only': false,
          'label': 'Access key',
          'max_length': 256
        },
        {
          'attr': 'secret_key',
          'type': 'password',
          'required': true,
          'read_only': false,
          'label': 'Secret key',
          'max_length': 256
        },
        {
          'attr': 'container_name',
          'type': 'string',
          'required': true,
          'read_only': false,
          'label': 'Container name',
          'max_length': 128
        },
        {
          'attr': 'encryption_key',
          'type': 'password',
          'required': true,
          'read_only': false,
          'label': 'Encryption key',
          'max_length': 128
        }
      ];

      function setFields() {
        el.fields = fields;
      }

      suite('choiceSelectedChanged', function() {
        setup(setFields);

        test('should update "choiceValue"', function() {
          el.lastChoiceFieldModified = el.fields[0];
          el.choiceSelected = 1;

          assert.equal(el.fields[0].choiceValue, el.choiceSelected);
        });
      });

      suite('getElement', function() {
        test('should set "lastChoiceFieldModified" to selected choice field', function() {
          el.getElement({
            model: {
              __data__: {
                item: {
                  attr: fields[0].attr
                }
              }
            }
          });

          assert.deepEqual(el.lastChoiceFieldModified, fields[0]);
        });
      });

      suite('setChoiceValue', function() {
        test('should set selected index to "field.choiceValue"', function() {
          el.setChoiceValue(1);

          assert.equal(el.fields[0].choiceValue, 1);
        });
      });

      suite('submitForm', function() {
        setup(function() {
          sinon.stub(el.$.kazoupSubmitButton, 'submitForm', function() {});
        });

        teardown(function() {
          el.$.kazoupSubmitButton.submitForm.restore();
        });

        test('should shoud submit form', function() {
          el.submitForm();

          assert(el.$.kazoupSubmitButton.submitForm.calledOnce);
        });
      });

      suite('init', function() {
        setup(function() {
          localStorage.setItem('authToken', 'tokenValue');
        })

        suite('when fields are pass as argument', function() {
          setup(setFields);

          test('should initialize the form', function() {
            el.init();

            assert.equal(el.buildFromOptions, false);
            assert.deepEqual(el.fields, fields);
          });
        });

        suite('when fields are retieved from OPTIONS (API)', function() {
          var server;

          setup(function() {
            el.fields = [];
            el.url = '/retrieve_options';

            server = sinon.fakeServer.create();

            server.respondWith(
              'OPTIONS',
              '/retrieve_options',
              [
                200,
                {
                  'Content-Type': 'application/json'
                },
                JSON.stringify(fields)
              ]
            );
          });

          test('should initialize the form', function(done) {
            el.init();

            setTimeout(function() {
              assert.equal(el.buildFromOptions, true);

              done();
            }, 200);

            server.respond();
          });
        });
      });
    });
  </script>
</body>
</html>
