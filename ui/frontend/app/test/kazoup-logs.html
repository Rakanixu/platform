<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-logs</title>

  <script src="/app/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="/app/bower_components/web-component-tester/browser.js"></script>

  <!-- Tests dependencies -->
  <script src="../bower_components/PinkySwear.js/pinkyswear.min.js"></script>
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-logs/kazoup-logs.html">


</head>
<body>

<kazoup-logs id="fixture"></kazoup-logs>

<script>
  suite('<kazoup-logs>', function() {
    var el = document.querySelector('#fixture');

    suite('categoryChanged', function() {
      setup(function() {
        sinon.stub(el, 'getLogs', function() {});
      });

      teardown(function() {
        el.getLogs.restore();
      });

      test('should call "getLogs"', function() {
        el.categoryChanged('Configuration', '*');

        assert(el.getLogs.calledOnce);
      });
    });

    suite('scrollChanged', function() {
      var from;

      setup(function() {
        from = el.from;

        sinon.stub(el.$.auditTrail, 'setParamsAsObj', function() {});
        sinon.stub(el.$.auditTrail, 'generateRequest', function() {
          return {
            then: function() {}
          }
        });
      });

      teardown(function() {
        el.$.auditTrail.setParamsAsObj.restore();
        el.$.auditTrail.generateRequest.restore();
      });

      test('should request for next logs page', function() {
        el.scrollChanged(new Date(), new Date());

        assert.equal(el.from, from + 20);
        assert(el.$.auditTrail.setParamsAsObj.calledOnce);
        assert(el.$.auditTrail.generateRequest.calledOnce);
      });
    });

    // http://philipwalton.com/articles/how-to-unit-test-private-functions-in-javascript/
    // In that post specifies how to test private methods in an elegant way.
    // We can take this approach once I finish first round unit test,
    // and we come back to improve the tests
    suite('generateCSV', function() {

    });

    suite('getElasticParams', function() {
      var category = 'Authentication';
      var fromDate = 'now-1w';
      var toDate = 'now';
      var q = 'search term';
      var from = 0;

      setup(function() {
        el.category = category;
        el.fromDate = fromDate;
        el.toDate = toDate;
        el.q = q;
        el.from = from;

        sinon.stub(el, 'getLogs', function() {});
      });

      teardown(function() {
        el.getLogs.restore();
      });

      test('should return Elastic search query', function() {
        var result = el.getElasticParams();

        assert.deepEqual(result, JSON.stringify({
          "from": from,
          "size":20,
          "query":{
            "filtered":{
              "filter":{
                "bool":{
                  "must":[
                    {
                      "term":{
                        "category": category
                      }
                    },
                    {
                      "range":{
                        "timestamp":{
                          "gte": fromDate,
                          "lte": toDate
                        }
                      }
                    }
                  ]
                }
              },
              "query":{
                "match":{
                  "message":{
                    "query": q,
                    "type":"phrase"
                  }
                }
              }
            }
          },
          "sort":[
            {
              "timestamp":{
                "order":"desc"
              }
            }
          ]
        }));
      });
    });

    suite('filterByCategory', function() {
      var e = {
        currentTarget: {
          dataset: {
            category: 'Search'
          }
        }
      };

      test('should set a category', function() {
        el.filterByCategory(e);

        assert.equal(el.category, e.currentTarget.dataset.category);
      });
    });

    suite('search', function() {
      setup(function() {
        sinon.spy(el, 'set');
        sinon.stub(el, 'getLogs', function() {});
      });

      teardown(function() {
        el.set.restore();
        el.getLogs.restore();
      });

      test('should clean logs and query again', function() {
        el.search();

        assert(el.set.calledWith('logResults', []));
        assert(el.getLogs.calledOnce);
      });
    });

    suite('openDropdown', function() {
      setup(function() {
        sinon.spy(el.$.dropdown, 'open');
      });

      teardown(function() {
        el.$.dropdown.open.restore();
      });

      test('should open the dropdown menu', function() {
        el.openDropdown();

        assert(el.$.dropdown.open.calledOnce);
      });
    });

    suite('setTimeRange', function() {
      var e = {
        currentTarget: {
          dataset: {
            value: ''
          }
        }
      };

      setup(function() {
        sinon.stub(el, 'getLogs', function() {});
      });

      teardown(function() {
        el.getLogs.restore();
      });

      test('should query for last hour logs', function() {
        e.currentTarget.dataset.value = 'hour';
        el.setTimeRange(e);

        assert.equal(el.fromDate, 'now-1h');
        assert(el.getLogs.calledOnce);
      });

      test('should query for last day logs', function() {
        e.currentTarget.dataset.value = 'day';
        el.setTimeRange(e);

        assert.equal(el.fromDate, 'now-1d');
        assert(el.getLogs.calledOnce);
      });

      test('should query for last week logs', function() {
        e.currentTarget.dataset.value = 'week';
        el.setTimeRange(e);

        assert.equal(el.fromDate, 'now-1w');
        assert(el.getLogs.calledOnce);
      });

      test('should query for all logs', function() {
        e.currentTarget.dataset.value = 'all';
        el.setTimeRange(e);

        assert.equal(el.fromDate, 0);
        assert(el.getLogs.calledOnce);
      });
    });

    suite('getIcon', function() {
      test('should return icon type', function() {
        assert.equal(el.getIcon('info'), 'info');
        assert.equal(el.getIcon('warn'), 'warning');
        assert.equal(el.getIcon('error'), 'error');
        assert.equal(el.getIcon(), '');
      });
    });

    suite('_handleLogs', function() {
      var e = {
        response: {
          hits: {
            hits: [{log: 1}, {log: 2}]
          }
        }
      };

      setup(function() {
        sinon.spy(el.$.list, 'fire');
      });

      teardown(function() {
        el.$.list.fire.restore();
      });

      test('should process empty response', function() {
        el._handleLogs();

        assert.equal(el.availableResults, false);
        assert(el.$.list.fire.calledOnce);
      });

      test('should process response', function() {
        el._handleLogs(e);

        assert.equal(el.availableResults, true);
        assert(el.$.list.fire.calledOnce);
      });
    });

    suite('getLogs', function() {
      setup(function() {
        sinon.spy(el, 'set');
        sinon.stub(el.$.auditTrail, 'setParamsAsObj', function() {});
        sinon.stub(el.$.auditTrail, 'generateRequest', function() {
          return {
            then: function() {}
          }
        });
      });

      teardown(function() {
        el.set.restore();
        el.$.auditTrail.setParamsAsObj.restore();
        el.$.auditTrail.generateRequest.restore();
      });

      test('should clean resutls and query for logs', function() {
        el.getLogs();

        assert(el.set.calledWith('logResults', []));
        assert(el.$.auditTrail.setParamsAsObj.calledOnce);
        assert(el.$.auditTrail.generateRequest.calledOnce);
      });
    });

    suite('replaceHistoryState', function() {
      setup(function() {
        sinon.spy(history, 'replaceState');
      });

      teardown(function() {
        history.replaceState.restore();
      });

      test('should call "history.replaceState"', function() {
        el.replaceHistoryState();

        assert(history.replaceState.calledOnce);
      });
    });

    suite('init', function() {
      var e = {
        data: {
          category: 'Configuration',
          q: 'query search'
        }
      };

      setup(function() {
        sinon.stub(el, 'getLogs', function() {});
        sinon.stub(el, 'categoryChanged', function() {});
      });

      teardown(function() {
        el.getLogs.restore();
        el.categoryChanged.restore();
      });

      test('should call for logs with URL params', function() {
        el.init(e);

        assert.equal(el.selectedTab, 4);
        assert.equal(el.category, e.data.category);
        assert.equal(el.q, e.data.q);
        assert(el.getLogs.calledOnce);
      });

      test('should call for logs with default params', function() {
        el.init({});

        assert.equal(el.category, '*');
        assert(el.getLogs.calledOnce);
      });
    });
  });
</script>
</body>
</html>
