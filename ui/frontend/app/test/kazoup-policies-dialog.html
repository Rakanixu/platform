<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-policies-dialog</title>

  <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>

  <!-- Import the element to test -->
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-policies-dialog/kazoup-policies-dialog.html">
</head>
<body>

<kazoup-policies-dialog id="fixture"></kazoup-policies-dialog>

<script>
  suite('<kazoup-policies-dialog>', function() {
    var el = document.querySelector('#fixture');

    el._filterConverter = {
      asHumanText: function() {},
      asElasticsearchFilters: function() {},
      asQuerystring: function() {}
    };

    el.$.filterEndpoint = {
      setParamsAsObj: function() {},
      generateRequest: function() {
        return {
          then: function() {}
        }
      }
    };

    suite('policyNameChanged', function() {
      suite('', function() {
        setup(function() {
          el.policyName = 'Policy name';
        });

        test('should set invalidPolicyName = false', function() {
          el.policyNameChanged();

          assert.equal(el.invalidPolicyName, false);
        });
      });

      suite('', function() {
        setup(function() {
          el.policyName = '';
        });

        test('should set invalidPolicyName = true', function() {
          el.policyNameChanged();

          assert.equal(el.invalidPolicyName, true);
        });
      });
    });

    suite('generateHumanText', function() {
      var policyText = ['policy1', 'policy2', 'policy3'];

      suite('with filters applied', function() {
        setup(function() {
          sinon.stub(el._filterConverter, 'asHumanText', function() {
            return policyText;
          });
        });

        teardown(function() {
          el._filterConverter.asHumanText.restore();
        });

        test('should update humanTextPolicy', function() {
          el.generateHumanText();

          assert.equal(
            el.humanTextPolicy,
            'Do you want to add an archive policy which match files ' +
            policyText[0] + ' and ' + policyText[1] + ' and ' + policyText[2] + '?'
          );
        });
      });

      suite('with no filters applied', function() {
        setup(function() {
          sinon.stub(el._filterConverter, 'asHumanText', function() {
            return [];
          });
        });

        teardown(function() {
          el._filterConverter.asHumanText.restore();
        });

        test('should update humanTextPolicy', function() {
          el.generateHumanText();

          assert.equal(
            el.humanTextPolicy,
            'No filters selected. Policy match all data. ' +
            'Do you want to create a policy which match all files?'
          );
        });
      });
    });

    suite('open', function() {
      setup(function() {
        sinon.stub(el, 'generateHumanText', function() {});
        sinon.spy(el.$.policyDialog, 'open');
      });

      teardown(function() {
        el.generateHumanText.restore();
        el.$.policyDialog.open.restore();
      });

      test('should open policy dialog', function() {
        el.open();

        assert(el.generateHumanText.calledOnce);
        assert(el.$.policyDialog.open.calledOnce);
      });
    });

    suite('addPolicy', function() {
      setup(function() {
        sinon.stub(el._filterConverter, 'asElasticsearchFilters', function() {});
        sinon.stub(el._filterConverter, 'asQuerystring', function() {});
        sinon.stub(el.$.filterEndpoint, 'setParamsAsObj', function() {});
        sinon.stub(el.$.filterEndpoint, 'generateRequest', function() {
          return {
            then: function() {}
          }
        });
        sinon.stub(el, 'policyNameChanged', function() {});
      });

      teardown(function() {
        el._filterConverter.asElasticsearchFilters.restore();
        el._filterConverter.asQuerystring.restore();
        el.$.filterEndpoint.setParamsAsObj.restore();
        el.$.filterEndpoint.generateRequest.restore();
        el.policyNameChanged.restore();
      });

      test('should submit policy', function() {
        el.policyName = 'Policy name';
        el.addPolicy();

        assert(el._filterConverter.asElasticsearchFilters.calledOnce);
        assert(el._filterConverter.asQuerystring.calledOnce);
        assert(el.$.filterEndpoint.setParamsAsObj.calledOnce);
        assert(el.$.filterEndpoint.generateRequest.calledOnce);
      });

      test('should not submit policy', function() {
        el.policyName = '';
        el.addPolicy();

        assert.equal(el.invalidPolicyName, true);
      });
    });

    suite('handleResponse', function() {
      var show;

      setup(function() {
        show = sinon.spy();
        sinon.stub(Polymer, 'dom', function() {
          return {
            querySelector: function() {
              return {
                text: '',
                show: show
              }
            }
          }
        });
      });

      teardown(function() {
        Polymer.dom.restore();
      });

      test('should show feedback to user', function() {
        el.handleResponse();

        assert(Polymer.dom.calledTwice);
        assert(show.calledOnce);
      });
    });
  });
</script>
</body>
</html>
