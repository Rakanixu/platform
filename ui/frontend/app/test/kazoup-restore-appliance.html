<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>kazoup-restore-appliance</title>

  <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>

  <!-- Import the element to test -->
  <link rel="import" href="../bower_components/polymer/polymer.html">
  <script src="../bower_components/page/page.js"></script>
  <script src="../bower_components/PinkySwear.js/pinkyswear.min.js"></script>
  <link rel="import" href="../behaviors/behaviors.html">
  <link rel="import" href="../elements/kazoup-restore-appliance/kazoup-restore-appliance.html">
</head>
<body>

  <kazoup-restore-appliance id="fixture"></kazoup-restore-appliance>

  <script>

    suite('<kazoup-restore-appliance>', function() {
      var el = document.querySelector('#fixture');

      suite('poolRestoreState', function() {
        var server;
        var response

        suite('', function() {
          setup(function() {
            server = sinon.fakeServer.create();
            response = {
              state: 'IN_PROGRESS',
              message: 'In progress message'
            };

            server.respondWith(
              'GET',
              '/api/restore/state/?format=json',
              [
                200,
                {
                  'Content-Type': 'application/json'
                },
                JSON.stringify(response)
              ]
            );
          });

          teardown(function() {
            server.restore();
          });

          test('should show progress state', function(done) {
            el.poolRestoreState();

            setTimeout(function() {
              assert.equal(el.progressMessage, response.message);

              done();
            }, 200);

            server.respond();
          });
        });

        suite('', function() {
          setup(function() {
            server = sinon.fakeServer.create();
            response = {
              state: 'SUCCESS',
              message: 'Success message'
            };

            server.respondWith(
              'GET',
              '/api/restore/state/?format=json',
              [
                200,
                {
                  'Content-Type': 'application/json'
                },
                JSON.stringify(response)
              ]
            );

            sinon.stub(window, 'page', function() {});
          });

          teardown(function() {
            server.restore();
            window.page.restore();
          });

          test('should redirect to login page', function (done) {
            el.poolRestoreState();

            setTimeout(function() {
              assert(window.page.calledWith('/'));

              done();
            }, 200);

            server.respond();
          });
        });
      });

      suite('setBackupsList', function() {
        var backupList = ['backup1', 'backup2'];
        var e = {
          response: backupList
        };

        test('should update the backup list', function() {
          el.setBackupsList(e);

          assert.equal(el.customStep, 2);
          assert.deepEqual(el.setupFieldsStep2[0].choices, backupList);
        });
      });
    });
  </script>
</body>
</html>
