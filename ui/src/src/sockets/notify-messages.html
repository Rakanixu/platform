<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/web-socket/web-socket.html">

<link rel="import" href="../../src/behaviors/endpoints-behavior.html">

<dom-module id="notify-messages">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <paper-toast id="toast" text=""></paper-toast>

    <web-socket id="socket"
                url="[[endpoints.socket]]/notification/platform/notify"
                on-open="_onOpen"
                on-close="_onClose"
                on-message="_onMessage"
                on-error="_onError"
                json></web-socket>
  </template>

  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'notify-messages',
        behaviors: [
          Polymer.EndpointsBehaviorImp
        ],
        init: function(userId) {
          this.$.socket.open();

          this.async(function() {
            this.$.socket.send({
              user_id: userId
            });
          }, 3000);
        },
        _onOpen: function(e) {
          console.log('_onOpen', e.detail);
        },
        _onClose: function(e) {
          clearTimeout(this.reconnectTimeout);

          this.reconnectTimeout = setTimeout(function() {
            this.init(Auth.getUserId());
          }.bind(this), 3000);
        },
        _onMessage: function(e) {
          // Check for user ID message is for, right now we are broadcasting from notification srv
          if (e.detail.user_id === Auth.getUserId()) {
            if (e.detail.info && e.detail.info.length) {
              this.$.toast.text = e.detail.info;
              this.$.toast.show();
            }

            if (e.detail.method) {
              var data = {};

              if (e.detail.data && e.detail.data.length) {
                data = Object(e.detail.data);
              }

              this.async(function() {
                if (document.querySelector('datasources-page')[e.detail.method]) {
                  document.querySelector('datasources-page')[e.detail.method](data);
                }

                if (document.querySelector('web-app')[e.detail.method]) {
                  document.querySelector('web-app')[e.detail.method](data);
                }
              }, 1200);
            }
          }
        },
        _onError: function(e) {
          console.log('_onError', e.detail);
        }
      });
    }());
  </script>
</dom-module>
