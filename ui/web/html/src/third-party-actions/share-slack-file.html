<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/mat-icon/mat-icon.html">
<link rel="import" href="../../bower_components/mat-icons/mat-icons.html">
<link rel="import" href="../../bower_components/mat-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/mat-icons/action-icons.html">
<link rel="import" href="../../bower_components/mat-icon-button/mat-icon-button.html">

<link rel="import" href="../../bower_components/mat-dialog/mat-dialog.html">

<link rel="import" href="../../src/behaviors/endpoints-behavior.html">
<link rel="import" href="../../src/behaviors/map-behavior.html">
<link rel="import" href="../../src/behaviors/util-behavior.html">

</head><body><dom-module id="share-slack-file">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      mat-dialog {
        width: 340px;
      }

      paper-icon-button {
        color: #fff;
      }

      #selectTargetDialog paper-button {
        padding: 0;
        width: 100%;
      }

      #selectTargetDialog paper-button mat-item {
        width: 100%;
      }
    </style>

    <paper-icon-button id="share" icon="social:share" on-tap="openShareFileDialog" color="white"></paper-icon-button>

    <mat-dialog id="shareFileDialog" label="">
      <div>
        <paper-button on-tap="shareFile" data-public="false">
          <iron-icon class="big" icon="kazoup:slack"></iron-icon>
          <mat-item label="Share file with Slack Team">
        </mat-item></paper-button>
        <paper-button on-tap="shareFile" data-public="true">
          <iron-icon class="big" icon="kazoup:web"></iron-icon>
          <mat-item label="Share file publicly">
        </mat-item></paper-button>
      </div>
      <mat-button class="action" label="Cancel" on-tap="closeShareFileDialog"></mat-button>
    </mat-dialog>

    <mat-dialog id="selectTargetDialog" label="" height="420">
      <div>
        <h3>Slack Team Channels</h3>
        <template is="dom-repeat" items="[[slackChannels]]">
          <paper-button on-tap="postFileToSlack" data-id$="[[item.id]]">
            <iron-icon class="big" icon="kazoup:slack"></iron-icon>
            <mat-item label$="#[[item.name]]">
          </mat-item></paper-button>
        </template>
      </div>
      <div>
        <h3>Slack Team Members</h3>
        <template is="dom-repeat" items="[[slackUsers]]">
          <paper-button on-tap="postFileToSlack" data-id$="[[item.id]]">
            <iron-icon class="big" src$="[[item.profile.image_32]]"></iron-icon>
            <mat-item label$="#[[item.name]]">
          </mat-item></paper-button>
        </template>
      </div>
      <mat-button class="action" label="Cancel" on-tap="closeSelectTargetDialog"></mat-button>
    </mat-dialog>

    <paper-toast id="toast" duration="6000" text=""></paper-toast>

    <iron-ajax id="rpcShareFile" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleShareFile" params="[[rpcShareFileParams]]" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSlackChannels" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleSlackChannels" params="[[rpcSlackChannelsParams]]" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSlackUsers" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleSlackUsers" params="[[rpcSlackUsersParams]]" headers="[[headers]]"></iron-ajax>

  </template>

  <script>"use strict";!function(){Polymer({is:"share-slack-file",behaviors:[Polymer.EndpointsBehaviorImp,Polymer.UtilBehaviorImp,Polymer.MapBehaviorImp],properties:{item:{type:Object,notify:!0,reflectToAttribute:!0},slackChannels:{type:Array,notify:!0},slackUsers:{type:Array,notify:!0},rpcShareFileParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.file",method:"File.Share",request:{datasource_id:"",index:"",file_id:"",original_id:"",destination_id:"",share_publicly:void 0}}}},rpcSlackChannelsParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.search",method:"Search.Search",request:{index:"",type:"channel",from:0,size:999}}}},rpcSlackUsersParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.search",method:"Search.Search",request:{index:"",type:"user",from:0,size:999}}}}},openShareFileDialog:function(e){this.$.shareFileDialog.show()},closeShareFileDialog:function(){this.$.shareFileDialog.hide()},openSelectTargetDialog:function(e){this.$.selectTargetDialog.show()},closeSelectTargetDialog:function(e){this.$.selectTargetDialog.hide()},shareFile:function(e){this.headers=Auth.getHeaders(),this.rpcShareFileParams.request.datasource_id=this.item.datasource_id,this.rpcShareFileParams.request.original_id=this.item.original.id,"true"===e.currentTarget.dataset.public?(this.rpcShareFileParams.request.share_publicly=!0,this.$.rpcShareFile.body=this.rpcShareFileParams,this.$.rpcShareFile.generateRequest()):(this.rpcShareFileParams.request.share_publicly=!1,this.rpcSlackChannelsParams.request.index=this.item.index,this.rpcSlackUsersParams.request.index=this.item.index,this.$.rpcSlackChannels.body=this.rpcSlackChannelsParams,this.$.rpcSlackUsers.body=this.rpcSlackUsersParams,this.$.rpcSlackChannels.generateRequest(),this.$.rpcSlackUsers.generateRequest(),this.closeShareFileDialog(),this.openSelectTargetDialog())},postFileToSlack:function(e){this.rpcShareFileParams.request.destination_id=e.currentTarget.dataset.id,this.rpcShareFileParams.request.index=this.item.index,this.rpcShareFileParams.request.file_id=this.item.id,this.$.rpcShareFile.body=this.rpcShareFileParams,this.$.rpcShareFile.generateRequest()},_handleSlackChannels:function(e){e.detail.response&&e.detail.response.result&&this.set("slackChannels",JSON.parse(e.detail.response.result))},_handleSlackUsers:function(e){e.detail.response&&e.detail.response.result&&this.set("slackUsers",JSON.parse(e.detail.response.result))},_handleShareFile:function(e){e.detail.response&&(e.detail.response.share_publicly?e.detail.response.public_url?(document.querySelector("web-app").set("item.original.permalink_public",e.detail.response.public_url),document.querySelector("web-app").set("item.original.public_url_shared",!0),this.$.toast.text="Public file link available.",this.$.toast.show()):(this.$.toast.text="Public file link already exists or you do not have permissions to share it publicly.",this.$.toast.show()):(this.$.toast.text="File link sent to slack channel or user",this.$.toast.show()),this.closeSelectTargetDialog())},_handleError:function(e){this.checkUnauthorize(e),e.detail.request&&e.detail.request.response&&(this.$.toast.text=e.detail.request.response.detail,this.$.toast.show())}})}();</script>
</dom-module>
</body></html>