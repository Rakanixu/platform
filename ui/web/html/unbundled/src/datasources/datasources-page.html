<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="../../bower_components/mat-icon/mat-icon.html">
<link rel="import" href="../../bower_components/mat-icons/mat-icons.html">
<link rel="import" href="../../bower_components/mat-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/mat-icons/action-icons.html">
<link rel="import" href="../../bower_components/mat-icon-button/mat-icon-button.html">
<link rel="import" href="../../bower_components/mat-menu/mat-menu.html">
<link rel="import" href="../../bower_components/mat-dialog/mat-dialog.html">

<link rel="import" href="../../src/time/time-ago.html">
<link rel="import" href="../../src/empty-state/empty-state.html">

<link rel="import" href="../../src/behaviors/util-behavior.html">
<link rel="import" href="../../src/behaviors/endpoints-behavior.html">
<link rel="import" href="../../src/behaviors/nav-behavior.html">
<link rel="import" href="../../src/behaviors/map-behavior.html">

</head><body><dom-module id="datasources-page">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      paper-spinner {
        height: 44px;
        width: 44px;
        position: absolute;
        top: 13px;
        left: -58px;
        --paper-spinner-layer-1-color: var(--accent);
        --paper-spinner-layer-2-color: var(--accent);
        --paper-spinner-layer-3-color: var(--accent);
        --paper-spinner-layer-4-color: var(--accent);
      }

      .big {
        --iron-icon-height: 36px;
        --iron-icon-width: 36px;
  	  }

      #addDatasourceDialog {
	      width:320px;
      }
    </style>

    <template is="dom-repeat" items="[[datasourcesResults]]" hidden$="[[emptyState.visible]]">
      <mat-item label="[[getDatasourcePrettyType(item.url)]]" description="[[getDatasourceUrl(item.url)]]">
        <paper-spinner id$="spinner[[item.id]]" compute$="[[isSpinnerActive(item)]]"></paper-spinner>
        <mat-avatar class="primary" icon$="[[getDatasourceIcon(item.url)]]">
	      </mat-avatar>

        <time-ago datasource="{{item}}"></time-ago>

        <mat-icon-button class="secondary" behavior="toggle" icon="mat:more-vert" disabled$="[[item.crawler_running]]" target="id[[item.id]]"></mat-icon-button>
        <mat-menu id="id[[item.id]]">
          <mat-option label="Start scan" on-tap="startScan" disabled$="[[item.crawler_running]]"></mat-option>
          <mat-option label="Delete" on-tap="deleteDatasource" disabled$="[[item.crawler_running]]"></mat-option>
        </mat-menu>
      </mat-item>
    </template>

    <empty-state id="emptyState" class="fit" hidden$="[[!emptyState.visible]]" icon="[[emptyState.icon]]" header="[[emptyState.header]]"></empty-state>

    <mat-dialog id="addDatasourceDialog" label="">
      <div>
        
        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/slack/login">
          <iron-icon class="big" icon="kazoup:slack"></iron-icon>
          <mat-item label="Slack">
        </mat-item></paper-button>

        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/google/login">
          <iron-icon class="big" icon="kazoup:googledrive"></iron-icon>
          <mat-item label="Google Drive">
        </mat-item></paper-button>

        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/gmail/login">
          <iron-icon class="big" icon="kazoup:gmail"></iron-icon>
          <mat-item label="Gmail">
        </mat-item></paper-button>

        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/microsoft/login">
          <iron-icon class="big" icon="kazoup:onedrive"></iron-icon>
          <mat-item label="One Drive">
        </mat-item></paper-button>

        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/dropbox/login">
          <iron-icon class="big" icon="kazoup:dropbox"></iron-icon>
          <mat-item label="Dropbox">
        </mat-item></paper-button>

        <paper-button on-tap="doAuth" data-url$="[[endpoints.web]]/auth/box/login">
          <iron-icon class="big" icon="kazoup:box"></iron-icon>
          <mat-item label="Box">
        </mat-item></paper-button>

      </div>
      <mat-button class="action" label="Cancel" on-tap="closeDatasourceDialog"></mat-button>
    </mat-dialog>

    <paper-toast id="toast" duration="6000" text=""></paper-toast>

    <iron-ajax id="rpcGetDatasources" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleGetDatasource" params="[[rpcGetDatasourceParams]]" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcAddDatasource" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleAddDatasource" params="{{rpcAddDatasourceParams}}" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcDeleteDatasource" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleDeleteDatasource" params="{{rpcDeleteDatasourceParams}}" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcStartScan" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleStartScan" params="[[rpcStartScanParams]]" headers="[[headers]]"></iron-ajax>

  </template>

  <script>"use strict";!function(){Polymer({is:"datasources-page",behaviors:[Polymer.UtilBehaviorImp,Polymer.NavBehaviorImp,Polymer.MapBehaviorImp,Polymer.AsyncBehaviorImp,Polymer.CommonBehaviorImp,Polymer.EndpointsBehaviorImp],properties:{rpcGetDatasourceParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.datasource",method:"DataSource.Search",request:{from:0,size:9999,type:"datasource",index:"datasources"}}}},rpcStartScanParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.datasource",method:"DataSource.Scan",request:{id:""}}}},rpcDeleteDatasourceParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.datasource",method:"DataSource.Delete",request:{id:""}}}},datasourcesResults:{type:Array,notify:!0,value:function(){return[]}},lastDatasourceCreated:{type:Object,notify:!1,value:function(){return{}}},emptyState:{type:Object,notify:!0,value:function(){return{visible:!1,icon:"icons:build",header:"No datasources."}}}},ready:function(){this.$.rpcGetDatasources.body=this.rpcGetDatasourceParams,window.addEventListener("datasources-page-activated",this.init.bind(this)),window&&window.process&&window.process.type&&(ipcRenderer.on("add-folder",this._addDatasource.bind(this)),ipcRenderer.on("auth-callback-message",this._authSuccessful.bind(this)))},init:function(e,t){this.headers=Auth.getHeaders(),this.set("loading",!0),this.async(function(){this.$.rpcGetDatasources.generateRequest()},300)},doAuth:function(e){window&&window.process&&window.process.type?"local://"==e.currentTarget.getAttribute("data-url")?ipcRenderer.send("open-folder"):ipcRenderer.send("auth-message",{url:e.currentTarget.getAttribute("data-url")+"?user="+Auth.getUserId(),token:localStorage.getItem("token"),id_token:localStorage.getItem("id_token"),show_onboarding:localStorage.getItem("show_onboarding")}):window.open(e.currentTarget.getAttribute("data-url")+"?user="+Auth.getUserId()),this.closeDatasourceDialog()},refreshDatasources:function(e){this.$.rpcGetDatasources.generateRequest()},startScan:function(e){this.set("loading",!0),this.rpcStartScanParams.request.id=e.model.__data__.item.id,this.$.rpcStartScan.body=this.rpcStartScanParams,this.$.rpcStartScan.generateRequest()},deleteDatasource:function(e){this.set("loading",!0),this.rpcDeleteDatasourceParams.request.id=e.model.__data__.item.id,this.$.rpcDeleteDatasource.body=this.rpcDeleteDatasourceParams,this.$.rpcDeleteDatasource.generateRequest()},_addDatasource:function(e,t){this.set("loading",!0),t.length>0&&this.set("lastDatasourceCreated",{endpoint:{url:"local://"+t[0]}}),this.$.rpcAddDatasource.body={service:"com.kazoup.srv.datasource",method:"DataSource.Create",request:this.lastDatasourceCreated},this.$.rpcAddDatasource.generateRequest()},_authSuccessful:function(e,t){for(var s in t)t.hasOwnProperty(s)&&localStorage.setItem(s,t[s])},_handleStartScan:function(e){this.set("loading",!1),this.$.toast.text="Scan started succesfully",this.$.toast.show(),this.async(function(){this.refreshDatasources()},1e3)},_handleDeleteDatasource:function(e){this.set("loading",!1),this.$.toast.text="Datasource deleted succesfully",this.$.toast.show(),this.async(this.init,1e3)},_handleGetDatasource:function(e){this.set("loading",!1),e.detail.response&&e.detail.response.result&&(this.set("datasourcesResults",JSON.parse(e.detail.response.result)),this.set("lastDatasourceCreated",{}),this.datasourcesResults&&this.datasourcesResults.length?this.set("emptyState.visible",!1):this.set("emptyState.visible",!0))},_handleAddDatasource:function(e){e.detail.response&&(this.closeDatasourceDialog(),this.$.toast.text="New datasource created succesfully",this.$.toast.show(),this.setMenuHeight.call(document.querySelector("settings-page")),this.async(this.init,1e3))},_handleError:function(e){this.set("loading",!1),this.checkUnauthorize(e),e.detail.request&&e.detail.request.response&&(this.$.toast.text=e.detail.request.response.detail,this.$.toast.show())}})}();</script>
</dom-module>
</body></html>