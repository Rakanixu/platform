<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../bower_components/mat-avatar/mat-avatar.html">
<link rel="import" href="../../bower_components/mat-item/mat-item.html">

<link rel="import" href="../../src/third-party-actions/share-slack-file.html">
<link rel="import" href="../../src/third-party-actions/share-google-drive-file.html">
<link rel="import" href="../../src/third-party-actions/share-one-drive-file.html">
<link rel="import" href="../../src/third-party-actions/share-dropbox-file.html">
<link rel="import" href="../../src/third-party-actions/share-box-file.html">
<link rel="import" href="../../src/third-party-actions/delete-file.html">

<link rel="import" href="../../src/behaviors/util-behavior.html">
<link rel="import" href="../../src/behaviors/endpoints-behavior.html">
<link rel="import" href="../../src/behaviors/map-behavior.html">

</head><body><dom-module id="detail-view">
  <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment"></style>
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      iron-image {
        background: transparent;
        width: 100%;
        height:400px;
        --iron-image-placeholder: {
          background: transparent;
        };
      }
    </style>

    <template is="dom-if" if="[[!item.is_dir]]" restamp="true">
      <template is="dom-if" if="[[isImage(item.category)]]" restamp="true">
        <iron-image src="[[endpoints.web]]/media/preview?user_id=[[md5UserId]]&amp;file_id=[[item.id]]&amp;width=600&amp;mode=fit&amp;quality=100&amp;token=[[getToken()]]" sizing="contain" preload="" fade=""></iron-image>
      </template>

      <template is="dom-if" if="[[isLocalMP4Video(item.category, item.name, item.file_type)]]" restamp="true">
        <video id="video" controls="" preload="auto" width="100%">
          <source src="[[getAsset(item.url)]]">
        </video>
      </template>

      <template is="dom-if" if="[[isLocalAudio(item.category, item.file_type)]]" restamp="true">
        <wave-player id="wavePlayer" wavecolor="#21a9f5" progresscolor="#b1b1b1" src="[[getAsset(item.url)]]">
      </wave-player></template>
    </template>

    <template is="dom-if" if="[[isSlack(item.file_type)]]" restamp="true">
      <mat-item label="Owner" href="slack://user?team=[[slackUser.team_id]]&amp;id=[[slackUser.id]]" tabindex="-1">
        <mat-avatar id="slackFileOwner" background="light" icon-src="[[slackUser.profile.image_48]]"></mat-avatar>
      </mat-item>
      <paper-tooltip for="slackFileOwner">[[slackUser.profile.real_name]]</paper-tooltip>

      <mat-item id="slackChannelInfo" label="#[[slackChannel.name]]" description="[[slackChannel.purpose.value]]" href="slack://channel?team=[[slackUser.team_id]]&amp;id=[[slackChannel.id]]" tabindex="-1">
      </mat-item>
    </template>

    <template is="dom-if" if="[[isGoogleDrive(item.file_type)]]" restamp="true">
      <mat-item label="People" class="overflow-visible" tabindex="-1">
        <template is="dom-repeat" items="[[googleDriveInfo.people]]">
          <mat-avatar id$="avatar_[[item.id]]" background="light" icon-src="[[profilePicture(item.photoLink)]]"></mat-avatar>
          <paper-tooltip for$="avatar_[[item.id]]">[[item.displayName]]</paper-tooltip>
        </template>
      </mat-item>

      <mat-item label="Created on" description="[[googleDriveInfo.createdDateTime]]" tabindex="-1">
      </mat-item>
    </template>

    <template is="dom-if" if="[[isOneDrive(item.file_type)]]" restamp="true">
      <mat-item label="Owner" description="[[oneDriveInfo.createdBy]]" tabindex="-1">
      </mat-item>

      <mat-item label="Created on" description="[[oneDriveInfo.createdDateTime]]" tabindex="-1">
      </mat-item>
    </template>

    <template is="dom-if" if="[[isDropboxFileShared(item.file_type, dropboxInfo.sharedFile)]]" restamp="true">
      <mat-item label="People" class="overflow-visible" tabindex="-1">
        <template is="dom-repeat" items="[[dropboxInfo.people]]">
          <mat-avatar id$="avatar_[[item.id]]" background="light" icon-src="[[item.profilePhoto]]"></mat-avatar>
          <paper-tooltip for$="avatar_[[item.id]]">[[item.displayName]]</paper-tooltip>
        </template>
      </mat-item>
    </template>

    
    <template is="dom-if" if="[[isGoogleDriveFileDeleted(item.file_type, googleDriveInfo.trashed)]]" restamp="true">
      <mat-item label="This file is trashed on Google Drive" class="overflow-visible" tabindex="-1">
      </mat-item>
    </template>

    <template is="dom-if" if="[[isDropboxFileDeleted(item.file_type, dropboxInfo.dropboxTag)]]" restamp="true">
      <mat-item label="This file is trashed on Dropbox" class="overflow-visible" tabindex="-1">
      </mat-item>
    </template>

    <template is="dom-if" if="[[item.is_dir]]" restamp="true">
      <mat-item label="Total number of files" description="[[aggsInfo.count]]" tabindex="-1">
      </mat-item>
    </template>

    <mat-item label="Location" description="[[item.url]]" on-xp-activate="openFileFromDetailView" tabindex="-1"></mat-item>

    
    <template is="dom-if" if$="[[hasSlackComments(item.original, item.original.id)]]" restamp="true">
      <mat-item label="Description" description="[[item.original.initial_comment.comment]]" tabindex="-1">

      </mat-item>
    </template>

    
    <template id="hasSlackPublicUrl" is="dom-if" if$="[[hasSlackPublicUrl(item.file_type, item.original, item.original.id)]]" restamp="true">
      <mat-item label="Public Available Location" description="[[item.original.permalink_public]]" on-xp-activate="openPublicFileFromDetailView" tabindex="-1"></mat-item>
    </template>

    <template id="hasBoxPublicUrl" is="dom-if" if$="[[hasBoxPublicUrl(item.file_type, boxInfo.shared_link)]]" restamp="true">
      <mat-item label="Public Available Location" description="[[boxInfo.shared_link]]" on-xp-activate="openPublicFileFromDetailView" tabindex="-1"></mat-item>
    </template>

    <mat-item label="Last modified" description="[[timestampToHumanTime(item.modified)]]" tabindex="-1"></mat-item>

    <template is="dom-if" if="[[isGoogleDrive(item.file_type)]]" restamp="true">
      <mat-item label="Last modified by" description="[[googleDriveInfo.lastModifiedBy]]" tabindex="-1">

      </mat-item>
    </template>

    <template is="dom-if" if="[[isOneDrive(item.file_type)]]" restamp="true">
      <mat-item label="Last modified by" description="[[oneDriveInfo.lastModifiedBy]]" tabindex="-1">

      </mat-item>
    </template>

    <template is="dom-if" if="[[showSize(item.file_size)]]" restamp="true">
      <mat-item label="Size" description="[[bytesToSize(item.file_size)]]" tabindex="-1"></mat-item>
    </template>

    <template is="dom-if" if="[[showSize(aggsInfo.totalSize)]]" restamp="true">
      <mat-item label="Size" description="[[bytesToSize(aggsInfo.totalSize)]]" tabindex="-1"></mat-item>
    </template>

    <paper-toast id="toast" text=""></paper-toast>

    <iron-ajax id="rpcSearchSlackUsers" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleSlackUsers" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcSearchSlackChannels" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleSlackChannels" headers="[[headers]]"></iron-ajax>

    <iron-ajax id="rpcAggregate" method="POST" content-type="application/json" url="[[endpoints.endpoint]]" handle-as="json" on-error="_handleError" on-response="_handleAggregate" headers="[[headers]]"></iron-ajax>

  </template>

  <script>"use strict";!function(){Polymer({is:"detail-view",behaviors:[Polymer.UtilBehaviorImp,Polymer.MapBehaviorImp,Polymer.EndpointsBehaviorImp],properties:{item:{type:Object,notify:!0,reflectToAttribute:!0,observer:"itemChanged"},md5UserId:{type:String,notify:!1},slackUser:{type:Object,notify:!0},slackChannel:{type:Object,notify:!0},aggsInfo:{type:Object,notify:!0},oneDriveInfo:{type:Object,notify:!0},googleDriveInfo:{type:Object,notify:!0},dropboxInfo:{type:Object,notify:!0},boxInfo:{type:Object,notify:!0},rpcSearchSlackUsersParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.db",method:"DB.SearchById",request:{index:"",type:"user",id:""}}}},rpcSearchSlackChannelsParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.db",method:"DB.SearchById",request:{index:"",type:"channel",id:""}}}},rpcAggregateParams:{type:Object,notify:!1,value:function(){return{service:"com.kazoup.srv.search",method:"Search.Aggregate",request:{filters:{index:"files",type:"file"},agg:[]}}}}},itemChanged:function(e,i){switch(this.headers=Auth.getHeaders(),this.md5UserId=Auth.getMD5UserId(),this.item.file_type){case"local":this.getMoreInfoForDirectory();break;case"slack":this.getMoreInfoFromSlack();break;case"onedrive":this.getMoreInfoFromOneDrive();break;case"googledrive":this.getMoreInfoFromGoogleDrive();break;case"dropbox":this.getMoreInfoFromDropbox();break;case"box":this.getMoreInfoFromBox()}this.async(function(){if(document.querySelector("detail-view iron-image")){var e=document.querySelector("detail-view iron-image").getBoundingClientRect().width/(16/9);document.querySelector("detail-view iron-image").style.height=e+"px"}},250)},getMoreInfoForDirectory:function(){var e;this.item.is_dir&&(e=_.cloneDeep(this.rpcAggregateParams),e.request.filters.url=this.item.url,e.request.agg.push({aggregation_type:"stats",field:"file_size"}),e.request.agg.push({aggregation_type:"terms",field:"category"}),this.$.rpcAggregate.body=e,this.$.rpcAggregate.generateRequest())},getMoreInfoFromGoogleDrive:function(){var e=this.item.original.permissions&&this.item.original.permissions.length?this.item.original.permissions:this.item.original.owners;this.set("googleDriveInfo",{people:e,createdDateTime:this.timestampToHumanTime(this.item.original.createdTime),lastModifiedBy:this.item.original.lastModifyingUser.displayName,lastModifiedDateTime:this.timestampToHumanTime(this.item.original.modifiedTime),trashed:!!this.item.original.trashed})},getMoreInfoFromOneDrive:function(){this.set("oneDriveInfo",{createdBy:this.item.original.createdBy.user.displayName,createdDateTime:this.timestampToHumanTime(this.item.original.createdDateTime),lastModifiedBy:this.item.original.lastModifiedBy.user.displayName,lastModifiedDateTime:this.timestampToHumanTime(this.item.original.lastModifiedDateTime)})},getMoreInfoFromDropbox:function(){var e=[],i=1;_.forEach(this.item.original.dropbox_users,function(t){e.push({id:i,displayName:t.name.display_name,profilePhoto:t.profile_photo_url?t.profile_photo_url:this.getGravatarUrl(t.email)}),i++},this),_.forEach(this.item.original.dropbox_invitee,function(t){e.push({id:i,displayName:t.invitee.email,profilePhoto:this.getGravatarUrl(t.invitee.email)}),i++},this),this.set("dropboxInfo",{people:e,sharedFile:!!e.length,dropboxTag:this.item.original.dropbox_tag})},getMoreInfoFromSlack:function(){var e=document.querySelector("#slackChannelInfo");this.rpcSearchSlackUsersParams.request.id=this.item.original.user,this.rpcSearchSlackChannelsParams.request.id=this.item.original.channels[0],this.rpcSearchSlackUsersParams.request.index=this.item.index,this.rpcSearchSlackChannelsParams.request.index=this.item.index,e&&(this.rpcSearchSlackChannelsParams.request.id?e.style.display="block":e.style.display="none"),this.$.rpcSearchSlackUsers.body=this.rpcSearchSlackUsersParams,this.$.rpcSearchSlackChannels.body=this.rpcSearchSlackChannelsParams,this.$.rpcSearchSlackUsers.generateRequest(),this.$.rpcSearchSlackChannels.generateRequest()},getMoreInfoFromBox:function(){this.set("boxInfo",{shared_link:this.item.original.shared_link.url})},openFileFromDetailView:function(e){this.openFile(this.item.url)},openPublicFileFromDetailView:function(e){switch(this.item.file_type){case"slack":this.openFile(this.item.original.permalink_public);break;case"box":this.openFile(this.item.original.shared_link.url)}},isDropboxFileShared:function(e,i){return this.isDropbox(e)&&i},isDropboxFileDeleted:function(e,i){return this.isDropbox(e)&&"deleted"==i},isGoogleDriveFileDeleted:function(e,i){return this.isGoogleDrive(e)&&i},_handleAggregate:function(e){var i={};e.detail.response&&e.detail.response.result&&(i=JSON.parse(e.detail.response.result),this.set("aggsInfo",{count:i[0].count,totalSize:i[0].sum}))},_handleSlackUsers:function(e){e.detail.response&&e.detail.response.result&&this.set("slackUser",JSON.parse(e.detail.response.result))},_handleSlackChannels:function(e){e.detail.response&&e.detail.response.result&&this.set("slackChannel",JSON.parse(e.detail.response.result))},_handleError:function(e){e.detail.request&&e.detail.request.response&&(this.$.toast.text=e.detail.request.response.detail,this.$.toast.show())}})}();</script>
</dom-module>
</body></html>